
<!--
* Author: Felipe Santiago
* Product Name: GOMAP
* Version: 4.0.1
-->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Visualizar | GOMAP </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Inspinia is the #1 best-selling admin dashboard template on WrapBootstrap. Perfect for building CRM, CMS, project management tools, and custom web apps with clean UI, responsive design, and powerful features.">
  <meta name="keywords" content="Inspinia, admin dashboard, WrapBootstrap, HTML template, Bootstrap admin, CRM template, CMS template, responsive admin, web app UI, admin theme, best admin template">
  <meta name="author" content="WebAppLayers">

  <!-- App favicon -->
  <link rel="shortcut icon" href="assets/images/favicon.ico">
  <!-- Theme Config Js -->
  <script src="assets/js/config.js"></script>

  <!-- Vendor css -->
  <link href="assets/css/vendors.min.css" rel="stylesheet" type="text/css">

  <!-- App css -->
  <link href="assets/css/app.min.css" rel="stylesheet" type="text/css">
  <link href="assets/css/sislog-theme.css" rel="stylesheet">

  <style>
    .vertical-timeline { position: relative; padding-left: 30px; }
    .vertical-timeline::before { content: ''; position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e9ecef; }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-marker { position: absolute; left: -22px; top: 5px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; }
    .timeline-marker.done { background: #198754; }
    .timeline-marker.ongoing { background: #ffc107; }
    .timeline-marker.future { background: #6c757d; }
    .timeline-content { background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 3px solid #dee2e6; }
  </style>
</head>

<body>
  <div class="wrapper">

    
    <!-- Sidenav Menu Start -->
    <div class="sidenav-menu">

        <!-- Brand Logo -->
        <a href="index.html" class="logo">
            <span class="logo logo-light">
                <span class="logo-lg"><img src="assets/images/logo-white.png" alt="logo"></span>
                <span class="logo-sm"><img src="assets/images/logo-sm.png" alt="small logo"></span>
            </span>

            <span class="logo logo-dark">
                <span class="logo-lg"><img src="assets/images/logo-black.png" alt="dark logo"></span>
                <span class="logo-sm"><img src="assets/images/logo-sm.png" alt="small logo"></span>
            </span>
        </a>

        <!-- Sidebar Hover Menu Toggle Button -->
        <button class="button-on-hover">
            <i class="ti ti-menu-4 fs-22 align-middle"></i>
        </button>

        <!-- Full Sidebar Menu Close Button -->
        <button class="button-close-offcanvas">
            <i class="ti ti-x align-middle"></i>
        </button>

        <div class="scrollbar" data-simplebar>

            <!-- User 
            <div class="sidenav-user">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <a href="pages-profile.html" class="link-reset">
                            <img src="assets/images/users/user-2.jpg" alt="user-image" class="rounded-circle mb-2 avatar-md">
                            <span class="sidenav-user-name fw-bold">Felipe Santiago</span>
                            <span class="fs-12 fw-semibold" data-lang="user-role">UX Designer Senior</span>
                        </a>
                    </div>
                    <div>
                        <a class="dropdown-toggle drop-arrow-none link-reset sidenav-user-set-icon" data-bs-toggle="dropdown" data-bs-offset="0,12" href="#!" aria-haspopup="false" aria-expanded="false">
                            <i class="ti ti-settings fs-24 align-middle ms-1"></i>
                        </a>

                        <div class="dropdown-menu">
                            <!-- Header --
                            <div class="dropdown-header noti-title">
                                <h6 class="text-overflow m-0">Welcome back!</h6>
                            </div>

                            <!-- My Profile --
                            <a href="pages-profile.html" class="dropdown-item">
                                <i class="ti ti-user-circle me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Profile</span>
                            </a>

                            <!-- Notifications --
                            <a href="javascript:void(0);" class="dropdown-item">
                                <i class="ti ti-bell-ringing me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Notifications</span>
                            </a>

                            <!-- Wallet --
                            <a href="javascript:void(0);" class="dropdown-item">
                                <i class="ti ti-credit-card me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Balance: <span class="fw-semibold">$985.25</span></span>
                            </a>

                            <!-- Settings --
                            <a href="javascript:void(0);" class="dropdown-item">
                                <i class="ti ti-settings-2 me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Account Settings</span>
                            </a>

                            <!-- Support --
                            <a href="javascript:void(0);" class="dropdown-item">
                                <i class="ti ti-headset me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Support Center</span>
                            </a>

                            <!-- Divider --
                            <div class="dropdown-divider"></div>

                            <!-- Lock --
                            <a href="auth-lock-screen.html" class="dropdown-item">
                                <i class="ti ti-lock me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Lock Screen</span>
                            </a>

                            <!-- Logout --
                            <a href="javascript:void(0);" class="dropdown-item text-danger fw-semibold">
                                <i class="ti ti-logout-2 me-2 fs-17 align-middle"></i>
                                <span class="align-middle">Log Out</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidenav Menu -->
            <ul class="side-nav">
                <li class="side-nav-title" data-lang="menu-title">Menu</li>

                <!---Portal de Projetos Menu -->
                <li class="side-nav-item">
                    <a href="home.html" class="side-nav-link">
                        <span class="menu-icon"><i class="ti ti-home"></i></span>
                        <span class="menu-text" data-lang="Portal de Projetos"> Portal de projetos </span>
                    </a>
                </li>

                <!---Gestão de Usuários Menu -->
                <li class="side-nav-item">
                    <a data-bs-toggle="collapse" href="#sidebarEcommerce" aria-expanded="false" aria-controls="sidebarEcommerce" class="side-nav-link">
                        <span class="menu-icon"><i class="ti ti-users"></i></span>
                        <span class="menu-text" data-lang="Gestão de usuários">Gestão de usuários</span>
                        <span class="menu-arrow"></span>
                    </a>
                    <div class="collapse" id="sidebarEcommerce">
                        <ul class="sub-menu">
                            <li class="side-nav-item">
                                <a href="index2.html" class="side-nav-link">
                                    <span class="menu-text" data-lang="Órgão">Órgão</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
                <!---Painéis Menu -->
                <li class="side-nav-item">
                    <a data-bs-toggle="collapse" href="#sidebarEcommerce" aria-expanded="false" aria-controls="sidebarEcommerce" class="side-nav-link">
                        <span class="menu-icon"><i class="ti ti-photo"></i></span>
                        <span class="menu-text" data-lang="Painéis">Painéis</span>
                        <span class="menu-arrow"></span>
                    </a>
                    <div class="collapse" id="sidebarEcommerce">
                        <ul class="sub-menu">
                            <li class="side-nav-item">
                                <a href="index3.html" class="side-nav-link">
                                    <span class="menu-text" data-lang="Órgão">Portfólio 2024</span>
                                </a>
                            </li>
                            <li class="side-nav-item">
                                <a href="index4.html" class="side-nav-link">
                                    <span class="menu-text" data-lang="Órgão">Portfólio 2025</span>
                                </a>
                            </li>
                            <li class="side-nav-item">
                                <a href="index5.html" class="side-nav-link">
                                    <span class="menu-text" data-lang="Órgão">Portfólio 2026</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </li>
            </ul>
        </div>
    </div>
    <!-- Sidenav Menu End -->

    <!-- Topbar Start -->
    <header class="app-topbar">
        <div class="container-fluid topbar-menu">
            <div class="d-flex align-items-center gap-2">
                <!-- Topbar Brand Logo -->
                <div class="logo-topbar">
                    <!-- Logo light -->
                    <a href="index.html" class="logo-light">
                        <span class="logo-lg">
                            <img src="assets/images/logo.png" alt="logo">
                        </span>
                        <span class="logo-sm">
                            <img src="assets/images/logo-sm.png" alt="small logo">
                        </span>
                    </a>

                    <!-- Logo Dark -->
                    <a href="index.html" class="logo-dark">
                        <span class="logo-lg">
                            <img src="assets/images/logo-black.png" alt="dark logo">
                        </span>
                        <span class="logo-sm">
                            <img src="assets/images/logo-sm.png" alt="small logo">
                        </span>
                    </a>
                </div>

                <!-- Sidebar Menu Toggle Button -->
                <button class="sidenav-toggle-button btn btn-primary btn-icon">
                    <i class="ti ti-menu-4 fs-22"></i>
                </button>

                <!-- Horizontal Menu Toggle Button -->
                <button class="topnav-toggle-button px-2" data-bs-toggle="collapse" data-bs-target="#topnav-menu-content">
                    <i class="ti ti-menu-4 fs-22"></i>
                </button>

            

                <!-- Mega Menu Dropdown -->
                <div class="topbar-item d-none d-md-flex">
                    <div class="dropdown">
                    
                        <div class="dropdown-menu dropdown-menu-xxl p-0">
                            <div class="h-100" style="max-height: 380px;" data-simplebar>
                                <div class="row g-0">
                                    <div class="col-12">
                                        <div class="p-3 text-center bg-light bg-opacity-50">
                                            <h4 class="mb-0 fs-lg fw-semibold">Welcome to <span class="text-primary">INSPINIA+</span> Admin Theme.</h4>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-0">
                                    <div class="col-md-4">
                                        <div class="p-3">
                                            <h5 class="mb-2 fw-semibold fs-sm dropdown-header">Dashboard & Analytics</h5>
                                            <ul class="list-unstyled megamenu-list">
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Sales Dashboard</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Marketing Dashboard</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Finance Overview</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">User Analytics</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Traffic Insights</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Performance Metrics</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Conversion Tracking</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="p-3">
                                            <h5 class="mb-2 fw-semibold fs-sm dropdown-header">Project Management</h5>
                                            <ul class="list-unstyled megamenu-list">
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Task Overview</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Kanban Board</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Gantt Chart</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Team Collaboration</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Project Milestones</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Workflow Automation</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Timesheets & Reports</a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="col-md-4">
                                        <div class="p-3">
                                            <h5 class="mb-2 fw-semibold fs-sm dropdown-header">User Management</h5>
                                            <ul class="list-unstyled megamenu-list">
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">User Profiles</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Access Control</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Role Permissions</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Activity Logs</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Security Settings</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">User Groups</a>
                                                </li>
                                                <li>
                                                    <a href="javascript:void(0);" class="dropdown-item">Authentication & Login</a>
                                                </li>
                                            </ul>
                                        </div> <!-- end dropdown-->
                                    </div> <!-- end col-->
                                </div> <!-- end row-->

                            </div> <!-- end .h-100-->
                        </div> <!-- .dropdown-menu-->
                    </div> <!-- .dropdown-->
                </div> <!-- end topbar-item -->
            </div> <!-- .d-flex-->
        
            <div class="d-flex align-items-center gap-2">
                <!-- Messages Dropdown -->
                <div class="topbar-item">
                    <div class="dropdown">
                        <button class="topbar-link dropdown-toggle drop-arrow-none" data-bs-toggle="dropdown" data-bs-offset="0,22" type="button" data-bs-auto-close="outside" aria-haspopup="false" aria-expanded="false">
                            <i data-lucide="mails" class="fs-xxl"></i>
                            <span class="badge text-bg-success badge-circle topbar-badge">2</span>
                        </button>

                        <div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg">
                            <div class="px-3 py-2 border-bottom">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="m-0 fs-md fw-semibold">EvA Chat</h6>
                                    </div>
                                    <div class="col text-end">
                                        <a href="#!" class="badge text-bg-light badge-label py-1">02 Mensagens</a>
                                    </div>
                                </div>
                            </div>

                            <div style="max-height: 300px;" data-simplebar>
                                <!-- item 1 -->
                                <div class="dropdown-item notification-item py-2 text-wrap active" id="message-1">
                                    <span class="d-flex gap-3">
                                        <span class="flex-shrink-0">
                                            <img src="assets/images/users/user-11.jpg" class="avatar-md rounded-circle" alt="User Avatar">
                                        </span>
                                        <span class="flex-grow-1 text-muted">
                                            <span class="fw-medium text-body"></span> Conversa sobre o  <span class="fw-medium text-body">Projeto Escola</span>
                                            <br>
                                            <span class="fs-xs">5 minutos atrás</span>
                                        </span>
                                    
                                    </span>
                                </div>

                                <!-- item 2 -->
                                <div class="dropdown-item notification-item py-2 text-wrap" id="message-2">
                                    <span class="d-flex gap-3">
                                        <span class="flex-shrink-0">
                                            <img src="assets/images/users/user-11.jpg" class="avatar-md rounded-circle" alt="User Avatar">
                                        </span>
                                        <span class="flex-grow-1 text-muted">
                                            <span class="fw-medium text-body"></span> Conversa sobre o  <span class="fw-medium text-body">Projeto Revitalização Meia Ponte</span>
                                            <br>
                                            <span class="fs-xs">12 minutos atrás</span>
                                        </span>
                                    
                                    </span>
                                </div>

                            
                            </div>

                            <!-- All-->
                            <a href="javascript:void(0);" class="dropdown-item text-center text-reset text-decoration-underline link-offset-2 fw-bold notify-item border-top border-light py-2">
                                Ver todas as conversas
                            </a>

                        </div> <!-- End dropdown-menu -->
                    </div> <!-- end dropdown-->
                </div> <!-- end topbar item-->

                <!-- Notification Dropdown -->
                <div class="topbar-item">
                    <div class="dropdown">
                        <button class="topbar-link dropdown-toggle drop-arrow-none" data-bs-toggle="dropdown" data-bs-offset="0,22" type="button" data-bs-auto-close="outside" aria-haspopup="false" aria-expanded="false">
                            <i data-lucide="bell" class="fs-xxl"></i>
                            <span class="badge badge-square text-bg-warning topbar-badge">2</span>
                        </button>

                        <div class="dropdown-menu p-0 dropdown-menu-end dropdown-menu-lg">
                            <div class="px-3 py-2 border-bottom">
                                <div class="row align-items-center">
                                    <div class="col">
                                        <h6 class="m-0 fs-md fw-semibold">Notificações</h6>
                                    </div>
                                    <div class="col text-end">
                                        <a href="#!" class="badge text-bg-light badge-label py-1">2 Alertas</a>
                                    </div>
                                </div>
                            </div>

                            <div style="max-height: 300px;" data-simplebar>
                                <!-- item 1 -->
                                <div class="dropdown-item notification-item py-2 text-wrap" id="notification-1">
                                    <span class="d-flex gap-2">
                                        <span class="avatar-md flex-shrink-0">
                                            <span class="avatar-title bg-danger-subtle text-danger rounded fs-22">
                                                <i data-lucide="server-crash" class="fs-xl fill-danger"></i>
                                            </span>
                                        </span>
                                        <span class="flex-grow-1 text-muted">
                                            <span class="fw-medium text-body">Alerta 01</span>
                                            <br>
                                            <span class="fs-xs">30 minutos atrás</span>
                                        </span>
                                    
                                    </span>
                                </div>

                                <!-- item 2 -->
                                <div class="dropdown-item notification-item py-2 text-wrap" id="notification-2">
                                    <span class="d-flex gap-2">
                                        <span class="avatar-md flex-shrink-0">
                                            <span class="avatar-title bg-warning-subtle text-warning rounded fs-22">
                                                <i data-lucide="alert-triangle" class="fs-xl fill-warning"></i>
                                            </span>
                                        </span>
                                        <span class="flex-grow-1 text-muted">
                                            <span class="fw-medium text-body">Alerta 02</span>
                                            <br>
                                            <span class="fs-xs">30 minutos atrás</span>
                                        </span>
                                    </span>
                                </div>

                            
                            </div> <!-- end dropdown-->

                            <!-- All-->
                            <a href="javascript:void(0);" class="dropdown-item text-center text-reset text-decoration-underline link-offset-2 fw-bold notify-item border-top border-light py-2">
                                Ver todas as notificações
                            </a>

                        </div>
                    </div>
                </div>
                    <!-- Light/Dark Mode Button --->
                <div class="topbar-item d-none d-sm-flex">
                <button class="topbar-link" id="light-dark-mode" type="button">
                <i data-lucide="moon" class="fs-xxl mode-light-moon"></i>
                <i data-lucide="sun" class="fs-xxl mode-light-sun"></i>
                </button>
                </div>
            
                <!-- Letter A Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-letter-a fs-xxl"></i>
                    </button>
                </div>

                <!-- Refresh Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-refresh fs-xxl"></i>
                    </button>
                </div>

                <!-- Plus Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-plus fs-xxl"></i>
                    </button>
                </div>

                <!-- Minus Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-minus fs-xxl"></i>
                    </button>
                </div>
            
                <!-- Cube Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-cube fs-xxl"></i>
                    </button>
                </div>

                <!-- Circle Half Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-circle-half-2 fs-xxl"></i>
                    </button>
                </div>

                <!-- Droplet Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-droplet fs-xxl"></i>
                    </button>
                </div>

                <!-- Brush Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-brush fs-xxl"></i>
                    </button>
                </div>

                <!-- Settings Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button
                        class="topbar-link"
                        type="button"
                        data-bs-toggle="offcanvas"
                        data-bs-target="#theme-settings-offcanvas"
                        >
                        <i data-lucide="settings" class="fs-xxl"></i>
                    </button>
                </div>

           
                <!-- Users Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-users fs-xxl"></i>
                    </button>
                </div>

                <!-- Help Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="">
                        <i class="ti ti-help-octagon fs-xxl"></i>
                    </button>
                </div>

                <!-- Logout Button -->
                <div class="topbar-item d-none d-sm-flex">
                    <button class="topbar-link" type="button" onclick="window.location.href='auth-sign-in.html'">
                        <i class="ti ti-logout-2 fs-xxl"></i>
                    </button>
                </div>

                <!-- User Dropdown -->
                <div class="topbar-item nav-user">
                    <div class="dropdown">
                        <a class="topbar-link dropdown-toggle drop-arrow-none px-2" data-bs-toggle="dropdown" data-bs-offset="0,16" href="#!" aria-haspopup="false" aria-expanded="false">
                            <img src="assets/images/users/user-2.jpg" width="32" class="rounded-circle me-lg-2 d-flex" alt="user-image">
                            <div class="d-lg-flex align-items-center gap-2 d-none">
                                <div class="d-flex flex-column gap-0 pe-3">
                                    <h5 class="my-0" >Felipe Santiago</h5>
                                    <span class="fw-semibold">UX Designer Senior</span>
                                </div>
                            </div>
                            <i class="ti ti-chevron-down align-middle"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end">
                            <!-- Header -->
                            <div class="dropdown-header noti-title">
                                <h6 class="text-overflow m-0">Meus perfis</h6>
                            </div>

                            <!-- My Profile -->
                            <a href="index.html" class="dropdown-item">
                                <!--<i class="ti ti-user-circle me-2 fs-17 align-middle"></i>-->
                                <span class="align-middle">Perfil 01</span>
                            </a>

                            <!-- Notifications -->
                            <a href="index.html" class="dropdown-item">
                                <!--<i class="ti ti-bell-ringing me-2 fs-17 align-middle"></i>-->
                                <span class="align-middle">Perfil 02</span>
                            </a>

                            <!-- Wallet -->
                            <a href="index.html" class="dropdown-item">
                                <!--<i class="ti ti-credit-card me-2 fs-17 align-middle"></i>-->
                                <span class="align-middle">Perfil 03<!--<span class="fw-semibold">$985.25</span>--></span>
                            </a>

                            <!-- Settings -->
                            <a href="index.html" class="dropdown-item">
                                <!--<i class="ti ti-settings-2 me-2 fs-17 align-middle"></i>-->
                                <span class="align-middle">Perfil 04</span>
                            </a>

                            <!-- Support -->
                            <a href="index.html" class="dropdown-item">
                                <!--<i class="ti ti-headset me-2 fs-17 align-middle"></i>-->
                                <span class="align-middle">Perfil 05</span>
                            </a>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Topbar End -->

    

    <div class="content-page">
      <div class="content">
        <div class="container-fluid p-0 min-vh-100">

          
          <div class="page-title-head d-flex align-items-center">
              <div class="flex-grow-1">
                  <h4 class="fs-sm text-uppercase fw-bold m-0">Visualizar projeto</h4>
              </div>

              <div class="text-end">
                  <ol class="breadcrumb m-0 py-0">
                      <li class="breadcrumb-item"><a href="javascript: void(0);">GOMAP</a></li>
                      
                      <li class="breadcrumb-item"><a href="javascript: void(0);">Portal de projetos</a></li>
                      
                      <li class="breadcrumb-item active">Visualizar projeto</li>
                  </ol>
              </div>
          </div>
          

          <div class="row g-0 min-vh-100 w-100">
            <div class="col-xxl-12">

              <div class="card card-h-100 rounded-0 rounded-start">
                <div class="card-header p-4">
                  <div class="d-flex align-items-center justify-content-between w-100">

                    <div class="d-flex align-items-center gap-3">
                      <div>
                        <h3 class="mb-1 fw-semibold">0006 – Integração de Sistemas de Pagamento</h3>
                        <div class="d-flex align-items-center gap-2">
                          <span class="badge badge-soft-primary fs-xxs">Execução</span>
                          <span class="text-muted">•</span>
                          <span class="badge badge-soft-success fs-xxs">Em andamento</span>
                          <span class="text-muted">•</span>
                          <div class="d-flex align-items-center gap-2">
                            <img src="assets/images/users/user-3.jpg" alt="Luciene Martins" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" />
                            <span class="fw-medium">Luciene Martins</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="d-flex align-items-center gap-2 ms-auto">
                      <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          Ações
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Editar projeto</a></li>
                          <li><a class="dropdown-item" href="#"><i class="ti ti-message-chatbot me-2"></i>EvA Chat</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item disabled" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-clipboard-check me-2"></i>Iniciar planejamento</a></li>
                          <li><a class="dropdown-item disabled" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-file-text me-2"></i>Gerar TAP</a></li>
                        </ul>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="card-body px-4">

                  <ul class="nav nav-tabs nav-bordered mb-3" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link active" data-bs-toggle="tab" href="#tab-overview" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Visão geral</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-schedule" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Cronograma</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-monitoring" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Monitoramento</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-governance" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Governança</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-funding" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Captação de recursos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-risks" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Riscos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-files" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Arquivos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-logbook" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Diário de bordo</span>
                      </a>
                    </li>
                  </ul>

                  <div class="tab-content">

                    <div class="tab-pane show active" id="tab-overview" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body text-center text-muted py-5">
                          <h5 class="mb-1">Visão geral</h5>
                          <p class="mb-0">Esta funcionalidade será criada posteriormente.</p>
                        </div>
                      </div>
                    </div>

                    <!-- TAB CRONOGRAMA -->
<div class="tab-pane" id="tab-schedule" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Cronograma</h5>
          <div class="text-muted fs-12">Planejamento de marcos e atividades do projeto. (Protótipo UI)</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="ti ti-plus me-1"></i>Adicionar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="schAddMilestone"><i class="ti ti-flag me-2"></i>Marco</a></li>
              <li><a class="dropdown-item" href="#" id="schAddActivity"><i class="ti ti-checklist me-2"></i>Atividade</a></li>
            </ul>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-light" id="schViewTimeline">
              <i class="ti ti-timeline me-1"></i>Linha do tempo
            </button>
            <button type="button" class="btn btn-light" id="schViewTable">
              <i class="ti ti-list-details me-1"></i>Lista
            </button>
          </div>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="schReplan"><i class="ti ti-calendar-time me-2"></i>Replanejar</a></li>
              <li><a class="dropdown-item" href="#" id="schExport"><i class="ti ti-download me-2"></i>Exportar</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="schReset"><i class="ti ti-refresh me-2"></i>Resetar cronograma (protótipo)</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Filtros (barra única, igual ao padrão que você queria) -->
      <div class="card mb-3 border">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-end gap-2">

            <div style="min-width: 280px; flex: 1 1 360px;">
              <label class="form-label">Buscar</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ti ti-search"></i></span>
                <input type="text" class="form-control" id="schSearch" placeholder="Buscar por nome, responsável..." />
              </div>
            </div>

            <div style="min-width: 190px; flex: 0 0 190px;">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="schFilterType">
                <option value="all" selected>Todos</option>
                <option value="MILESTONE">Marcos</option>
                <option value="ACTIVITY">Atividades</option>
              </select>
            </div>

            <div style="min-width: 190px; flex: 0 0 190px;">
              <label class="form-label">Status</label>
              <select class="form-select" id="schFilterStatus">
                <option value="all" selected>Todos</option>
                <option value="PLANNED">Planejado</option>
                <option value="ONGOING">Em andamento</option>
                <option value="DONE">Concluído</option>
                <option value="DELAYED">Atrasado</option>
              </select>
            </div>

            <div style="min-width: 220px; flex: 0 0 220px;">
              <label class="form-label">Responsável</label>
              <select class="form-select" id="schFilterOwner">
                <option value="all" selected>Todos</option>
                <option value="luciene">Luciene Martins</option>
                <option value="joao">João Santos</option>
                <option value="maria">Maria Silva</option>
                <option value="leonardo">Leonardo Queiroz</option>
                <option value="sistema">Sistema GoMAP</option>
              </select>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="schApply">
                <i class="ti ti-filter me-1"></i>Filtrar
              </button>
              <button type="button" class="btn btn-light" id="schClear">
                <i class="ti ti-rotate-2 me-1"></i>Limpar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Empty -->
      <div id="schEmpty" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-calendar-x fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhum item encontrado</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todo o cronograma.</div>
        </div>
      </div>

      <!-- Views -->
      <div id="schTimelineView">
        <div class="vertical-timeline" id="schTimeline"></div>
      </div>

      <div id="schTableView" class="d-none">
        <div class="table-responsive">
          <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th style="width:1%;">Tipo</th>
                <th>Nome</th>
                <th style="width:1%;">Marco</th>
                <th style="width:1%;">Responsável</th>
                <th style="width:1%;">Início</th>
                <th style="width:1%;">Fim</th>
                <th style="width:1%;">Status</th>
                <th style="width:1%;">Progresso</th>
                <th class="text-center" style="width:1%;">Ações</th>
              </tr>
            </thead>
            <tbody id="schTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Marco/Atividade -->
<div class="modal fade" id="schModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="schModalTitle">Adicionar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="schFormId" value="" />
        <input type="hidden" id="schFormType" value="MILESTONE" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="schFormName" placeholder="Ex.: Homologação PIX + Cartão" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="schFormStatus">
              <option value="PLANNED" selected>Planejado</option>
              <option value="ONGOING">Em andamento</option>
              <option value="DONE">Concluído</option>
              <option value="DELAYED">Atrasado</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Progresso (%)</label>
            <input type="number" class="form-control" id="schFormProgress" min="0" max="100" value="0" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Responsável</label>
            <select class="form-select" id="schFormOwner">
              <option value="luciene" selected>Luciene Martins</option>
              <option value="joao">João Santos</option>
              <option value="maria">Maria Silva</option>
              <option value="leonardo">Leonardo Queiroz</option>
              <option value="sistema">Sistema GoMAP</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Início</label>
            <input type="date" class="form-control" id="schFormStart" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Fim</label>
            <input type="date" class="form-control" id="schFormEnd" />
          </div>

          <!-- Só aparece quando for ATIVIDADE -->
          <div class="col-12 d-none" id="schFormMilestoneWrap">
            <label class="form-label">Marco</label>
            <select class="form-select" id="schFormMilestone"></select>
            <div class="text-muted fs-12 mt-1">Atividades precisam estar vinculadas a um marco.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Descrição (opcional)</label>
            <textarea class="form-control" id="schFormDesc" rows="3" placeholder="Observações do item..."></textarea>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="schFormSave">
          <i class="ti ti-device-floppy me-1"></i>Salvar
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  const KEY = "gomap_schedule_0006";

  const actors = {
    luciene: { key:"luciene", name:"Luciene Martins" },
    joao: { key:"joao", name:"João Santos" },
    maria: { key:"maria", name:"Maria Silva" },
    leonardo: { key:"leonardo", name:"Leonardo Queiroz" },
    sistema: { key:"sistema", name:"Sistema GoMAP" }
  };

  const statusMeta = {
    PLANNED: { label:"Planejado", badge:"badge-soft-secondary", marker:"future" },
    ONGOING: { label:"Em andamento", badge:"badge-soft-primary", marker:"ongoing" },
    DONE: { label:"Concluído", badge:"badge-soft-success", marker:"done" },
    DELAYED: { label:"Atrasado", badge:"badge-soft-danger", marker:"future" }
  };

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function read(){
    try {
      const raw = localStorage.getItem(KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch(e){ return []; }
  }

  function write(list){
    localStorage.setItem(KEY, JSON.stringify(list || []));
  }

  function seedIfEmpty(){
    const cur = read();
    if (cur.length) return cur;

    const seeded = [
      { id:"MS-001", type:"MILESTONE", name:"Definição do provedor e modelo de integração", owner:"luciene", status:"DONE", progress:100, start:"2025-11-01", end:"2025-11-20", desc:"Escolha do provedor com suporte a PIX, cartão, webhooks e conciliação." },
      { id:"MS-002", type:"MILESTONE", name:"Homologação PIX + Cartão", owner:"maria", status:"DONE", progress:100, start:"2025-12-01", end:"2025-12-18", desc:"Casos aprovados/recusados, cancelamento, estorno e conciliação por arquivo." },
      { id:"MS-003", type:"MILESTONE", name:"Estabilização de Webhooks (idempotência)", owner:"joao", status:"ONGOING", progress:70, start:"2025-12-20", end:"2026-02-05", desc:"Padronização de eventos e tratamento de duplicidade." },
      { id:"MS-004", type:"MILESTONE", name:"Go-live controlado", owner:"luciene", status:"PLANNED", progress:0, start:"2026-02-06", end:"2026-02-20", desc:"Virada com monitoramento e rollback plan." },

      { id:"AC-101", type:"ACTIVITY", milestoneId:"MS-003", name:"Mapa de eventos + contrato de payload", owner:"joao", status:"DONE", progress:100, start:"2025-12-20", end:"2026-01-05", desc:"Eventos: payment.created/confirmed/failed/refund/chargeback." },
      { id:"AC-102", type:"ACTIVITY", milestoneId:"MS-003", name:"Implementar idempotência por chave de transação", owner:"joao", status:"ONGOING", progress:70, start:"2026-01-06", end:"2026-01-30", desc:"Tabela de chaves processadas + retentativa com backoff." },
      { id:"AC-103", type:"ACTIVITY", milestoneId:"MS-003", name:"Monitoramento e alertas (SLA provedor)", owner:"leonardo", status:"PLANNED", progress:0, start:"2026-01-25", end:"2026-02-05", desc:"Circuit breaker, métricas e alarmes." },
      { id:"AC-201", type:"ACTIVITY", milestoneId:"MS-004", name:"Checklist de produção + evidências", owner:"luciene", status:"PLANNED", progress:0, start:"2026-02-06", end:"2026-02-12", desc:"Checklist go-live e evidências de homologação." }
    ];

    write(seeded);
    return seeded;
  }

  // (opcional) log no diário, se existir
  function logbook(type, title, desc){
    try{
      if (typeof window.addLogbookEntry !== "function") return;
      window.addLogbookEntry({
        id: `LG-${String(Math.floor(Math.random()*900)+100)}`,
        createdAt: new Date().toISOString(),
        type: "NOTE",
        title,
        description: desc,
        actorKey: "luciene",
        source: "manual",
        tags: ["Cronograma", type],
        attachments: []
      });
    }catch(e){}
  }

  const el = {
    search: document.getElementById("schSearch"),
    fType: document.getElementById("schFilterType"),
    fStatus: document.getElementById("schFilterStatus"),
    fOwner: document.getElementById("schFilterOwner"),
    apply: document.getElementById("schApply"),
    clear: document.getElementById("schClear"),
    empty: document.getElementById("schEmpty"),

    viewTimeline: document.getElementById("schViewTimeline"),
    viewTable: document.getElementById("schViewTable"),
    timelineView: document.getElementById("schTimelineView"),
    tableView: document.getElementById("schTableView"),

    timeline: document.getElementById("schTimeline"),
    tbody: document.getElementById("schTbody"),

    addMilestone: document.getElementById("schAddMilestone"),
    addActivity: document.getElementById("schAddActivity"),

    replan: document.getElementById("schReplan"),
    exportBtn: document.getElementById("schExport"),
    reset: document.getElementById("schReset"),

    // modal
    modal: document.getElementById("schModal"),
    modalTitle: document.getElementById("schModalTitle"),
    formId: document.getElementById("schFormId"),
    formType: document.getElementById("schFormType"),
    formName: document.getElementById("schFormName"),
    formStatus: document.getElementById("schFormStatus"),
    formProgress: document.getElementById("schFormProgress"),
    formOwner: document.getElementById("schFormOwner"),
    formStart: document.getElementById("schFormStart"),
    formEnd: document.getElementById("schFormEnd"),
    formDesc: document.getElementById("schFormDesc"),
    formMilestoneWrap: document.getElementById("schFormMilestoneWrap"),
    formMilestone: document.getElementById("schFormMilestone"),
    formSave: document.getElementById("schFormSave"),
  };

  let items = seedIfEmpty();

  function getMilestones(){
    return items.filter(x => x.type === "MILESTONE").sort((a,b)=> (a.start||"").localeCompare(b.start||""));
  }

  function fillMilestoneSelect(selectedId){
    const list = getMilestones();
    el.formMilestone.innerHTML = "";
    list.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      el.formMilestone.appendChild(opt);
    });
    if (selectedId) el.formMilestone.value = selectedId;
    if (!selectedId && list[0]) el.formMilestone.value = list[0].id;
  }

  function getFiltered(){
    const q = (el.search.value||"").trim().toLowerCase();
    const type = el.fType.value || "all";
    const status = el.fStatus.value || "all";
    const owner = el.fOwner.value || "all";

    return items
      .slice()
      .sort((a,b)=> (a.start||"").localeCompare(b.start||""))
      .filter(x=>{
        const blob = [
          x.id, x.type, x.name, x.desc, actors[x.owner]?.name || "",
          x.status, x.progress, x.start, x.end,
          (x.milestoneId ? (items.find(m=>m.id===x.milestoneId)?.name || "") : "")
        ].join(" ").toLowerCase();

        const okQ = !q || blob.includes(q);
        const okT = type === "all" || x.type === type;
        const okS = status === "all" || x.status === status;
        const okO = owner === "all" || x.owner === owner;
        return okQ && okT && okS && okO;
      });
  }

  function badgeStatus(st){
    const m = statusMeta[st] || { label: st, badge:"badge-soft-secondary" };
    return `<span class="badge ${esc(m.badge)} fs-xxs">${esc(m.label)}</span>`;
  }

  function fmt(d){
    if (!d) return "—";
    const [y,m,dd] = String(d).split("-");
    if (!y||!m||!dd) return d;
    return `${dd}/${m}/${y}`;
  }

  function render(){
    const list = getFiltered();
    el.empty.classList.toggle("d-none", list.length > 0);

    // Timeline (agrupa por marco)
    const miles = getMilestones();
    const byMilestone = new Map();
    miles.forEach(m => byMilestone.set(m.id, []));
    list.filter(x=>x.type==="ACTIVITY").forEach(a=>{
      if (!byMilestone.has(a.milestoneId)) byMilestone.set(a.milestoneId, []);
      byMilestone.get(a.milestoneId).push(a);
    });

    // linha do tempo: mostra milestones sempre; activities somente se passam no filtro
    el.timeline.innerHTML = "";
    miles.forEach(m=>{
      if (el.fType.value === "ACTIVITY") {
        // se filtro for só atividade, não renderiza marco sem atividades visíveis
        const acts = (byMilestone.get(m.id) || []).filter(a => list.some(v=>v.id===a.id));
        if (!acts.length) return;
      }

      const meta = statusMeta[m.status] || { marker:"future" };
      const markerClass = meta.marker;

      const wrap = document.createElement("div");
      wrap.className = "timeline-item";
      wrap.innerHTML = `
        <span class="timeline-marker ${esc(markerClass)}"></span>
        <div class="timeline-content">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="text-truncate" style="max-width: 70%;" title="${esc(m.name)}">
              <div class="fw-semibold">${esc(m.name)}</div>
              <div class="text-muted fs-12 text-nowrap">
                ${badgeStatus(m.status)}
                <span class="text-muted">•</span>
                <span>${esc(actors[m.owner]?.name || "—")}</span>
                <span class="text-muted">•</span>
                <span>${esc(fmt(m.start))} → ${esc(fmt(m.end))}</span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="text-muted fs-12 text-nowrap">${esc(m.progress||0)}%</div>
              <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(m.id)}" title="Editar">
                <i class="ti ti-edit"></i>
              </button>
              <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(m.id)}" title="Excluir">
                <i class="ti ti-trash"></i>
              </button>
            </div>
          </div>

          <div class="mt-2">
            <div class="progress bg-primary bg-opacity-25 progress-sm mb-0">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${Math.max(0, Math.min(100, Number(m.progress||0)))}%"></div>
            </div>
          </div>

          <div class="text-muted mt-2">${esc(m.desc || "")}</div>

          <div class="mt-3">
            ${(byMilestone.get(m.id) || []).filter(a => list.some(v=>v.id===a.id)).map(a=>{
              const am = statusMeta[a.status] || { badge:"badge-soft-secondary" };
              return `
                <div class="d-flex align-items-center justify-content-between gap-2 py-2 border-top">
                  <div class="text-truncate" style="max-width: 70%;" title="${esc(a.name)}">
                    <div class="fw-medium">${esc(a.name)}</div>
                    <div class="text-muted fs-12 text-nowrap">
                      <span class="badge ${esc(am.badge)} fs-xxs">${esc(am.label)}</span>
                      <span class="text-muted">•</span>
                      <span>${esc(actors[a.owner]?.name || "—")}</span>
                      <span class="text-muted">•</span>
                      <span>${esc(fmt(a.start))} → ${esc(fmt(a.end))}</span>
                    </div>
                  </div>

                  <div class="d-flex align-items-center gap-2">
                    <div class="text-muted fs-12 text-nowrap">${esc(a.progress||0)}%</div>
                    <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(a.id)}" title="Editar">
                      <i class="ti ti-edit"></i>
                    </button>
                    <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(a.id)}" title="Excluir">
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;
      el.timeline.appendChild(wrap);
    });

    // Tabela (somente itens filtrados)
    el.tbody.innerHTML = "";
    list.forEach(x=>{
      const isMilestone = x.type === "MILESTONE";
      const typeLabel = isMilestone ? `<span class="badge badge-soft-success fs-xxs">Marco</span>` : `<span class="badge badge-soft-primary fs-xxs">Atividade</span>`;
      const milestoneName = !isMilestone ? (items.find(m=>m.id===x.milestoneId)?.name || "—") : "—";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${typeLabel}</td>

        <td>
          <div class="fw-medium text-truncate" style="max-width: 520px;" title="${esc(x.name)}">${esc(x.name)}</div>
          ${x.desc ? `<div class="text-muted fs-12 text-truncate" style="max-width: 520px;" title="${esc(x.desc)}">${esc(x.desc)}</div>` : ``}
        </td>

        <td class="text-muted text-truncate" style="max-width: 260px;" title="${esc(milestoneName)}">${esc(milestoneName)}</td>
        <td class="text-muted">${esc(actors[x.owner]?.name || "—")}</td>
        <td class="text-muted">${esc(fmt(x.start))}</td>
        <td class="text-muted">${esc(fmt(x.end))}</td>
        <td>${badgeStatus(x.status)}</td>

        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="text-muted fs-12">${esc(x.progress||0)}%</div>
            <div class="progress bg-primary bg-opacity-25 progress-sm flex-grow-1 mb-0" style="min-width:120px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${Math.max(0, Math.min(100, Number(x.progress||0)))}%"></div>
            </div>
          </div>
        </td>

        <td class="text-center">
          <div class="d-flex justify-content-center gap-1">
            <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(x.id)}" title="Editar">
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(x.id)}" title="Excluir">
              <i class="ti ti-trash"></i>
            </button>
          </div>
        </td>
      `;
      el.tbody.appendChild(tr);
    });
  }

  function setView(view){
    const isTimeline = view === "timeline";
    el.timelineView.classList.toggle("d-none", !isTimeline);
    el.tableView.classList.toggle("d-none", isTimeline);

    el.viewTimeline.classList.toggle("btn-primary", isTimeline);
    el.viewTimeline.classList.toggle("btn-light", !isTimeline);

    el.viewTable.classList.toggle("btn-primary", !isTimeline);
    el.viewTable.classList.toggle("btn-light", isTimeline);
  }

  function openModal(type, id){
    el.formType.value = type;
    el.formId.value = id || "";

    const isActivity = type === "ACTIVITY";
    el.formMilestoneWrap.classList.toggle("d-none", !isActivity);

    fillMilestoneSelect();

    if (!id){
      el.modalTitle.textContent = (type === "MILESTONE") ? "Adicionar marco" : "Adicionar atividade";
      el.formName.value = "";
      el.formStatus.value = "PLANNED";
      el.formProgress.value = 0;
      el.formOwner.value = "luciene";
      el.formDesc.value = "";

      // defaults de data
      const d = new Date();
      const plus = (n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
      el.formStart.value = plus(3);
      el.formEnd.value = plus(15);

      if (isActivity){
        const firstMs = getMilestones()[0];
        fillMilestoneSelect(firstMs?.id);
      }
    } else {
      const item = items.find(x=>x.id===id);
      if (!item) return;

      el.modalTitle.textContent = (item.type === "MILESTONE") ? `Editar marco — ${item.id}` : `Editar atividade — ${item.id}`;
      el.formName.value = item.name || "";
      el.formStatus.value = item.status || "PLANNED";
      el.formProgress.value = Number(item.progress||0);
      el.formOwner.value = item.owner || "luciene";
      el.formStart.value = item.start || "";
      el.formEnd.value = item.end || "";
      el.formDesc.value = item.desc || "";

      if (item.type === "ACTIVITY"){
        fillMilestoneSelect(item.milestoneId);
      }
    }

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.show();
    }catch(e){}
  }

  function saveModal(){
    const id = (el.formId.value||"").trim();
    const type = el.formType.value;
    const name = (el.formName.value||"").trim();
    const status = el.formStatus.value;
    const progress = Math.max(0, Math.min(100, Number(el.formProgress.value||0)));
    const owner = el.formOwner.value;
    const start = el.formStart.value;
    const end = el.formEnd.value;
    const desc = (el.formDesc.value||"").trim();

    if (!name){
      alert("Preencha o nome.");
      return;
    }

    if (type === "ACTIVITY"){
      const milestoneId = el.formMilestone.value;
      if (!milestoneId){
        alert("Selecione um marco para a atividade.");
        return;
      }

      if (!id){
        const newItem = {
          id: `AC-${String(Math.floor(Math.random()*900)+100)}`,
          type, milestoneId, name, owner, status, progress, start, end, desc
        };
        items.unshift(newItem);
        write(items);
        logbook("Atividade", "Atividade adicionada", `Atividade adicionada no cronograma: ${newItem.name}`);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        items[idx] = { ...items[idx], milestoneId, name, owner, status, progress, start, end, desc };
        write(items);
        logbook("Atividade", "Atividade atualizada", `Atividade atualizada no cronograma: ${name}`);
      }
    } else {
      if (!id){
        const newItem = {
          id: `MS-${String(Math.floor(Math.random()*900)+100)}`,
          type, name, owner, status, progress, start, end, desc
        };
        items.unshift(newItem);
        write(items);
        logbook("Marco", "Marco adicionado", `Marco adicionado no cronograma: ${newItem.name}`);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        items[idx] = { ...items[idx], name, owner, status, progress, start, end, desc };
        write(items);
        logbook("Marco", "Marco atualizado", `Marco atualizado no cronograma: ${name}`);
      }
    }

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.hide();
    }catch(e){}

    render();
  }

  function deleteItem(id){
    const item = items.find(x=>x.id===id);
    if (!item) return;

    const ok = confirm("Excluir este item do cronograma? (Protótipo UI)");
    if (!ok) return;

    if (item.type === "MILESTONE"){
      // remove também atividades vinculadas
      items = items.filter(x => x.id !== id && x.milestoneId !== id);
      write(items);
      logbook("Marco", "Marco removido", `Marco removido do cronograma: ${item.name} (e atividades vinculadas).`);
    } else {
      items = items.filter(x => x.id !== id);
      write(items);
      logbook("Atividade", "Atividade removida", `Atividade removida do cronograma: ${item.name}.`);
    }

    render();
  }

  function wire(){
    // view toggle
    el.viewTimeline.addEventListener("click", ()=> setView("timeline"));
    el.viewTable.addEventListener("click", ()=> setView("table"));

    // filtros
    el.apply.addEventListener("click", render);
    el.clear.addEventListener("click", ()=>{
      el.search.value = "";
      el.fType.value = "all";
      el.fStatus.value = "all";
      el.fOwner.value = "all";
      render();
    });
    el.search.addEventListener("input", ()=>{
      clearTimeout(el.search._t);
      el.search._t = setTimeout(render, 120);
    });

    // adicionar
    el.addMilestone.addEventListener("click", (e)=>{ e.preventDefault(); openModal("MILESTONE"); });
    el.addActivity.addEventListener("click", (e)=>{ e.preventDefault(); openModal("ACTIVITY"); });

    // salvar modal
    el.formSave.addEventListener("click", saveModal);

    // ações
    el.replan.addEventListener("click", (e)=>{ e.preventDefault(); alert("Replanejar (protótipo UI)."); });
    el.exportBtn.addEventListener("click", (e)=>{ e.preventDefault(); alert("Exportar cronograma (protótipo UI)."); });
    el.reset.addEventListener("click", (e)=>{
      e.preventDefault();
      const ok = confirm("Resetar cronograma (protótipo). Isso limpa o localStorage e repopula dados iniciais.");
      if (!ok) return;
      write([]);
      items = seedIfEmpty();
      render();
    });

    // edit/delete delegação
    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action][data-id]");
      if (!btn) return;
      const act = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      ev.preventDefault();
      if (act === "edit"){
        const it = items.find(x=>x.id===id);
        if (!it) return;
        openModal(it.type, it.id);
      }
      if (act === "delete"){
        deleteItem(id);
      }
    });
  }

  function init(){
    setView("timeline");
    wire();
    render();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>


                    <div class="tab-pane" id="tab-monitoring" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body text-center text-muted py-5">
                          <h5 class="mb-1">Monitoramento</h5>
                          <p class="mb-0">Esta funcionalidade será criada posteriormente.</p>
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane" id="tab-governance" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body text-center text-muted py-5">
                          <h5 class="mb-1">Governança</h5>
                          <p class="mb-0">Esta funcionalidade será criada posteriormente.</p>
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane" id="tab-funding" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body text-center text-muted py-5">
                          <h5 class="mb-1">Captação de recursos</h5>
                          <p class="mb-0">Esta funcionalidade será criada posteriormente.</p>
                        </div>
                      </div>
                    </div>

                    <!-- TAB RISCOS -->
<div class="tab-pane" id="tab-risks" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Riscos</h5>
          <div class="text-muted fs-12">Registro e acompanhamento de riscos do projeto (severidade, mitigação e prazos).</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="d-flex align-items-center gap-2 me-1">
            <span class="badge badge-soft-danger fs-xxs" id="riskCountOpen">Abertos: 0</span>
            <span class="badge badge-soft-warning fs-xxs" id="riskCountMitigating">Mitigando: 0</span>
            <span class="badge badge-soft-success fs-xxs" id="riskCountClosed">Encerrados: 0</span>
          </div>

          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#risksModal">
            <i class="ti ti-plus me-1"></i>Novo risco
          </button>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="#" id="risksExport">
                  <i class="ti ti-download me-2"></i>Exportar
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="risksClearAll">
                  <i class="ti ti-broom me-2"></i>Limpar riscos salvos (protótipo)
                </a>
              </li>
            </ul>
          </div>

        </div>
      </div>

      <!-- Filtros (flex toolbar: botões SEMPRE na mesma linha dos campos, com wrap controlado) -->
<div class="card mb-3 border">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-end gap-2">

      <div style="min-width: 280px; flex: 1 1 320px;">
        <label class="form-label">Buscar</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ti ti-search"></i></span>
          <input type="text" class="form-control" id="risksSearch"
            placeholder="Buscar por ID, título, descrição..." />
        </div>
      </div>

      <div style="min-width: 170px; flex: 0 0 170px;">
        <label class="form-label">Status</label>
        <select class="form-select" id="risksFilterStatus">
          <option value="all" selected>Todos</option>
          <option value="OPEN">Aberto</option>
          <option value="MITIGATING">Mitigando</option>
          <option value="CLOSED">Encerrado</option>
        </select>
      </div>

      <div style="min-width: 170px; flex: 0 0 170px;">
        <label class="form-label">Severidade</label>
        <select class="form-select" id="risksFilterSeverity">
          <option value="all" selected>Todas</option>
          <option value="LOW">Baixa</option>
          <option value="MEDIUM">Média</option>
          <option value="HIGH">Alta</option>
          <option value="CRITICAL">Crítica</option>
        </select>
      </div>

      <div style="min-width: 200px; flex: 0 0 200px;">
        <label class="form-label">Categoria</label>
        <select class="form-select" id="risksFilterCategory">
          <option value="all" selected>Todas</option>
          <option value="TECH">Técnico</option>
          <option value="SECURITY">Segurança</option>
          <option value="OPS">Operacional</option>
          <option value="COMPLIANCE">Legal/Compliance</option>
          <option value="VENDOR">Fornecedor</option>
        </select>
      </div>

      <div style="min-width: 220px; flex: 0 0 220px;">
        <label class="form-label">Responsável</label>
        <select class="form-select" id="risksFilterOwner">
          <option value="all" selected>Todos</option>
          <option value="luciene">Luciene Martins</option>
          <option value="joao">João Santos</option>
          <option value="maria">Maria Silva</option>
          <option value="leonardo">Leonardo Queiroz</option>
          <option value="sistema">Sistema GoMAP</option>
        </select>
      </div>

      <!-- Botões: ficam na MESMA linha; vão para a direita com ms-auto -->
      <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" id="risksApply">
          <i class="ti ti-filter me-1"></i>Filtrar
        </button>
        <button type="button" class="btn btn-light" id="risksClear">
          <i class="ti ti-rotate-2 me-1"></i>Limpar
        </button>
      </div>

    </div>
  </div>
</div>


      <!-- Empty -->
      <div id="risksEmptyState" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-shield-x fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhum risco encontrado</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todos os riscos.</div>
        </div>
      </div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
          <thead class="bg-light align-middle bg-opacity-25 thead-sm">
            <tr class="text-uppercase fs-xxs">
              <th style="width:1%;">ID</th>
              <th>Risco</th>
              <th style="width:1%;">Severidade</th>
              <th style="width:1%;">Status</th>
              <th style="width:1%;">Responsável</th>
              <th style="width:1%;">Prazo</th>
              <th style="width:1%;">Atualização</th>
              <th class="text-center" style="width:1%;">Ações</th>
            </tr>
          </thead>
          <tbody id="risksTableBody"></tbody>
        </table>
      </div>

      <div class="text-muted fs-12 mt-3">
        Regra (protótipo): é possível excluir apenas riscos <span class="fw-semibold">Abertos</span> criados manualmente. Riscos <span class="fw-semibold">Encerrados</span> não podem ser excluídos.
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Criar/Editar Risco -->
<div class="modal fade" id="risksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="risksModalTitle">Novo risco</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="riskFormId" value="" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Título</label>
            <input type="text" class="form-control" id="riskFormTitle" placeholder="Ex.: Duplicidade de eventos no webhook" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="riskFormCategory">
              <option value="TECH" selected>Técnico</option>
              <option value="SECURITY">Segurança</option>
              <option value="OPS">Operacional</option>
              <option value="COMPLIANCE">Legal/Compliance</option>
              <option value="VENDOR">Fornecedor</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Severidade</label>
            <select class="form-select" id="riskFormSeverity">
              <option value="LOW">Baixa</option>
              <option value="MEDIUM" selected>Média</option>
              <option value="HIGH">Alta</option>
              <option value="CRITICAL">Crítica</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Status</label>
            <select class="form-select" id="riskFormStatus">
              <option value="OPEN" selected>Aberto</option>
              <option value="MITIGATING">Mitigando</option>
              <option value="CLOSED">Encerrado</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Responsável</label>
            <select class="form-select" id="riskFormOwner">
              <option value="luciene" selected>Luciene Martins</option>
              <option value="joao">João Santos</option>
              <option value="maria">Maria Silva</option>
              <option value="leonardo">Leonardo Queiroz</option>
              <option value="sistema">Sistema GoMAP</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Prazo</label>
            <input type="date" class="form-control" id="riskFormDue" />
          </div>

          <div class="col-12">
            <label class="form-label">Descrição</label>
            <textarea class="form-control" id="riskFormDesc" rows="3" placeholder="Contexto e impacto do risco..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Plano de mitigação</label>
            <textarea class="form-control" id="riskFormMitigation" rows="3" placeholder="O que será feito para reduzir a probabilidade/impacto..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Plano de contingência (opcional)</label>
            <textarea class="form-control" id="riskFormContingency" rows="2" placeholder="O que fazer se o risco ocorrer..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Evidência (opcional)</label>
            <div class="input-group">
              <input type="text" class="form-control" id="riskFormEvidence" placeholder="Ex.: evidencias-homologacao.pdf (mock)" />
              <button type="button" class="btn btn-light" id="riskFormEvidenceBtn">
                <i class="ti ti-paperclip me-1"></i>Anexar (mock)
              </button>
            </div>
            <div class="text-muted fs-12 mt-1">Protótipo UI: o anexo é simulado pelo nome; download mostra um alerta.</div>
          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>

        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-success d-none" id="riskFormCloseBtn">
            <i class="ti ti-check me-1"></i>Encerrar
          </button>
          <button type="button" class="btn btn-primary" id="riskFormSaveBtn">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  const RISKS_STORAGE_KEY = "gomap_risks_0006";

  const actors = {
    luciene: { key: "luciene", name: "Luciene Martins", avatar: "assets/images/users/user-3.jpg" },
    joao: { key: "joao", name: "João Santos", avatar: "assets/images/users/user-5.jpg" },
    maria: { key: "maria", name: "Maria Silva", avatar: "assets/images/users/user-2.jpg" },
    leonardo: { key: "leonardo", name: "Leonardo Queiroz", avatar: "assets/images/users/user-7.jpg" },
    sistema: { key: "sistema", name: "Sistema GoMAP", avatar: null }
  };

  const categoryMeta = {
    TECH: "Técnico",
    SECURITY: "Segurança",
    OPS: "Operacional",
    COMPLIANCE: "Legal/Compliance",
    VENDOR: "Fornecedor"
  };

  const statusMeta = {
    OPEN: { label: "Aberto", badge: "badge-soft-danger" },
    MITIGATING: { label: "Mitigando", badge: "badge-soft-warning" },
    CLOSED: { label: "Encerrado", badge: "badge-soft-success" }
  };

  const severityMeta = {
    LOW: { label: "Baixa", badge: "badge-soft-secondary" },
    MEDIUM: { label: "Média", badge: "badge-soft-primary" },
    HIGH: { label: "Alta", badge: "badge-soft-warning" },
    CRITICAL: { label: "Crítica", badge: "badge-soft-danger" }
  };

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function nowIso() { return new Date().toISOString(); }

  function fmtDateBR(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function fmtDateTimeBR(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }

  function readRisks() {
    try {
      const raw = localStorage.getItem(RISKS_STORAGE_KEY);
      const data = raw ? JSON.parse(raw) : null;
      return Array.isArray(data) ? data : [];
    } catch (e) {
      return [];
    }
  }

  function writeRisks(list) {
    localStorage.setItem(RISKS_STORAGE_KEY, JSON.stringify(list || []));
  }

  function seedIfEmpty() {
    const current = readRisks();
    if (current.length) return current;

    const seeded = [
      {
        id: "R-001",
        title: "Duplicidade de eventos no webhook (idempotência)",
        category: "TECH",
        severity: "HIGH",
        status: "MITIGATING",
        ownerKey: "joao",
        dueDate: "2026-02-05",
        description: "Eventos duplicados podem gerar cobranças/reconciliação inconsistente.",
        mitigation: "Aplicar idempotência por chave de transação e retentativas com backoff.",
        contingency: "Fila de compensação e validação por conciliação diária.",
        evidence: "matriz-eventos-webhook.xlsx",
        createdAt: "2025-12-20T10:05:00-03:00",
        updatedAt: "2026-01-10T16:40:00-03:00",
        source: "manual"
      },
      {
        id: "R-002",
        title: "Divergência na conciliação PIX vs Cartão",
        category: "OPS",
        severity: "MEDIUM",
        status: "OPEN",
        ownerKey: "maria",
        dueDate: "2026-02-10",
        description: "Possível divergência por atrasos de compensação e janelas de processamento distintas.",
        mitigation: "Ajustar janelas de conciliação e validar regras de corte.",
        contingency: "Processo manual de ajuste com trilha de auditoria.",
        evidence: "relatorio-conciliacao-jan-2026.csv",
        createdAt: "2026-01-18T10:20:00-03:00",
        updatedAt: "2026-01-18T10:20:00-03:00",
        source: "manual"
      },
      {
        id: "R-003",
        title: "Indisponibilidade do provedor em horário de pico",
        category: "VENDOR",
        severity: "CRITICAL",
        status: "MITIGATING",
        ownerKey: "luciene",
        dueDate: "2026-01-30",
        description: "Indisponibilidade impacta autorização e confirmação de pagamento.",
        mitigation: "Circuit breaker + retry controlado; monitoramento de SLA do provedor.",
        contingency: "Fila de pendências e reprocessamento; fallback para canal alternativo (se disponível).",
        evidence: "",
        createdAt: "2025-11-15T11:00:00-03:00",
        updatedAt: "2026-01-05T09:10:00-03:00",
        source: "manual"
      },
      {
        id: "R-004",
        title: "Requisitos LGPD/segurança (tokens e logs)",
        category: "SECURITY",
        severity: "HIGH",
        status: "OPEN",
        ownerKey: "leonardo",
        dueDate: "2026-02-01",
        description: "Logs podem conter dados sensíveis se não houver mascaramento/criptografia adequada.",
        mitigation: "Mascarar payloads, rotacionar segredos e reforçar trilha de auditoria.",
        contingency: "Revisão emergencial de logging e revogação/rotação de credenciais.",
        evidence: "",
        createdAt: "2025-12-01T14:30:00-03:00",
        updatedAt: "2025-12-01T14:30:00-03:00",
        source: "manual"
      }
    ];

    writeRisks(seeded);
    return seeded;
  }

  function logbookSafe(entry) {
    try {
      if (window && typeof window.addLogbookEntry === "function") {
        window.addLogbookEntry(entry);
      } else if (window && typeof window.addLogbookEntryFromFile === "function") {
        // fallback: registra como NOTE genérica
        window.addLogbookEntryFromFile("NOTE", { name: entry.title || "Atualização de risco" }, entry.actorKey || "sistema");
      }
    } catch (e) {}
  }

  function addLogRisk(action, risk) {
    const actorKey = risk.ownerKey || "sistema";
    const actorName = (actors[actorKey] || actors.sistema).name;

    const title =
      action === "CREATE" ? "Risco criado" :
      action === "UPDATE" ? "Risco atualizado" :
      action === "CLOSE"  ? "Risco encerrado" :
      "Risco removido";

    const desc =
      action === "CREATE" ? `Criado: ${risk.id} — ${risk.title}` :
      action === "UPDATE" ? `Atualizado: ${risk.id} — ${risk.title}` :
      action === "CLOSE"  ? `Encerrado: ${risk.id} — ${risk.title}` :
      `Removido: ${risk.id} — ${risk.title}`;

    logbookSafe({
      id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
      createdAt: nowIso(),
      type: "RISK",
      title: title,
      description: desc,
      actorKey: actorKey,
      source: "manual",
      tags: ["Riscos", risk.id, categoryMeta[risk.category] || "Risco"],
      attachments: risk.evidence ? [{ name: risk.evidence, href: "#" }] : []
    });

    // melhora a timeline no visual: mostra autor como texto no evento
    // (seu renderer já puxa nome pelo actorKey)
  }

  const el = {
    body: document.getElementById("risksTableBody"),
    empty: document.getElementById("risksEmptyState"),

    countOpen: document.getElementById("riskCountOpen"),
    countMitigating: document.getElementById("riskCountMitigating"),
    countClosed: document.getElementById("riskCountClosed"),

    search: document.getElementById("risksSearch"),
    fStatus: document.getElementById("risksFilterStatus"),
    fSeverity: document.getElementById("risksFilterSeverity"),
    fCategory: document.getElementById("risksFilterCategory"),
    fOwner: document.getElementById("risksFilterOwner"),
    apply: document.getElementById("risksApply"),
    clear: document.getElementById("risksClear"),

    exportBtn: document.getElementById("risksExport"),
    clearAllBtn: document.getElementById("risksClearAll"),

    // modal form
    modalTitle: document.getElementById("risksModalTitle"),
    formId: document.getElementById("riskFormId"),
    formTitle: document.getElementById("riskFormTitle"),
    formCategory: document.getElementById("riskFormCategory"),
    formSeverity: document.getElementById("riskFormSeverity"),
    formStatus: document.getElementById("riskFormStatus"),
    formOwner: document.getElementById("riskFormOwner"),
    formDue: document.getElementById("riskFormDue"),
    formDesc: document.getElementById("riskFormDesc"),
    formMitigation: document.getElementById("riskFormMitigation"),
    formContingency: document.getElementById("riskFormContingency"),
    formEvidence: document.getElementById("riskFormEvidence"),
    formEvidenceBtn: document.getElementById("riskFormEvidenceBtn"),
    formSave: document.getElementById("riskFormSaveBtn"),
    formClose: document.getElementById("riskFormCloseBtn"),
  };

  let risks = seedIfEmpty();

  function computeCounts(list) {
    const open = list.filter(r => r.status === "OPEN").length;
    const mit = list.filter(r => r.status === "MITIGATING").length;
    const clo = list.filter(r => r.status === "CLOSED").length;
    el.countOpen.textContent = `Abertos: ${open}`;
    el.countMitigating.textContent = `Mitigando: ${mit}`;
    el.countClosed.textContent = `Encerrados: ${clo}`;
  }

  function getFiltered() {
    const q = (el.search.value || "").trim().toLowerCase();
    const st = el.fStatus.value || "all";
    const sv = el.fSeverity.value || "all";
    const cat = el.fCategory.value || "all";
    const own = el.fOwner.value || "all";

    return risks
      .slice()
      .sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .filter((r) => {
        const owner = actors[r.ownerKey] || actors.sistema;
        const blob = [
          r.id, r.title, r.description, r.mitigation, r.contingency,
          r.category, categoryMeta[r.category] || "",
          r.severity, severityMeta[r.severity]?.label || "",
          r.status, statusMeta[r.status]?.label || "",
          owner.name, r.dueDate || "", r.evidence || ""
        ].join(" ").toLowerCase();

        const matchQ = !q || blob.includes(q);
        const matchSt = st === "all" || r.status === st;
        const matchSv = sv === "all" || r.severity === sv;
        const matchCat = cat === "all" || r.category === cat;
        const matchOwn = own === "all" || r.ownerKey === own;

        return matchQ && matchSt && matchSv && matchCat && matchOwn;
      });
  }

  function canDelete(risk) {
    // protótipo: só manual + aberto
    return risk.source === "manual" && risk.status === "OPEN";
  }

  function render(list) {
    el.body.innerHTML = "";
    el.empty.classList.toggle("d-none", list.length > 0);

    list.forEach((r) => {
      const st = statusMeta[r.status] || { label: r.status, badge: "badge-soft-secondary" };
      const sv = severityMeta[r.severity] || { label: r.severity, badge: "badge-soft-secondary" };
      const owner = actors[r.ownerKey] || actors.sistema;

      const ownerHtml = owner.avatar
        ? `<div class="d-flex align-items-center gap-2">
             <img src="${esc(owner.avatar)}" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" alt="${esc(owner.name)}">
             <span class="fw-medium">${esc(owner.name)}</span>
           </div>`
        : `<div class="d-flex align-items-center gap-2">
             <span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;">
               <i class="ti ti-cpu fs-6"></i>
             </span>
             <span class="fw-medium">${esc(owner.name)}</span>
           </div>`;

      const delBtn = canDelete(r)
        ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(r.id)}" title="Excluir"><i class="ti ti-trash"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Exclusão indisponível neste status/regra."><i class="ti ti-lock"></i></button>`;

      const closeBtn = (r.status !== "CLOSED")
        ? `<button class="btn btn-light btn-sm" type="button" data-action="close" data-id="${esc(r.id)}" title="Encerrar"><i class="ti ti-check"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Já encerrado."><i class="ti ti-check"></i></button>`;

      const evidenceBtn = r.evidence
        ? `<button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(r.id)}" title="Download evidência"><i class="ti ti-download"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Sem evidência."><i class="ti ti-download"></i></button>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-muted fw-medium">${esc(r.id)}</td>
        <td>
          <div class="fw-medium">${esc(r.title)}</div>
          <div class="text-muted fs-12">${esc(categoryMeta[r.category] || r.category)}</div>
        </td>
        <td><span class="badge ${esc(sv.badge)} fs-xxs">${esc(sv.label)}</span></td>
        <td><span class="badge ${esc(st.badge)} fs-xxs">${esc(st.label)}</span></td>
        <td>${ownerHtml}</td>
        <td class="text-muted">${r.dueDate ? esc(fmtDateBR(r.dueDate)) : "—"}</td>
        <td class="text-muted">${esc(fmtDateTimeBR(r.updatedAt))}</td>
        <td class="text-center">
          <div class="d-flex justify-content-center gap-1">
            <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(r.id)}" title="Ver/Editar">
              <i class="ti ti-edit"></i>
            </button>
            ${closeBtn}
            ${evidenceBtn}
            ${delBtn}
          </div>
        </td>
      `;
      el.body.appendChild(tr);
    });

    computeCounts(risks);
  }

  function refresh() {
    render(getFiltered());
  }

  function resetForm() {
    el.formId.value = "";
    el.formTitle.value = "";
    el.formCategory.value = "TECH";
    el.formSeverity.value = "MEDIUM";
    el.formStatus.value = "OPEN";
    el.formOwner.value = "luciene";

    // prazo default +15 dias
    const d = new Date();
    d.setDate(d.getDate() + 15);
    el.formDue.value = d.toISOString().slice(0,10);

    el.formDesc.value = "";
    el.formMitigation.value = "";
    el.formContingency.value = "";
    el.formEvidence.value = "";
  }

  function openCreate() {
    el.modalTitle.textContent = "Novo risco";
    resetForm();
    el.formClose.classList.add("d-none");
  }

  function openEdit(id) {
    const r = risks.find(x => x.id === id);
    if (!r) return;

    el.modalTitle.textContent = `Editar risco — ${r.id}`;
    el.formId.value = r.id;
    el.formTitle.value = r.title || "";
    el.formCategory.value = r.category || "TECH";
    el.formSeverity.value = r.severity || "MEDIUM";
    el.formStatus.value = r.status || "OPEN";
    el.formOwner.value = r.ownerKey || "luciene";
    el.formDue.value = r.dueDate || "";
    el.formDesc.value = r.description || "";
    el.formMitigation.value = r.mitigation || "";
    el.formContingency.value = r.contingency || "";
    el.formEvidence.value = r.evidence || "";

    // botão encerrar aparece apenas se não estiver encerrado
    if (r.status !== "CLOSED") el.formClose.classList.remove("d-none");
    else el.formClose.classList.add("d-none");

    const modalEl = document.getElementById("risksModal");
    try {
      const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
      modal.show();
    } catch (e) {}
  }

  function nextId() {
    // gera sequência simples R-00X
    const nums = risks
      .map(r => String(r.id || "").replace("R-",""))
      .map(n => parseInt(n,10))
      .filter(n => !isNaN(n));
    const max = nums.length ? Math.max(...nums) : 0;
    return `R-${String(max + 1).padStart(3, "0")}`;
  }

  function saveForm() {
    const id = (el.formId.value || "").trim();
    const title = (el.formTitle.value || "").trim();
    const category = el.formCategory.value;
    const severity = el.formSeverity.value;
    const status = el.formStatus.value;
    const ownerKey = el.formOwner.value;
    const dueDate = el.formDue.value;
    const description = (el.formDesc.value || "").trim();
    const mitigation = (el.formMitigation.value || "").trim();
    const contingency = (el.formContingency.value || "").trim();
    const evidence = (el.formEvidence.value || "").trim();

    if (!title || !description) {
      alert("Preencha o título e a descrição.");
      return;
    }

    if (!mitigation && status !== "CLOSED") {
      // regra minimalista para forçar mitigação em andamento
      const ok = confirm("Plano de mitigação está vazio. Deseja salvar mesmo assim?");
      if (!ok) return;
    }

    const isEdit = !!id;
    const updatedAt = nowIso();

    if (isEdit) {
      const idx = risks.findIndex(r => r.id === id);
      if (idx < 0) return;

      const prev = risks[idx];

      const next = {
        ...prev,
        title, category, severity, status, ownerKey,
        dueDate, description, mitigation, contingency, evidence,
        updatedAt
      };

      risks[idx] = next;
      writeRisks(risks);

      addLogRisk("UPDATE", next);
    } else {
      const newRisk = {
        id: nextId(),
        title, category, severity, status, ownerKey,
        dueDate, description, mitigation, contingency, evidence,
        createdAt: updatedAt,
        updatedAt: updatedAt,
        source: "manual"
      };

      risks.unshift(newRisk);
      writeRisks(risks);

      addLogRisk("CREATE", newRisk);
    }

    const modalEl = document.getElementById("risksModal");
    try {
      const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
      modal.hide();
    } catch (e) {}

    refresh();
  }

  function closeRisk(id) {
    const idx = risks.findIndex(r => r.id === id);
    if (idx < 0) return;
    const r = risks[idx];

    if (r.status === "CLOSED") return;

    const ok = confirm(`Encerrar o risco ${r.id}?`);
    if (!ok) return;

    const next = { ...r, status: "CLOSED", updatedAt: nowIso() };
    risks[idx] = next;
    writeRisks(risks);

    addLogRisk("CLOSE", next);
    refresh();
  }

  function deleteRisk(id) {
    const r = risks.find(x => x.id === id);
    if (!r) return;

    if (!canDelete(r)) {
      alert("Exclusão indisponível. Regra (protótipo): apenas riscos abertos criados manualmente podem ser excluídos.");
      return;
    }

    const ok = confirm(`Excluir o risco ${r.id}? Esta ação é apenas um protótipo UI.`);
    if (!ok) return;

    risks = risks.filter(x => x.id !== id);
    writeRisks(risks);

    addLogRisk("DELETE", r);
    refresh();
  }

  function downloadEvidence(id) {
    const r = risks.find(x => x.id === id);
    if (!r || !r.evidence) return;
    alert(`Download do Arquivo: ${r.evidence}`);
  }

  function wire() {
    // filtros
    el.apply.addEventListener("click", refresh);

    el.clear.addEventListener("click", () => {
      el.search.value = "";
      el.fStatus.value = "all";
      el.fSeverity.value = "all";
      el.fCategory.value = "all";
      el.fOwner.value = "all";
      refresh();
    });

    el.search.addEventListener("input", () => {
      clearTimeout(el.search._t);
      el.search._t = setTimeout(refresh, 150);
    });

    // ações dropdown
    el.exportBtn.addEventListener("click", (e) => {
      e.preventDefault();
      alert("Exportar (protótipo UI).");
    });

    el.clearAllBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const ok = confirm("Limpar riscos salvos deste projeto? (Protótipo) Isso remove apenas o que está no localStorage.");
      if (!ok) return;
      writeRisks([]);
      risks = seedIfEmpty(); // repopula
      alert("Riscos resetados (protótipo UI).");
      refresh();
    });

    // modal: abrir novo
    const modalEl = document.getElementById("risksModal");
    modalEl.addEventListener("show.bs.modal", () => {
      // se não está editando, abre em create
      if (!el.formId.value) openCreate();
    });

    // modal: anexar mock
    el.formEvidenceBtn.addEventListener("click", () => {
      const cur = (el.formEvidence.value || "").trim();
      el.formEvidence.value = cur ? "" : "evidencias-homologacao.pdf";
    });

    // salvar
    el.formSave.addEventListener("click", saveForm);

    // encerrar via modal
    el.formClose.addEventListener("click", () => {
      const id = (el.formId.value || "").trim();
      if (!id) return;
      closeRisk(id);
      // fecha modal depois
      try {
        const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
        modal.hide();
      } catch (e) {}
    });

    // ações na tabela
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("[data-action][data-id]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!action || !id) return;

      ev.preventDefault();

      if (action === "edit") return openEdit(id);
      if (action === "close") return closeRisk(id);
      if (action === "delete") return deleteRisk(id);
      if (action === "download") return downloadEvidence(id);
    });
  }

  function init() {
    wire();
    refresh();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>


                    <!-- TAB FILES -->
                    <div class="tab-pane" id="tab-files" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body">

                          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                            <div>
                              <h5 class="mb-1">Arquivos</h5>
                              <div class="text-muted fs-12">Biblioteca de evidências e documentos do projeto (uploads e arquivos gerados pelo sistema).</div>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-2">
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filesUploadModal">
                                <i class="ti ti-upload me-1"></i>Enviar arquivo
                              </button>

                              <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  Ações
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                  <li><a class="dropdown-item" href="#" id="filesExportList"><i class="ti ti-download me-2"></i>Exportar lista</a></li>
                                  <li><a class="dropdown-item" href="#" id="filesGenerateDoc"><i class="ti ti-file-text me-2"></i>Gerar relatório (sistema)</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <div class="card mb-3 border">
                            <div class="card-body">
                              <div class="row g-2 align-items-end">
                                <div class="col-12 col-lg-4">
                                  <label class="form-label">Buscar</label>
                                  <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-search"></i></span>
                                    <input type="text" class="form-control" id="filesSearch" placeholder="Buscar por nome do arquivo..." />
                                  </div>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Tipo</label>
                                  <select class="form-select" id="filesFilterType">
                                    <option value="all" selected>Todos</option>
                                    <option value="pdf">PDF</option>
                                    <option value="xlsx">XLSX</option>
                                    <option value="csv">CSV</option>
                                    <option value="docx">DOCX</option>
                                    <option value="img">Imagem</option>
                                    <option value="other">Outros</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Origem</label>
                                  <select class="form-select" id="filesFilterSource">
                                    <option value="all" selected>Todas</option>
                                    <option value="upload">Upload</option>
                                    <option value="generated">Sistema</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Autor</label>
                                  <select class="form-select" id="filesFilterAuthor">
                                    <option value="all" selected>Todos</option>
                                    <option value="Luciene Martins">Luciene Martins</option>
                                    <option value="João Santos">João Santos</option>
                                    <option value="Maria Silva">Maria Silva</option>
                                    <option value="Leonardo Queiroz">Leonardo Queiroz</option>
                                    <option value="Sistema GoMAP">Sistema GoMAP</option>
                                  </select>
                                </div>

                                <div class="col-12 col-lg-2 d-flex gap-2 justify-content-end">
                                  <button type="button" class="btn btn-outline-primary w-100" id="filesApplyFilters">
                                    <i class="ti ti-filter me-1"></i>Filtrar
                                  </button>
                                  <button type="button" class="btn btn-light w-100" id="filesClearFilters">
                                    <i class="ti ti-rotate-2 me-1"></i>Limpar
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div id="filesEmptyState" class="d-none">
                            <div class="text-center py-5 text-muted">
                              <div class="avatar-xl mx-auto mb-2">
                                <span class="avatar-title rounded-circle bg-light text-muted">
                                  <i class="ti ti-folder fs-2"></i>
                                </span>
                              </div>
                              <h5 class="mb-1">Nenhum arquivo encontrado</h5>
                              <div class="text-muted">Ajuste os filtros ou limpe para ver todos os arquivos.</div>
                            </div>
                          </div>

                          <div class="table-responsive">
                            <table class="table table-custom table-centered table-hover w-100 mb-0">
                              <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                                <tr class="text-uppercase fs-xxs">
                                  <th>Arquivo</th>
                                  <th style="width: 1%;">Tipo</th>
                                  <th style="width: 1%;">Tamanho</th>
                                  <th style="width: 1%;">Origem</th>
                                  <th style="width: 1%;">Autor</th>
                                  <th style="width: 1%;">Data</th>
                                  <th class="text-center" style="width: 1%;">Ações</th>
                                </tr>
                              </thead>
                              <tbody id="filesTableBody"></tbody>
                            </table>
                          </div>

                          <div class="text-muted fs-12 mt-3">
                            Regra: apenas arquivos de <span class="fw-semibold">Upload</span> podem ser excluídos. Arquivos do <span class="fw-semibold">Sistema</span> são somente leitura.
                          </div>

                        </div>
                      </div>
                    </div>

                    <!-- TAB LOGBOOK -->
                    <div class="tab-pane" id="tab-logbook" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body">

                          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                            <div>
                              <h5 class="mb-1">Diário de bordo</h5>
                              <div class="text-muted fs-12">Log de eventos do projeto (manual e sistema), com rastreabilidade e anexos.</div>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-2">
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logbookAddModal">
                                <i class="ti ti-plus me-1"></i>Adicionar
                              </button>
                            </div>
                          </div>

                          <div class="card mb-3 border">
                            <div class="card-body">
                              <div class="row g-2 align-items-end">
                                <div class="col-12 col-lg-4">
                                  <label class="form-label">Buscar</label>
                                  <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-search"></i></span>
                                    <input type="text" class="form-control" id="logbookSearch" placeholder="Buscar por título, descrição, tags..." />
                                  </div>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Autor</label>
                                  <select class="form-select" id="logbookFilterActor">
                                    <option value="all" selected>Todos</option>
                                    <option value="luciene">Luciene Martins</option>
                                    <option value="joao">João Santos</option>
                                    <option value="maria">Maria Silva</option>
                                    <option value="leonardo">Leonardo Queiroz</option>
                                    <option value="sistema">Sistema GoMAP</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Tipo</label>
                                  <select class="form-select" id="logbookFilterType">
                                    <option value="all" selected>Todos</option>
                                    <option value="COMMENT">Comentário</option>
                                    <option value="NOTE">Nota</option>
                                    <option value="DECISION">Decisão</option>
                                    <option value="APPROVAL">Aprovação</option>
                                    <option value="RISK">Risco</option>
                                    <option value="MILESTONE">Marco</option>
                                    <option value="UPLOAD">Upload</option>
                                    <option value="SYSTEM_GENERATED">Gerado pelo sistema</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Origem</label>
                                  <select class="form-select" id="logbookFilterSource">
                                    <option value="all" selected>Todas</option>
                                    <option value="manual">Manual</option>
                                    <option value="system">Sistema</option>
                                    <option value="upload">Upload</option>
                                  </select>
                                </div>

                                <div class="col-12 col-lg-2 d-flex gap-2 justify-content-end">
                                  <button type="button" class="btn btn-outline-primary w-100" id="logbookApplyFilters">
                                    <i class="ti ti-filter me-1"></i>Filtrar
                                  </button>
                                  <button type="button" class="btn btn-light w-100" id="logbookClearFilters">
                                    <i class="ti ti-rotate-2 me-1"></i>Limpar
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div id="logbookEmptyState" class="d-none">
                            <div class="text-center py-5 text-muted">
                              <div class="avatar-xl mx-auto mb-2">
                                <span class="avatar-title rounded-circle bg-light text-muted">
                                  <i class="ti ti-notes fs-2"></i>
                                </span>
                              </div>
                              <h5 class="mb-1">Nenhum registro encontrado</h5>
                              <div class="text-muted">Ajuste os filtros ou limpe para ver todos os registros.</div>
                            </div>
                          </div>

                          <div id="logbookTimeline" class="d-flex flex-column gap-2"></div>

                        </div>
                      </div>
                    </div>

                  </div><!-- /tab-content -->

                </div><!-- /card-body -->

              </div><!-- /card -->

            </div>
          </div>

        </div>
      </div>

      <!-- Footer Start -->
      <footer class="footer">
          <div class="container-fluid">
              <div class="row">
                  <div class="col-md-6 text-center text-md-start">
                      Copyright © 2025 - Secretaria Geral de Governo de Goiás - Todos os direitos reservados. 
                  </div>
                  <div class="col-md-6">
                      <div class="text-md-end d-none d-md-block">
                          10GB of <span class="fw-bold">250GB</span> Free.
                      </div>
                  </div>
              </div>
          </div>
      </footer>
      <!-- end Footer -->
    </div>

  </div><!-- /wrapper -->

  <!-- MODAL: Upload Arquivo -->
  <div class="modal fade" id="filesUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Enviar arquivo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Nome do arquivo</label>
              <input type="text" class="form-control" id="filesUploadName" placeholder="Ex.: Checklist Go-live.pdf" />
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="filesUploadType">
                <option value="pdf" selected>PDF</option>
                <option value="xlsx">XLSX</option>
                <option value="csv">CSV</option>
                <option value="docx">DOCX</option>
                <option value="img">Imagem</option>
                <option value="other">Outros</option>
              </select>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Autor</label>
              <select class="form-select" id="filesUploadAuthor">
                <option value="" selected>Selecione</option>
                <option value="Luciene Martins">Luciene Martins</option>
                <option value="João Santos">João Santos</option>
                <option value="Maria Silva">Maria Silva</option>
                <option value="Leonardo Queiroz">Leonardo Queiroz</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Descrição (opcional)</label>
              <textarea class="form-control" rows="3" id="filesUploadDesc" placeholder="Observações sobre o arquivo..."></textarea>
            </div>

            <div class="col-12">
              <div class="text-muted fs-12">Protótipo UI: o upload é simulado e o download exibe uma mensagem.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="filesUploadSave">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL: Adicionar Diário -->
  <div class="modal fade" id="logbookAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Adicionar entrada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="logbookAddType">
                <option value="" selected>Selecione</option>
                <option value="COMMENT">Comentário</option>
                <option value="NOTE">Nota</option>
                <option value="UPLOAD">Upload</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Autor</label>
              <select class="form-select" id="logbookAddActor">
                <option value="" selected>Selecione</option>
                <option value="luciene">Luciene Martins</option>
                <option value="joao">João Santos</option>
                <option value="maria">Maria Silva</option>
                <option value="leonardo">Leonardo Queiroz</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Data</label>
              <input type="datetime-local" class="form-control" id="logbookAddDate" />
            </div>

            <div class="col-12">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" id="logbookAddTitle" placeholder="Ex.: Ajuste de escopo, Upload de documento..." />
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              <textarea class="form-control" id="logbookAddDesc" rows="4" placeholder="Descreva o ocorrido com objetividade."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Anexo (opcional)</label>
              <div class="input-group">
                <input type="text" class="form-control" id="logbookAddFileName" placeholder="Ex.: documento.pdf (mock)" />
                <button class="btn btn-light" type="button" id="logbookAddAttachToggle">
                  <i class="ti ti-paperclip me-1"></i>Anexar (mock)
                </button>
              </div>
              <div class="text-muted fs-12 mt-1">Protótipo UI: o anexo é simulado pelo nome.</div>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="logbookAddSave">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- Vendor js -->
  <script src="assets/js/vendors.min.js"></script>

  <!-- App js -->
  <script src="assets/js/app.js"></script>

  <script>
    // STORAGE + EVENT BUS (shared)
    (function () {
      window.LOGBOOK_STORAGE_KEY = "gomap_logbook_0006";

      window.readLogbookStorage = function () {
        try {
          const raw = localStorage.getItem(window.LOGBOOK_STORAGE_KEY);
          const data = raw ? JSON.parse(raw) : [];
          return Array.isArray(data) ? data : [];
        } catch (e) {
          return [];
        }
      };

      window.writeLogbookStorage = function (list) {
        localStorage.setItem(window.LOGBOOK_STORAGE_KEY, JSON.stringify(list || []));
      };

      window.addLogbookEntry = function (entry) {
        const list = window.readLogbookStorage();
        list.unshift(entry);
        window.writeLogbookStorage(list);
        window.dispatchEvent(new CustomEvent("gomap:logbook-updated", { detail: { entry } }));
      };

      window.addLogbookEntryFromFile = function (actionType, file, actorKeyOverride) {
        const nowIso = new Date().toISOString();

        const entry = {
          id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
          createdAt: nowIso,
          type: actionType, // "UPLOAD" | "SYSTEM_GENERATED" | "NOTE"
          title:
            actionType === "UPLOAD"
              ? "Upload de arquivo"
              : actionType === "SYSTEM_GENERATED"
              ? "Arquivo gerado pelo sistema"
              : "Arquivo removido",
          description:
            actionType === "UPLOAD"
              ? `Arquivo enviado: ${file.name}`
              : actionType === "SYSTEM_GENERATED"
              ? `Arquivo gerado: ${file.name}`
              : `Arquivo removido: ${file.name}`,
          actorKey: actionType === "SYSTEM_GENERATED" ? "sistema" : (actorKeyOverride || "joao"),
          source: actionType === "UPLOAD" ? "upload" : "system",
          tags: ["Arquivos"],
          attachments: [{ name: file.name, href: "#" }]
        };

        window.addLogbookEntry(entry);
      };
    })();
  </script>

  <script>
    // TAB FILES
    (function () {
      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function toDateLabel(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }

      function iconByType(type) {
        if (type === "pdf") return "ti ti-file-type-pdf";
        if (type === "xlsx") return "ti ti-file-spreadsheet";
        if (type === "csv") return "ti ti-file-text";
        if (type === "docx") return "ti ti-file-text";
        if (type === "img") return "ti ti-photo";
        return "ti ti-file";
      }

      function badgeBySource(source) {
        return source === "generated" ? "badge-soft-dark" : "badge-soft-primary";
      }

      function labelBySource(source) {
        return source === "generated" ? "Sistema" : "Upload";
      }

      function normalizeTypeFromName(name, fallbackType) {
        const n = (name || "").toLowerCase();
        if (n.endsWith(".pdf")) return "pdf";
        if (n.endsWith(".xlsx") || n.endsWith(".xls")) return "xlsx";
        if (n.endsWith(".csv")) return "csv";
        if (n.endsWith(".docx") || n.endsWith(".doc")) return "docx";
        if (n.endsWith(".png") || n.endsWith(".jpg") || n.endsWith(".jpeg") || n.endsWith(".webp")) return "img";
        return fallbackType || "other";
      }

      let files = [
        { id: "F-003", name: "Relatório de conciliação - Janeiro 2026.csv", type: "csv", size: "310 KB", source: "generated", author: "Sistema GoMAP", createdAt: "2026-01-18T07:10:00-03:00" },
        { id: "F-002", name: "Matriz de eventos de webhook.xlsx", type: "xlsx", size: "420 KB", source: "generated", author: "Sistema GoMAP", createdAt: "2025-12-20T10:05:00-03:00" },
        { id: "F-001", name: "Especificação de Integração - Pagamentos v1.3.pdf", type: "pdf", size: "1.8 MB", source: "upload", author: "João Santos", createdAt: "2025-10-12T15:22:00-03:00" }
      ];

      const el = {
        body: document.getElementById("filesTableBody"),
        empty: document.getElementById("filesEmptyState"),

        search: document.getElementById("filesSearch"),
        fType: document.getElementById("filesFilterType"),
        fSource: document.getElementById("filesFilterSource"),
        fAuthor: document.getElementById("filesFilterAuthor"),
        apply: document.getElementById("filesApplyFilters"),
        clear: document.getElementById("filesClearFilters"),

        exportList: document.getElementById("filesExportList"),
        generateDoc: document.getElementById("filesGenerateDoc"),

        uploadName: document.getElementById("filesUploadName"),
        uploadType: document.getElementById("filesUploadType"),
        uploadAuthor: document.getElementById("filesUploadAuthor"),
        uploadDesc: document.getElementById("filesUploadDesc"),
        uploadSave: document.getElementById("filesUploadSave")
      };

      function getFiltered() {
        const q = (el.search.value || "").trim().toLowerCase();
        const type = el.fType.value || "all";
        const source = el.fSource.value || "all";
        const author = el.fAuthor.value || "all";

        return files
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .filter((f) => {
            const blob = [f.id, f.name, f.type, f.size, f.source, f.author].join(" ").toLowerCase();
            const matchQ = !q || blob.includes(q);
            const matchType = type === "all" || f.type === type;
            const matchSource = source === "all" || f.source === source;
            const matchAuthor = author === "all" || f.author === author;
            return matchQ && matchType && matchSource && matchAuthor;
          });
      }

      function render(list) {
        el.body.innerHTML = "";
        el.empty.classList.toggle("d-none", list.length > 0);

        list.forEach((f) => {
          const canDelete = f.source === "upload";

          const tr = document.createElement("tr");
          tr.setAttribute("data-id", f.id);
          tr.innerHTML = `
            <td>
              <div class="d-flex align-items-center gap-2">
                <span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:28px;height:28px;">
                  <i class="${esc(iconByType(f.type))}"></i>
                </span>
                <div class="fw-medium">${esc(f.name)}</div>
              </div>
            </td>
            <td class="text-muted">${esc(f.type.toUpperCase())}</td>
            <td class="text-muted">${esc(f.size)}</td>
            <td><span class="badge ${esc(badgeBySource(f.source))} fs-xxs">${esc(labelBySource(f.source))}</span></td>
            <td class="text-muted">${esc(f.author)}</td>
            <td class="text-muted">${esc(toDateLabel(f.createdAt))}</td>
            <td class="text-center">
              <div class="d-flex justify-content-center gap-1">
                <button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(f.id)}" title="Download">
                  <i class="ti ti-download"></i>
                </button>
                <button class="btn btn-light btn-sm" type="button" data-action="view" data-id="${esc(f.id)}" title="Visualizar">
                  <i class="ti ti-eye"></i>
                </button>
                ${
                  canDelete
                    ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(f.id)}" title="Excluir"><i class="ti ti-trash"></i></button>`
                    : `<button class="btn btn-light btn-sm" type="button" disabled title="Arquivo do sistema não pode ser excluído."><i class="ti ti-lock"></i></button>`
                }
              </div>
            </td>
          `;
          el.body.appendChild(tr);
        });
      }

      function refresh() {
        render(getFiltered());
      }

      function downloadFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;
        alert(`Download do Arquivo: ${f.name}`);
      }

      function viewFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;
        alert(`Visualizar Arquivo: ${f.name}`);
      }

      function deleteFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;

        if (f.source !== "upload") {
          alert("Arquivo do sistema não pode ser excluído.");
          return;
        }

        const ok = confirm("Excluir este arquivo? Esta ação é apenas um protótipo UI.");
        if (!ok) return;

        files = files.filter(x => x.id !== id);

        // registra no diário
        window.addLogbookEntryFromFile("NOTE", { name: f.name }, "joao");

        refresh();
      }

      function wireHandlers() {
        document.addEventListener("click", (ev) => {
          const btn = ev.target.closest("[data-action]");
          if (!btn) return;

          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (!action || !id) return;

          ev.preventDefault();

          if (action === "download") return downloadFile(id);
          if (action === "view") return viewFile(id);
          if (action === "delete") return deleteFile(id);
        });

        el.apply.addEventListener("click", refresh);

        el.clear.addEventListener("click", () => {
          el.search.value = "";
          el.fType.value = "all";
          el.fSource.value = "all";
          el.fAuthor.value = "all";
          refresh();
        });

        el.search.addEventListener("input", () => {
          clearTimeout(el.search._t);
          el.search._t = setTimeout(refresh, 150);
        });

        el.exportList.addEventListener("click", (e) => {
          e.preventDefault();
          alert("Exportar lista (protótipo UI).");
        });

        el.generateDoc.addEventListener("click", (e) => {
          e.preventDefault();

          const now = new Date();
          const dd = String(now.getDate()).padStart(2, "0");
          const mm = String(now.getMonth() + 1).padStart(2, "0");
          const yy = now.getFullYear();

          const newFile = {
            id: `F-${String(Math.floor(Math.random() * 900) + 100)}`,
            name: `Relatório de conciliação - ${dd}-${mm}-${yy}.csv`,
            type: "csv",
            size: "280 KB",
            source: "generated",
            author: "Sistema GoMAP",
            createdAt: now.toISOString()
          };

          files.unshift(newFile);

          // registra no diário
          window.addLogbookEntryFromFile("SYSTEM_GENERATED", { name: newFile.name }, "sistema");

          alert("Arquivo gerado pelo sistema (protótipo UI).");
          refresh();
        });

        el.uploadSave.addEventListener("click", () => {
          const nameRaw = (el.uploadName.value || "").trim();
          const author = (el.uploadAuthor.value || "").trim();
          const typeRaw = (el.uploadType.value || "other").trim();

          if (!nameRaw || !author) {
            alert("Preencha o nome do arquivo e o autor.");
            return;
          }

          const type = normalizeTypeFromName(nameRaw, typeRaw);

          const newFile = {
            id: `F-${String(Math.floor(Math.random() * 900) + 100)}`,
            name: nameRaw,
            type: type,
            size: "—",
            source: "upload",
            author: author,
            createdAt: new Date().toISOString()
          };

          files.unshift(newFile);

          // registra no diário
          window.addLogbookEntryFromFile("UPLOAD", { name: newFile.name }, author === "Luciene Martins" ? "luciene" : "joao");

          const modalEl = document.getElementById("filesUploadModal");
          try {
            const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
            modal.hide();
          } catch (e) {}

          el.uploadName.value = "";
          el.uploadAuthor.value = "";
          el.uploadDesc.value = "";
          el.uploadType.value = "pdf";

          alert("Arquivo enviado (protótipo UI).");
          refresh();
        });
      }

      function init() {
        wireHandlers();
        refresh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  <script>
    // TAB LOGBOOK
    (function () {
      const actors = {
        luciene: { key: "luciene", name: "Luciene Martins", role: "Responsável", avatar: "assets/images/users/user-3.jpg", type: "user" },
        joao: { key: "joao", name: "João Santos", role: "Integração", avatar: "assets/images/users/user-5.jpg", type: "user" },
        maria: { key: "maria", name: "Maria Silva", role: "Negócio", avatar: "assets/images/users/user-2.jpg", type: "user" },
        leonardo: { key: "leonardo", name: "Leonardo Queiroz", role: "Arquitetura", avatar: "assets/images/users/user-7.jpg", type: "user" },
        sistema: { key: "sistema", name: "Sistema GoMAP", role: "Sistema", avatar: null, type: "system" }
      };

      const typeMeta = {
        COMMENT: { label: "Comentário", badge: "badge-soft-secondary" },
        NOTE: { label: "Nota", badge: "badge-soft-primary" },
        DECISION: { label: "Decisão", badge: "badge-soft-warning" },
        APPROVAL: { label: "Aprovação", badge: "badge-soft-info" },
        RISK: { label: "Risco", badge: "badge-soft-danger" },
        MILESTONE: { label: "Marco", badge: "badge-soft-success" },
        UPLOAD: { label: "Upload", badge: "badge-soft-primary" },
        SYSTEM_GENERATED: { label: "Sistema", badge: "badge-soft-dark" }
      };

      const deletableTypes = new Set(["COMMENT", "NOTE", "UPLOAD"]);

      const el = {
        timelineWrap: document.getElementById("logbookTimeline"),
        empty: document.getElementById("logbookEmptyState"),

        search: document.getElementById("logbookSearch"),
        fActor: document.getElementById("logbookFilterActor"),
        fType: document.getElementById("logbookFilterType"),
        fSource: document.getElementById("logbookFilterSource"),
        apply: document.getElementById("logbookApplyFilters"),
        clear: document.getElementById("logbookClearFilters"),

        addType: document.getElementById("logbookAddType"),
        addActor: document.getElementById("logbookAddActor"),
        addDate: document.getElementById("logbookAddDate"),
        addTitle: document.getElementById("logbookAddTitle"),
        addDesc: document.getElementById("logbookAddDesc"),
        addFileName: document.getElementById("logbookAddFileName"),
        addAttachToggle: document.getElementById("logbookAddAttachToggle"),
        addSave: document.getElementById("logbookAddSave")
      };

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function toDateLabel(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }

      function isDeletable(entry) {
        return deletableTypes.has(entry.type);
      }

      function iconByType(type) {
        if (type === "UPLOAD") return "ti ti-upload";
        if (type === "SYSTEM_GENERATED") return "ti ti-cpu";
        if (type === "APPROVAL") return "ti ti-check";
        if (type === "DECISION") return "ti ti-gavel";
        if (type === "RISK") return "ti ti-alert-triangle";
        if (type === "MILESTONE") return "ti ti-flag";
        if (type === "NOTE") return "ti ti-note";
        return "ti ti-message-circle";
      }

      // base (mock)
      let entries = [
        {
          id: "LG-021",
          createdAt: "2026-01-18T10:20:00-03:00",
          type: "SYSTEM_GENERATED",
          title: "Rotina de conciliação diária executada",
          description: "Conciliação concluída (PIX e cartão). Divergências: 2 registros em análise (pendente de confirmação do provedor).",
          actorKey: "sistema",
          source: "system",
          tags: ["Conciliação", "Rotina"],
          attachments: [{ name: "Relatório de conciliação - Janeiro 2026.csv", href: "#" }]
        },
        {
          id: "LG-020",
          createdAt: "2026-01-10T16:40:00-03:00",
          type: "MILESTONE",
          title: "Webhooks estabilizados com idempotência",
          description: "Eventos padronizados e idempotência por chave de transação aplicada. Retentativas com backoff configuradas.",
          actorKey: "joao",
          source: "manual",
          tags: ["Webhooks", "Idempotência"],
          attachments: []
        },
        {
          id: "LG-018",
          createdAt: "2025-12-18T14:10:00-03:00",
          type: "APPROVAL",
          title: "Homologação concluída (PIX + Cartão)",
          description: "Casos aprovados: aprovado/recusado, cancelamento, estorno, chargeback simulado e conciliação por arquivo.",
          actorKey: "maria",
          source: "manual",
          tags: ["Homologação"],
          attachments: []
        },
        {
          id: "LG-016",
          createdAt: "2025-11-15T11:00:00-03:00",
          type: "DECISION",
          title: "Definição do provedor e modelo de integração",
          description: "Escolha orientada por suporte a PIX, cartão, webhooks e conciliação. Início do sandbox e credenciais.",
          actorKey: "luciene",
          source: "manual",
          tags: ["Decisão"],
          attachments: []
        }
      ];

      function getFiltered() {
        const q = (el.search.value || "").trim().toLowerCase();
        const actor = el.fActor.value || "all";
        const type = el.fType.value || "all";
        const source = el.fSource.value || "all";

        return entries
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .filter((e) => {
            const a = actors[e.actorKey] || actors.sistema;
            const blob = [
              e.id, e.type, e.title, e.description, e.source, a.name, a.role,
              ...(e.tags || []),
              ...((e.attachments || []).map(x => x.name))
            ].join(" ").toLowerCase();

            const matchQ = !q || blob.includes(q);
            const matchActor = actor === "all" || e.actorKey === actor;
            const matchType = type === "all" || e.type === type;
            const matchSource = source === "all" || (e.source === source);

            return matchQ && matchActor && matchType && matchSource;
          });
      }

      function renderTimeline(list) {
        el.timelineWrap.innerHTML = "";

        list.forEach((e) => {
          const a = actors[e.actorKey] || actors.sistema;
          const t = typeMeta[e.type] || { label: e.type, badge: "badge-soft-secondary" };
          const canDelete = isDeletable(e);

          const hasAttach = (e.attachments || []).length > 0;
          const attach = hasAttach ? e.attachments[0] : null;

          const avatarHtml = a.avatar
            ? `<img src="${esc(a.avatar)}" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" alt="${esc(a.name)}">`
            : `<span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;"><i class="ti ti-cpu fs-6"></i></span>`;

          const downloadBtn = attach
            ? `<button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(e.id)}"><i class="ti ti-download me-1"></i>Download</button>`
            : "";

          const deleteBtn = canDelete
            ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(e.id)}"><i class="ti ti-trash"></i></button>`
            : `<button class="btn btn-light btn-sm" type="button" disabled title="Não é possível excluir este tipo de registro."><i class="ti ti-lock"></i></button>`;

          const tagsHtml = (e.tags || []).slice(0, 3).map(tag => `<span class="badge badge-soft-primary fs-xxs">#${esc(tag)}</span>`).join(" ");

          const row = document.createElement("div");
          row.className = "border rounded p-3";
          row.setAttribute("data-id", e.id);

          row.innerHTML = `
            <div class="d-flex align-items-start gap-3">
              <div class="flex-shrink-0">
                <span class="avatar-sm rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:36px;height:36px;">
                  <i class="${esc(iconByType(e.type))}"></i>
                </span>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge ${esc(t.badge)} fs-xxs">${esc(t.label)}</span>
                  <div class="fw-semibold">${esc(e.title)}</div>
                  <div class="text-muted ms-auto fs-12">${esc(toDateLabel(e.createdAt))}</div>
                </div>

                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                  ${avatarHtml}
                  <span class="fw-medium">${esc(a.name)}</span>
                  <span class="text-muted">•</span>
                  <span class="text-muted fs-12">${esc(a.type === "system" ? "Sistema" : a.role)}</span>
                  ${hasAttach ? `<span class="text-muted">•</span><span class="badge badge-soft-primary fs-xxs">#Anexo</span>` : ``}
                  <span class="ms-auto d-flex align-items-center gap-2">
                    ${downloadBtn}
                    ${deleteBtn}
                  </span>
                </div>

                <div class="text-muted mt-2">${esc(e.description)}</div>

                ${tagsHtml ? `<div class="mt-2 d-flex flex-wrap gap-1">${tagsHtml}</div>` : ``}
              </div>
            </div>
          `;

          el.timelineWrap.appendChild(row);
        });
      }

      function updateEmptyState(list) {
        el.empty.classList.toggle("d-none", list.length > 0);
      }

      function refresh() {
        const list = getFiltered();
        updateEmptyState(list);
        renderTimeline(list);
      }

      function deleteEntry(id) {
        const entry = entries.find(x => x.id === id);
        if (!entry) return;

        if (!isDeletable(entry)) {
          alert("Este tipo de registro não pode ser excluído.");
          return;
        }

        const ok = confirm("Excluir esta entrada do diário de bordo? Esta ação removerá da timeline.");
        if (!ok) return;

        entries = entries.filter(x => x.id !== id);

        // se essa entry veio do storage, remove do storage também
        const st = window.readLogbookStorage();
        const next = st.filter(x => x && x.id !== id);
        window.writeLogbookStorage(next);

        refresh();
      }

      function downloadEntry(id) {
        const entry = entries.find(x => x.id === id);
        if (!entry) return;

        const att = (entry.attachments || [])[0];
        if (!att) return;

        alert(`Download do Arquivo: ${att.name}`);
      }

      function wireHandlers() {
        document.addEventListener("click", (ev) => {
          const del = ev.target.closest('[data-action="delete"]');
          if (del) {
            ev.preventDefault();
            const id = del.getAttribute("data-id");
            if (id) deleteEntry(id);
            return;
          }

          const dl = ev.target.closest('[data-action="download"]');
          if (dl) {
            ev.preventDefault();
            const id = dl.getAttribute("data-id");
            if (id) downloadEntry(id);
            return;
          }
        });
      }

      function nowLocalForInput() {
        const d = new Date();
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function addEntryFromModal() {
        const type = el.addType.value;
        const actorKey = el.addActor.value;
        const date = el.addDate.value;
        const title = (el.addTitle.value || "").trim();
        const desc = (el.addDesc.value || "").trim();
        const fileName = (el.addFileName.value || "").trim();

        if (!type || !actorKey || !date || !title || !desc) {
          alert("Preencha tipo, autor, data, título e descrição.");
          return;
        }

        const entry = {
          id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
          createdAt: new Date(date).toISOString(),
          type: type,
          title: title,
          description: desc,
          actorKey: actorKey,
          source: type === "UPLOAD" ? "upload" : "manual",
          tags: [],
          attachments: fileName ? [{ name: fileName, href: "#" }] : []
        };

        // grava no storage (assim aparece sempre)
        window.addLogbookEntry(entry);

        const modalEl = document.getElementById("logbookAddModal");
        try {
          const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
          modal.hide();
        } catch (e) {}

        el.addType.value = "";
        el.addActor.value = "";
        el.addDate.value = nowLocalForInput();
        el.addTitle.value = "";
        el.addDesc.value = "";
        el.addFileName.value = "";

        // o listener abaixo vai recarregar; mas fazemos refresh por segurança visual
        refresh();
      }

      function init() {
        if (el.addDate) el.addDate.value = nowLocalForInput();

        // 1) carrega o que já existe no storage e coloca no topo
        const st = window.readLogbookStorage();
        entries = [...st, ...entries];

        // 2) quando arquivos (ou qualquer coisa) atualizar o log, re-carrega do storage
        window.addEventListener("gomap:logbook-updated", () => {
          const latest = window.readLogbookStorage();
          entries = [...latest, ...entries.filter(e => !String(e.id || "").startsWith("LG-"))];
          refresh();
        });

        el.apply.addEventListener("click", refresh);

        el.clear.addEventListener("click", () => {
          el.search.value = "";
          el.fActor.value = "all";
          el.fType.value = "all";
          el.fSource.value = "all";
          refresh();
        });

        el.search.addEventListener("input", () => {
          clearTimeout(el.search._t);
          el.search._t = setTimeout(refresh, 150);
        });

        el.addAttachToggle.addEventListener("click", () => {
          const cur = (el.addFileName.value || "").trim();
          el.addFileName.value = cur ? "" : "evidencia-integracao.pdf";
        });

        el.addSave.addEventListener("click", addEntryFromModal);

        wireHandlers();
        refresh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

</body>
</html>
