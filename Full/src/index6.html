@@include('./partials/html.html')

<head>
  @@include("./partials/title-meta.html", {"title": "Visualizar"})
  @@include('./partials/head-css.html')

  <style>
    .vertical-timeline { position: relative; padding-left: 30px; }
    .vertical-timeline::before { content: ''; position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e9ecef; }
    .timeline-item { position: relative; margin-bottom: 20px; }
    .timeline-marker { position: absolute; left: -22px; top: 5px; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #fff; }
    .timeline-marker.done { background: #198754; }
    .timeline-marker.ongoing { background: #ffc107; }
    .timeline-marker.future { background: #6c757d; }
    .timeline-content { background: #f8f9fa; padding: 10px; border-radius: 4px; border-left: 3px solid #dee2e6; }
  
    /* Captação de recursos */
    .funding-required-hint { font-size: .75rem; color: #6c757d; }
    #funding-proposal-modal .is-invalid { border-color: #dc3545; }

</style>
</head>

<body>
  <div class="wrapper">

    @@include('./partials/menu.html')

    <div class="content-page">
      <div class="content">
        <div class="container-fluid p-0 min-vh-100">

          @@include("./partials/page-title.html", {"subtitle": "Portal de projetos", "title":"Visualizar projeto"})

          <div class="row g-0 min-vh-100 w-100">
            <div class="col-xxl-12">

              <div class="card card-h-100 rounded-0 rounded-start">
                <div class="card-header p-4">
                  <div class="d-flex align-items-center justify-content-between w-100">

                    <div class="d-flex align-items-center gap-3">
                      <div>
                        <h3 class="mb-1 fw-semibold">0006 – Integração de Sistemas de Pagamento</h3>
                        <div class="d-flex align-items-center gap-2">
                          <span class="badge badge-soft-primary fs-xxs">Execução</span>
                          <span class="text-muted">•</span>
                          <span class="badge badge-soft-success fs-xxs">Em andamento</span>
                          <span class="text-muted">•</span>
                          <div class="d-flex align-items-center gap-2">
                            <img src="assets/images/users/user-3.jpg" alt="Luciene Martins" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" />
                            <span class="fw-medium">Luciene Martins</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="d-flex align-items-center gap-2 ms-auto">
                      <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          Ações
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                          <li><a class="dropdown-item" href="#"><i class="ti ti-edit me-2"></i>Editar projeto</a></li>
                          <li><a class="dropdown-item" href="#"><i class="ti ti-message-chatbot me-2"></i>EvA Chat</a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item disabled" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-clipboard-check me-2"></i>Iniciar planejamento</a></li>
                          <li><a class="dropdown-item disabled" href="#" tabindex="-1" aria-disabled="true"><i class="ti ti-file-text me-2"></i>Gerar TAP</a></li>
                        </ul>
                      </div>
                    </div>

                  </div>
                </div>

                <div class="card-body px-4">

                  <ul class="nav nav-tabs nav-bordered mb-3" role="tablist">
                    <li class="nav-item">
                      <a class="nav-link active" data-bs-toggle="tab" href="#tab-overview" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Visão geral</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-schedule" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Cronograma</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-monitoring" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Monitoramento</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-governance" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Governança</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-funding" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Captação de recursos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-risks" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Riscos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-files" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Arquivos</span>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a class="nav-link" data-bs-toggle="tab" href="#tab-logbook" role="tab">
                        <span class="d-none d-md-inline-block align-middle">Diário de bordo</span>
                      </a>
                    </li>
                  </ul>

                  <div class="tab-content">

                    <!-- TAB VISÃO GERAL (VISUALIZAÇÃO APENAS / SEM HEADER) -->
<div class="tab-pane active" id="tab-overview" role="tabpanel">

  <!-- Cards: Situação do cronograma -->
  <div class="row g-2">
    <div class="col-12 col-sm-6 col-lg">
      <div class="card m-1 h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="avatar-md flex-shrink-0">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-calendar-stats fs-3"></i>
            </span>
          </div>
          <div class="min-w-0">
            <div class="text-muted fs-12">Situação do cronograma</div>
            <div class="fw-semibold text-truncate">No prazo</div>
            <div class="text-muted fs-12">Baseline e status da execução</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg">
      <div class="card m-1 h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="avatar-md flex-shrink-0">
            <span class="avatar-title rounded-circle bg-primary bg-opacity-10 text-primary">
              <i class="ti ti-calendar-event fs-3"></i>
            </span>
          </div>
          <div class="min-w-0">
            <div class="text-muted fs-12">Data de início</div>
            <div class="fw-semibold text-truncate">15/09/2025</div>
            <div class="text-muted fs-12">Início aprovado</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg">
      <div class="card m-1 h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="avatar-md flex-shrink-0">
            <span class="avatar-title rounded-circle bg-success bg-opacity-10 text-success">
              <i class="ti ti-calendar-check fs-3"></i>
            </span>
          </div>
          <div class="min-w-0">
            <div class="text-muted fs-12">Previsão de conclusão</div>
            <div class="fw-semibold text-truncate">14/02/2026</div>
            <div class="text-muted fs-12">Baseline atual</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-sm-6 col-lg">
      <div class="card m-1 h-100">
        <div class="card-body d-flex align-items-center gap-3">
          <div class="avatar-md flex-shrink-0">
            <span class="avatar-title rounded-circle bg-warning bg-opacity-10 text-warning">
              <i class="ti ti-clock fs-3"></i>
            </span>
          </div>
          <div class="min-w-0">
            <div class="text-muted fs-12">Dias restantes</div>
            <div class="fw-semibold text-truncate">42 dias</div>
            <div class="text-muted fs-12">Até a previsão</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-3">
      <div class="card m-1 h-100">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
            <div class="min-w-0">
              <div class="text-muted fs-12">Progresso físico</div>
              <div class="fw-semibold">45%</div>
              <div class="text-muted fs-12">Execução física consolidada</div>
            </div>
            <div class="avatar-md flex-shrink-0">
              <span class="avatar-title rounded-circle bg-info bg-opacity-10 text-info">
                <i class="ti ti-progress fs-3"></i>
              </span>
            </div>
          </div>
          <div class="progress bg-info bg-opacity-25 progress-sm mb-0">
            <div class="progress-bar bg-info" role="progressbar" style="width:45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex justify-content-between mt-2 text-muted fs-12">
            <span>Marcos: 2/4</span>
            <span>Atividades: 6</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Blocos executivos: Resumo da execução + Progresso financeiro -->
  <div class="row g-2 mt-1">
    <div class="col-12 col-xl-6">
      <div class="card m-1 h-100">
        <div class="card-header border-light d-flex align-items-center justify-content-between">
          <div>
            <h6 class="mb-0">Resumo da execução</h6>
            <div class="text-muted fs-12">Indicadores automáticos do cronograma/monitoramento</div>
          </div>
          <a href="#tab-monitoring" class="text-muted fs-12" data-bs-toggle="tab">Ver monitoramento</a>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between py-2">
            <div class="text-muted">Concluídas</div>
            <div class="fw-semibold">3</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted">Em andamento</div>
            <div class="fw-semibold">2</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted">Atrasadas</div>
            <div class="fw-semibold text-danger">1</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted">Futuras (próx. 30 dias)</div>
            <div class="fw-semibold">2</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-6">
      <div class="card m-1 h-100">
        <div class="card-header border-light d-flex align-items-center justify-content-between">
          <div>
            <h6 class="mb-0">Progresso financeiro</h6>
            <div class="text-muted fs-12">Valores consolidados do acompanhamento financeiro</div>
          </div>
          <a href="#tab-governance" class="text-muted fs-12" data-bs-toggle="tab">Ver governança</a>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between py-2">
            <div class="text-muted">Empenhado</div>
            <div class="fw-semibold">R$ 1.000.000,00</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted">Liquidado</div>
            <div class="fw-semibold">R$ 800.000,00</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted">Pago</div>
            <div class="fw-semibold">R$ 600.000,00</div>
          </div>
          <div class="d-flex align-items-center justify-content-between py-2 border-top">
            <div class="text-muted fw-medium">Valor total do projeto</div>
            <div class="fw-bold">R$ 2.000.000,00</div>
          </div>

          <div class="progress bg-primary bg-opacity-25 progress-sm mt-3 mb-0">
            <div class="progress-bar bg-primary" role="progressbar" style="width:30%" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex justify-content-between mt-2 text-muted fs-12">
            <span>Execução financeira</span>
            <span>30%</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Ficha do projeto (VISUALIZAÇÃO / accordion) -->
  <div class="card m-1 mt-2">
    <div class="card-header border-light">
      <h6 class="mb-0">Ficha do projeto</h6>
      <div class="text-muted fs-12">Informações institucionais do cadastro</div>
    </div>

    <div class="card-body p-0">

      
    <div class="p-3 border-bottom" data-funding-summary>
      <div class="row g-2">
        <div class="col-6 col-xl-3">
          <div class="p-3 rounded border border-dashed h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Em Planejamento</div>
                <div class="fs-3 fw-semibold mb-0" data-funding-card-count="planning">0</div>
              </div>
              <span class="avatar-sm">
                <span class="avatar-title rounded-circle bg-soft-primary text-primary">
                  <i class="ti ti-file-text"></i>
                </span>
              </span>
            </div>
          </div>
        </div>

        <div class="col-6 col-xl-3">
          <div class="p-3 rounded border border-dashed h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Em Articulação</div>
                <div class="fs-3 fw-semibold mb-0" data-funding-card-count="articulation">0</div>
              </div>
              <span class="avatar-sm">
                <span class="avatar-title rounded-circle bg-soft-info text-info">
                  <i class="ti ti-arrows-shuffle"></i>
                </span>
              </span>
            </div>
          </div>
        </div>

        <div class="col-6 col-xl-3">
          <div class="p-3 rounded border border-dashed h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Em Formalização</div>
                <div class="fs-3 fw-semibold mb-0" data-funding-card-count="formalization">0</div>
              </div>
              <span class="avatar-sm">
                <span class="avatar-title rounded-circle bg-soft-warning text-warning">
                  <i class="ti ti-file-certificate"></i>
                </span>
              </span>
            </div>
          </div>
        </div>

        <div class="col-6 col-xl-3">
          <div class="p-3 rounded border border-dashed h-100">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="text-muted small">Em Execução</div>
                <div class="fs-3 fw-semibold mb-0" data-funding-card-count="execution">0</div>
              </div>
              <span class="avatar-sm">
                <span class="avatar-title rounded-circle bg-soft-success text-success">
                  <i class="ti ti-progress-check"></i>
                </span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex flex-wrap align-items-center gap-2 mt-3">
        <div class="app-search" style="flex: 1 1 auto; min-width: 260px;">
          <input type="search" class="form-control" placeholder="Buscar proposta por nome ou ID" data-funding-search>
          <i class="ti ti-search app-search-icon text-muted"></i>
        </div>

        <select class="form-select" style="width: 240px;" data-funding-status-filter>
          <option value="all">Todos os status</option>
          <option value="planning">Em Planejamento</option>
          <option value="articulation">Em Articulação</option>
          <option value="formalization">Em Formalização</option>
          <option value="execution">Em Execução</option>
          <option value="archived">Arquivadas</option>
        </select>
      </div>
    </div>

<!-- 1) Identificação do projeto -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-ident" aria-expanded="true">
          <span class="fw-semibold">Identificação do projeto</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-ident" class="collapse show">
          <div class="px-4 pb-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Código</div>
                <div class="fw-medium">0006</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Projeto</div>
                <div class="fw-medium">Integração de Sistemas de Pagamento</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Programa</div>
                <div class="fw-medium">Governo Digital</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Iniciativa</div>
                <div class="fw-medium">Modernização de meios de pagamento</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Órgão proponente</div>
                <div class="fw-medium">SEAD</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Órgão executor</div>
                <div class="fw-medium">SEAD / SGG</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Fase</div>
                <div class="fw-medium">Execução</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Situação</div>
                <div class="fw-medium">Em andamento</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2) Escopo -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-scope" aria-expanded="false">
          <span class="fw-semibold">Escopo</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-scope" class="collapse">
          <div class="px-4 pb-4">
            <div class="row g-3">
              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Justificativa e problema</div>
                <div class="text-muted">
                  Centralizar e padronizar integrações de pagamento (PIX e cartão), reduzindo falhas operacionais e divergências
                  na conciliação entre sistemas.
                </div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Benefícios esperados</div>
                <div class="text-muted">
                  Rastreabilidade ponta a ponta, relatórios automáticos, redução de divergências e melhoria no tempo de liquidação.
                </div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Objetivo (escopo)</div>
                <div class="text-muted">
                  Implementar integrações via APIs/webhooks, padronizar eventos, garantir idempotência e disponibilizar conciliação automática.
                </div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Público-alvo</div>
                <div class="text-muted">Órgãos executores, unidades financeiras, fornecedores/operadores de pagamento e usuários internos.</div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Exclusões (não escopo)</div>
                <div class="text-muted">Mudanças de regras contábeis e reestruturação de sistemas legados além dos pontos de integração.</div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Premissas</div>
                <div class="text-muted">Disponibilidade do provedor, homologação em ambiente controlado e acesso aos logs e relatórios.</div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Restrições</div>
                <div class="text-muted">Janelas de manutenção, LGPD, performance em horário de pico e integração com sistemas existentes.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 3) Alinhamento estratégico -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-strategy" aria-expanded="false">
          <span class="fw-semibold">Alinhamento estratégico</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-strategy" class="collapse">
          <div class="px-4 pb-4">
            <div class="row g-3">
              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Classificações</div>
                <div class="d-flex flex-wrap gap-2">
                  <span class="badge badge-soft-primary">CLP - Governo Digital</span>
                  <span class="badge badge-soft-primary">CLP - Eficiência</span>
                  <span class="badge badge-soft-primary">CLP - Transformação</span>
                </div>
              </div>

              <div class="col-12 col-xl-6">
                <div class="text-muted fs-12 mb-1">Priorização</div>
                <div class="fw-medium">Emergencial</div>
                <div class="text-muted fs-12">Critério: impacto em arrecadação e continuidade operacional</div>
              </div>

              <div class="col-12">
                <div class="text-muted fs-12 mb-1">Compromissos</div>
                <div class="text-muted">Melhorar conciliação e rastreabilidade de pagamentos digitais no portfólio do Governo Digital.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 4) Vinculação ao PPA -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-ppa" aria-expanded="false">
          <span class="fw-semibold">Vinculação ao PPA</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-ppa" class="collapse">
          <div class="px-4 pb-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Eixo</div>
                <div class="fw-medium">Governo Digital</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Programa PPA</div>
                <div class="fw-medium">Modernização Administrativa</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Órgão do PPA</div>
                <div class="fw-medium">SEAD</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Possui entrega vinculada</div>
                <div class="fw-medium">Sim</div>
              </div>

              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Entrega</div>
                <div class="fw-medium">Integração e conciliação de pagamentos digitais</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Unidade de medida</div>
                <div class="fw-medium">Integrações concluídas</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 5) Localidade -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-loc" aria-expanded="false">
          <span class="fw-semibold">Localidade</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-loc" class="collapse">
          <div class="px-4 pb-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Município</div>
                <div class="fw-medium">Goiânia</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Região</div>
                <div class="fw-medium">Centro-Oeste</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Latitude</div>
                <div class="fw-medium">-16.6745</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Longitude</div>
                <div class="fw-medium">-49.2560</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 6) Órgãos e stakeholders -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-stk" aria-expanded="false">
          <span class="fw-semibold">Órgãos e stakeholders</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-stk" class="collapse">
          <div class="px-4 pb-4">
            <div class="text-muted fs-12 mb-2">Quem participa, apoia e é impactado pelo projeto</div>

            <div class="table-responsive">
              <table class="table table-custom table-centered w-100 mb-0">
                <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                  <tr class="text-uppercase fs-xxs">
                    <th style="width:1%;">Tipo</th>
                    <th>Órgão</th>
                    <th style="width:1%;">Sigla</th>
                    <th style="width:1%;">CNPJ</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td><span class="badge badge-soft-primary fs-xxs">Proponente</span></td>
                    <td>Secretaria de Administração</td>
                    <td class="text-muted">SEAD</td>
                    <td class="text-muted">00000000000000</td>
                  </tr>
                  <tr>
                    <td><span class="badge badge-soft-secondary fs-xxs">Executor</span></td>
                    <td>Secretaria-Geral do Governo</td>
                    <td class="text-muted">SGG</td>
                    <td class="text-muted">00000000000000</td>
                  </tr>
                  <tr>
                    <td><span class="badge badge-soft-success fs-xxs">Apoio</span></td>
                    <td>Secretaria da Economia</td>
                    <td class="text-muted">ECON</td>
                    <td class="text-muted">00000000000000</td>
                  </tr>
                  <tr>
                    <td><span class="badge badge-soft-warning fs-xxs">Fornecedor</span></td>
                    <td>Provedor de Pagamentos (fictício)</td>
                    <td class="text-muted">PAY</td>
                    <td class="text-muted">00000000000000</td>
                  </tr>
                </tbody>
              </table>
            </div>

          </div>
        </div>
      </div>

      <!-- 7) Processos e integrações -->
      <div class="border-top">
        <button class="btn w-100 text-start d-flex align-items-center justify-content-between px-4 py-3"
                type="button" data-bs-toggle="collapse" data-bs-target="#ov-proc" aria-expanded="false">
          <span class="fw-semibold">Processos e integrações</span>
          <i class="ti ti-chevron-down"></i>
        </button>

        <div id="ov-proc" class="collapse">
          <div class="px-4 pb-4">
            <div class="text-muted fs-12 mb-2">Links de processo, contratos e integrações relacionadas</div>

            <div class="row g-3">
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Processo SEI</div>
                <div class="fw-medium">12345678901234567890</div>
              </div>
              <div class="col-12 col-md-6">
                <div class="text-muted fs-12 mb-1">Contrato / Instrumento</div>
                <div class="fw-medium">CT-0006/2025 (fictício)</div>
              </div>

              <div class="col-12">
                <div class="text-muted fs-12 mb-1">Sistemas integrados</div>
                <div class="d-flex flex-wrap gap-2">
                  <span class="badge badge-soft-dark">Portal de Serviços</span>
                  <span class="badge badge-soft-dark">Gateway de Pagamento</span>
                  <span class="badge badge-soft-dark">Conciliação</span>
                  <span class="badge badge-soft-dark">Backoffice Financeiro</span>
                </div>
              </div>

              <div class="col-12">
                <div class="text-muted fs-12 mb-1">Observação</div>
                <div class="text-muted">Eventos via webhooks (PIX/cartão) com idempotência e trilha de auditoria.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>


                    <!-- TAB CRONOGRAMA -->
<div class="tab-pane" id="tab-schedule" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Cronograma</h5>
          <div class="text-muted fs-12">Planejamento de marcos e atividades do projeto. (Protótipo UI)</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="ti ti-plus me-1"></i>Adicionar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="schAddMilestone"><i class="ti ti-flag me-2"></i>Marco</a></li>
              <li><a class="dropdown-item" href="#" id="schAddActivity"><i class="ti ti-checklist me-2"></i>Atividade</a></li>
            </ul>
          </div>

          <div class="btn-group">
            <button type="button" class="btn btn-light" id="schViewTimeline">
              <i class="ti ti-timeline me-1"></i>Linha do tempo
            </button>
            <button type="button" class="btn btn-light" id="schViewTable">
              <i class="ti ti-list-details me-1"></i>Lista
            </button>
          </div>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="schReplan"><i class="ti ti-calendar-time me-2"></i>Replanejar</a></li>
              <li><a class="dropdown-item" href="#" id="schExport"><i class="ti ti-download me-2"></i>Exportar</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="schReset"><i class="ti ti-refresh me-2"></i>Resetar cronograma (protótipo)</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Filtros (barra única, igual ao padrão que você queria) -->
      <div class="card mb-3 border">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-end gap-2">

            <div style="min-width: 280px; flex: 1 1 360px;">
              <label class="form-label">Buscar</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ti ti-search"></i></span>
                <input type="text" class="form-control" id="schSearch" placeholder="Buscar por nome, responsável..." />
              </div>
            </div>

            <div style="min-width: 190px; flex: 0 0 190px;">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="schFilterType">
                <option value="all" selected>Todos</option>
                <option value="MILESTONE">Marcos</option>
                <option value="ACTIVITY">Atividades</option>
              </select>
            </div>

            <div style="min-width: 190px; flex: 0 0 190px;">
              <label class="form-label">Status</label>
              <select class="form-select" id="schFilterStatus">
                <option value="all" selected>Todos</option>
                <option value="PLANNED">Planejado</option>
                <option value="ONGOING">Em andamento</option>
                <option value="DONE">Concluído</option>
                <option value="DELAYED">Atrasado</option>
              </select>
            </div>

            <div style="min-width: 220px; flex: 0 0 220px;">
              <label class="form-label">Responsável</label>
              <select class="form-select" id="schFilterOwner">
                <option value="all" selected>Todos</option>
                <option value="luciene">Luciene Martins</option>
                <option value="joao">João Santos</option>
                <option value="maria">Maria Silva</option>
                <option value="leonardo">Leonardo Queiroz</option>
                <option value="sistema">Sistema GoMAP</option>
              </select>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="schApply">
                <i class="ti ti-filter me-1"></i>Filtrar
              </button>
              <button type="button" class="btn btn-light" id="schClear">
                <i class="ti ti-rotate-2 me-1"></i>Limpar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Empty -->
      <div id="schEmpty" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-calendar-x fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhum item encontrado</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todo o cronograma.</div>
        </div>
      </div>

      <!-- Views -->
      <div id="schTimelineView">
        <div class="vertical-timeline" id="schTimeline"></div>
      </div>

      <div id="schTableView" class="d-none">
        <div class="table-responsive">
          <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
            <thead class="bg-light align-middle bg-opacity-25 thead-sm">
              <tr class="text-uppercase fs-xxs">
                <th style="width:1%;">Tipo</th>
                <th>Nome</th>
                <th style="width:1%;">Marco</th>
                <th style="width:1%;">Responsável</th>
                <th style="width:1%;">Início</th>
                <th style="width:1%;">Fim</th>
                <th style="width:1%;">Status</th>
                <th style="width:1%;">Progresso</th>
                <th class="text-center" style="width:1%;">Ações</th>
              </tr>
            </thead>
            <tbody id="schTbody"></tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Marco/Atividade -->
<div class="modal fade" id="schModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="schModalTitle">Adicionar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="schFormId" value="" />
        <input type="hidden" id="schFormType" value="MILESTONE" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="schFormName" placeholder="Ex.: Homologação PIX + Cartão" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="schFormStatus">
              <option value="PLANNED" selected>Planejado</option>
              <option value="ONGOING">Em andamento</option>
              <option value="DONE">Concluído</option>
              <option value="DELAYED">Atrasado</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Progresso (%)</label>
            <input type="number" class="form-control" id="schFormProgress" min="0" max="100" value="0" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Responsável</label>
            <select class="form-select" id="schFormOwner">
              <option value="luciene" selected>Luciene Martins</option>
              <option value="joao">João Santos</option>
              <option value="maria">Maria Silva</option>
              <option value="leonardo">Leonardo Queiroz</option>
              <option value="sistema">Sistema GoMAP</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Início</label>
            <input type="date" class="form-control" id="schFormStart" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Fim</label>
            <input type="date" class="form-control" id="schFormEnd" />
          </div>

          <!-- Só aparece quando for ATIVIDADE -->
          <div class="col-12 d-none" id="schFormMilestoneWrap">
            <label class="form-label">Marco</label>
            <select class="form-select" id="schFormMilestone"></select>
            <div class="text-muted fs-12 mt-1">Atividades precisam estar vinculadas a um marco.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Descrição (opcional)</label>
            <textarea class="form-control" id="schFormDesc" rows="3" placeholder="Observações do item..."></textarea>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="schFormSave">
          <i class="ti ti-device-floppy me-1"></i>Salvar
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  const KEY = "gomap_schedule_0006";

  const actors = {
    luciene: { key:"luciene", name:"Luciene Martins" },
    joao: { key:"joao", name:"João Santos" },
    maria: { key:"maria", name:"Maria Silva" },
    leonardo: { key:"leonardo", name:"Leonardo Queiroz" },
    sistema: { key:"sistema", name:"Sistema GoMAP" }
  };

  const statusMeta = {
    PLANNED: { label:"Planejado", badge:"badge-soft-secondary", marker:"future" },
    ONGOING: { label:"Em andamento", badge:"badge-soft-primary", marker:"ongoing" },
    DONE: { label:"Concluído", badge:"badge-soft-success", marker:"done" },
    DELAYED: { label:"Atrasado", badge:"badge-soft-danger", marker:"future" }
  };

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function read(){
    try {
      const raw = localStorage.getItem(KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch(e){ return []; }
  }

  function write(list){
    localStorage.setItem(KEY, JSON.stringify(list || []));
  }

  function seedIfEmpty(){
    const cur = read();
    if (cur.length) return cur;

    const seeded = [
      { id:"MS-001", type:"MILESTONE", name:"Definição do provedor e modelo de integração", owner:"luciene", status:"DONE", progress:100, start:"2025-11-01", end:"2025-11-20", desc:"Escolha do provedor com suporte a PIX, cartão, webhooks e conciliação." },
      { id:"MS-002", type:"MILESTONE", name:"Homologação PIX + Cartão", owner:"maria", status:"DONE", progress:100, start:"2025-12-01", end:"2025-12-18", desc:"Casos aprovados/recusados, cancelamento, estorno e conciliação por arquivo." },
      { id:"MS-003", type:"MILESTONE", name:"Estabilização de Webhooks (idempotência)", owner:"joao", status:"ONGOING", progress:70, start:"2025-12-20", end:"2026-02-05", desc:"Padronização de eventos e tratamento de duplicidade." },
      { id:"MS-004", type:"MILESTONE", name:"Go-live controlado", owner:"luciene", status:"PLANNED", progress:0, start:"2026-02-06", end:"2026-02-20", desc:"Virada com monitoramento e rollback plan." },

      { id:"AC-101", type:"ACTIVITY", milestoneId:"MS-003", name:"Mapa de eventos + contrato de payload", owner:"joao", status:"DONE", progress:100, start:"2025-12-20", end:"2026-01-05", desc:"Eventos: payment.created/confirmed/failed/refund/chargeback." },
      { id:"AC-102", type:"ACTIVITY", milestoneId:"MS-003", name:"Implementar idempotência por chave de transação", owner:"joao", status:"ONGOING", progress:70, start:"2026-01-06", end:"2026-01-30", desc:"Tabela de chaves processadas + retentativa com backoff." },
      { id:"AC-103", type:"ACTIVITY", milestoneId:"MS-003", name:"Monitoramento e alertas (SLA provedor)", owner:"leonardo", status:"PLANNED", progress:0, start:"2026-01-25", end:"2026-02-05", desc:"Circuit breaker, métricas e alarmes." },
      { id:"AC-201", type:"ACTIVITY", milestoneId:"MS-004", name:"Checklist de produção + evidências", owner:"luciene", status:"PLANNED", progress:0, start:"2026-02-06", end:"2026-02-12", desc:"Checklist go-live e evidências de homologação." }
    ];

    write(seeded);
    return seeded;
  }

  // (opcional) log no diário, se existir
  function logbook(type, title, desc){
    try{
      if (typeof window.addLogbookEntry !== "function") return;
      window.addLogbookEntry({
        id: `LG-${String(Math.floor(Math.random()*900)+100)}`,
        createdAt: new Date().toISOString(),
        type: "NOTE",
        title,
        description: desc,
        actorKey: "luciene",
        source: "manual",
        tags: ["Cronograma", type],
        attachments: []
      });
    }catch(e){}
  }

  const el = {
    search: document.getElementById("schSearch"),
    fType: document.getElementById("schFilterType"),
    fStatus: document.getElementById("schFilterStatus"),
    fOwner: document.getElementById("schFilterOwner"),
    apply: document.getElementById("schApply"),
    clear: document.getElementById("schClear"),
    empty: document.getElementById("schEmpty"),

    viewTimeline: document.getElementById("schViewTimeline"),
    viewTable: document.getElementById("schViewTable"),
    timelineView: document.getElementById("schTimelineView"),
    tableView: document.getElementById("schTableView"),

    timeline: document.getElementById("schTimeline"),
    tbody: document.getElementById("schTbody"),

    addMilestone: document.getElementById("schAddMilestone"),
    addActivity: document.getElementById("schAddActivity"),

    replan: document.getElementById("schReplan"),
    exportBtn: document.getElementById("schExport"),
    reset: document.getElementById("schReset"),

    // modal
    modal: document.getElementById("schModal"),
    modalTitle: document.getElementById("schModalTitle"),
    formId: document.getElementById("schFormId"),
    formType: document.getElementById("schFormType"),
    formName: document.getElementById("schFormName"),
    formStatus: document.getElementById("schFormStatus"),
    formProgress: document.getElementById("schFormProgress"),
    formOwner: document.getElementById("schFormOwner"),
    formStart: document.getElementById("schFormStart"),
    formEnd: document.getElementById("schFormEnd"),
    formDesc: document.getElementById("schFormDesc"),
    formMilestoneWrap: document.getElementById("schFormMilestoneWrap"),
    formMilestone: document.getElementById("schFormMilestone"),
    formSave: document.getElementById("schFormSave"),
  };

  let items = seedIfEmpty();

  function getMilestones(){
    return items.filter(x => x.type === "MILESTONE").sort((a,b)=> (a.start||"").localeCompare(b.start||""));
  }

  function fillMilestoneSelect(selectedId){
    const list = getMilestones();
    el.formMilestone.innerHTML = "";
    list.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      el.formMilestone.appendChild(opt);
    });
    if (selectedId) el.formMilestone.value = selectedId;
    if (!selectedId && list[0]) el.formMilestone.value = list[0].id;
  }

  function getFiltered(){
    const q = (el.search.value||"").trim().toLowerCase();
    const type = el.fType.value || "all";
    const status = el.fStatus.value || "all";
    const owner = el.fOwner.value || "all";

    return items
      .slice()
      .sort((a,b)=> (a.start||"").localeCompare(b.start||""))
      .filter(x=>{
        const blob = [
          x.id, x.type, x.name, x.desc, actors[x.owner]?.name || "",
          x.status, x.progress, x.start, x.end,
          (x.milestoneId ? (items.find(m=>m.id===x.milestoneId)?.name || "") : "")
        ].join(" ").toLowerCase();

        const okQ = !q || blob.includes(q);
        const okT = type === "all" || x.type === type;
        const okS = status === "all" || x.status === status;
        const okO = owner === "all" || x.owner === owner;
        return okQ && okT && okS && okO;
      });
  }

  function badgeStatus(st){
    const m = statusMeta[st] || { label: st, badge:"badge-soft-secondary" };
    return `<span class="badge ${esc(m.badge)} fs-xxs">${esc(m.label)}</span>`;
  }

  function fmt(d){
    if (!d) return "—";
    const [y,m,dd] = String(d).split("-");
    if (!y||!m||!dd) return d;
    return `${dd}/${m}/${y}`;
  }

  function render(){
    const list = getFiltered();
    el.empty.classList.toggle("d-none", list.length > 0);

    // Timeline (agrupa por marco)
    const miles = getMilestones();
    const byMilestone = new Map();
    miles.forEach(m => byMilestone.set(m.id, []));
    list.filter(x=>x.type==="ACTIVITY").forEach(a=>{
      if (!byMilestone.has(a.milestoneId)) byMilestone.set(a.milestoneId, []);
      byMilestone.get(a.milestoneId).push(a);
    });

    // linha do tempo: mostra milestones sempre; activities somente se passam no filtro
    el.timeline.innerHTML = "";
    miles.forEach(m=>{
      if (el.fType.value === "ACTIVITY") {
        // se filtro for só atividade, não renderiza marco sem atividades visíveis
        const acts = (byMilestone.get(m.id) || []).filter(a => list.some(v=>v.id===a.id));
        if (!acts.length) return;
      }

      const meta = statusMeta[m.status] || { marker:"future" };
      const markerClass = meta.marker;

      const wrap = document.createElement("div");
      wrap.className = "timeline-item";
      wrap.innerHTML = `
        <span class="timeline-marker ${esc(markerClass)}"></span>
        <div class="timeline-content">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="text-truncate" style="max-width: 70%;" title="${esc(m.name)}">
              <div class="fw-semibold">${esc(m.name)}</div>
              <div class="text-muted fs-12 text-nowrap">
                ${badgeStatus(m.status)}
                <span class="text-muted">•</span>
                <span>${esc(actors[m.owner]?.name || "—")}</span>
                <span class="text-muted">•</span>
                <span>${esc(fmt(m.start))} → ${esc(fmt(m.end))}</span>
              </div>
            </div>

            <div class="d-flex align-items-center gap-2">
              <div class="text-muted fs-12 text-nowrap">${esc(m.progress||0)}%</div>
              <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(m.id)}" title="Editar">
                <i class="ti ti-edit"></i>
              </button>
              <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(m.id)}" title="Excluir">
                <i class="ti ti-trash"></i>
              </button>
            </div>
          </div>

          <div class="mt-2">
            <div class="progress bg-primary bg-opacity-25 progress-sm mb-0">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${Math.max(0, Math.min(100, Number(m.progress||0)))}%"></div>
            </div>
          </div>

          <div class="text-muted mt-2">${esc(m.desc || "")}</div>

          <div class="mt-3">
            ${(byMilestone.get(m.id) || []).filter(a => list.some(v=>v.id===a.id)).map(a=>{
              const am = statusMeta[a.status] || { badge:"badge-soft-secondary" };
              return `
                <div class="d-flex align-items-center justify-content-between gap-2 py-2 border-top">
                  <div class="text-truncate" style="max-width: 70%;" title="${esc(a.name)}">
                    <div class="fw-medium">${esc(a.name)}</div>
                    <div class="text-muted fs-12 text-nowrap">
                      <span class="badge ${esc(am.badge)} fs-xxs">${esc(am.label)}</span>
                      <span class="text-muted">•</span>
                      <span>${esc(actors[a.owner]?.name || "—")}</span>
                      <span class="text-muted">•</span>
                      <span>${esc(fmt(a.start))} → ${esc(fmt(a.end))}</span>
                    </div>
                  </div>

                  <div class="d-flex align-items-center gap-2">
                    <div class="text-muted fs-12 text-nowrap">${esc(a.progress||0)}%</div>
                    <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(a.id)}" title="Editar">
                      <i class="ti ti-edit"></i>
                    </button>
                    <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(a.id)}" title="Excluir">
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;
      el.timeline.appendChild(wrap);
    });

    // Tabela (somente itens filtrados)
    el.tbody.innerHTML = "";
    list.forEach(x=>{
      const isMilestone = x.type === "MILESTONE";
      const typeLabel = isMilestone ? `<span class="badge badge-soft-success fs-xxs">Marco</span>` : `<span class="badge badge-soft-primary fs-xxs">Atividade</span>`;
      const milestoneName = !isMilestone ? (items.find(m=>m.id===x.milestoneId)?.name || "—") : "—";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${typeLabel}</td>

        <td>
          <div class="fw-medium text-truncate" style="max-width: 520px;" title="${esc(x.name)}">${esc(x.name)}</div>
          ${x.desc ? `<div class="text-muted fs-12 text-truncate" style="max-width: 520px;" title="${esc(x.desc)}">${esc(x.desc)}</div>` : ``}
        </td>

        <td class="text-muted text-truncate" style="max-width: 260px;" title="${esc(milestoneName)}">${esc(milestoneName)}</td>
        <td class="text-muted">${esc(actors[x.owner]?.name || "—")}</td>
        <td class="text-muted">${esc(fmt(x.start))}</td>
        <td class="text-muted">${esc(fmt(x.end))}</td>
        <td>${badgeStatus(x.status)}</td>

        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="text-muted fs-12">${esc(x.progress||0)}%</div>
            <div class="progress bg-primary bg-opacity-25 progress-sm flex-grow-1 mb-0" style="min-width:120px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${Math.max(0, Math.min(100, Number(x.progress||0)))}%"></div>
            </div>
          </div>
        </td>

        <td class="text-center">
          <div class="d-flex justify-content-center gap-1">
            <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(x.id)}" title="Editar">
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(x.id)}" title="Excluir">
              <i class="ti ti-trash"></i>
            </button>
          </div>
        </td>
      `;
      el.tbody.appendChild(tr);
    });
  }

  function setView(view){
    const isTimeline = view === "timeline";
    el.timelineView.classList.toggle("d-none", !isTimeline);
    el.tableView.classList.toggle("d-none", isTimeline);

    el.viewTimeline.classList.toggle("btn-primary", isTimeline);
    el.viewTimeline.classList.toggle("btn-light", !isTimeline);

    el.viewTable.classList.toggle("btn-primary", !isTimeline);
    el.viewTable.classList.toggle("btn-light", isTimeline);
  }

  function openModal(type, id){
    el.formType.value = type;
    el.formId.value = id || "";

    const isActivity = type === "ACTIVITY";
    el.formMilestoneWrap.classList.toggle("d-none", !isActivity);

    fillMilestoneSelect();

    if (!id){
      el.modalTitle.textContent = (type === "MILESTONE") ? "Adicionar marco" : "Adicionar atividade";
      el.formName.value = "";
      el.formStatus.value = "PLANNED";
      el.formProgress.value = 0;
      el.formOwner.value = "luciene";
      el.formDesc.value = "";

      // defaults de data
      const d = new Date();
      const plus = (n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
      el.formStart.value = plus(3);
      el.formEnd.value = plus(15);

      if (isActivity){
        const firstMs = getMilestones()[0];
        fillMilestoneSelect(firstMs?.id);
      }
    } else {
      const item = items.find(x=>x.id===id);
      if (!item) return;

      el.modalTitle.textContent = (item.type === "MILESTONE") ? `Editar marco — ${item.id}` : `Editar atividade — ${item.id}`;
      el.formName.value = item.name || "";
      el.formStatus.value = item.status || "PLANNED";
      el.formProgress.value = Number(item.progress||0);
      el.formOwner.value = item.owner || "luciene";
      el.formStart.value = item.start || "";
      el.formEnd.value = item.end || "";
      el.formDesc.value = item.desc || "";

      if (item.type === "ACTIVITY"){
        fillMilestoneSelect(item.milestoneId);
      }
    }

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.show();
    }catch(e){}
  }

  function saveModal(){
    const id = (el.formId.value||"").trim();
    const type = el.formType.value;
    const name = (el.formName.value||"").trim();
    const status = el.formStatus.value;
    const progress = Math.max(0, Math.min(100, Number(el.formProgress.value||0)));
    const owner = el.formOwner.value;
    const start = el.formStart.value;
    const end = el.formEnd.value;
    const desc = (el.formDesc.value||"").trim();

    if (!name){
      alert("Preencha o nome.");
      return;
    }

    if (type === "ACTIVITY"){
      const milestoneId = el.formMilestone.value;
      if (!milestoneId){
        alert("Selecione um marco para a atividade.");
        return;
      }

      if (!id){
        const newItem = {
          id: `AC-${String(Math.floor(Math.random()*900)+100)}`,
          type, milestoneId, name, owner, status, progress, start, end, desc
        };
        items.unshift(newItem);
        write(items);
        logbook("Atividade", "Atividade adicionada", `Atividade adicionada no cronograma: ${newItem.name}`);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        items[idx] = { ...items[idx], milestoneId, name, owner, status, progress, start, end, desc };
        write(items);
        logbook("Atividade", "Atividade atualizada", `Atividade atualizada no cronograma: ${name}`);
      }
    } else {
      if (!id){
        const newItem = {
          id: `MS-${String(Math.floor(Math.random()*900)+100)}`,
          type, name, owner, status, progress, start, end, desc
        };
        items.unshift(newItem);
        write(items);
        logbook("Marco", "Marco adicionado", `Marco adicionado no cronograma: ${newItem.name}`);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        items[idx] = { ...items[idx], name, owner, status, progress, start, end, desc };
        write(items);
        logbook("Marco", "Marco atualizado", `Marco atualizado no cronograma: ${name}`);
      }
    }

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.hide();
    }catch(e){}

    render();
  }

  function deleteItem(id){
    const item = items.find(x=>x.id===id);
    if (!item) return;

    const ok = confirm("Excluir este item do cronograma? (Protótipo UI)");
    if (!ok) return;

    if (item.type === "MILESTONE"){
      // remove também atividades vinculadas
      items = items.filter(x => x.id !== id && x.milestoneId !== id);
      write(items);
      logbook("Marco", "Marco removido", `Marco removido do cronograma: ${item.name} (e atividades vinculadas).`);
    } else {
      items = items.filter(x => x.id !== id);
      write(items);
      logbook("Atividade", "Atividade removida", `Atividade removida do cronograma: ${item.name}.`);
    }

    render();
  }

  function wire(){
    // view toggle
    el.viewTimeline.addEventListener("click", ()=> setView("timeline"));
    el.viewTable.addEventListener("click", ()=> setView("table"));

    // filtros
    el.apply.addEventListener("click", render);
    el.clear.addEventListener("click", ()=>{
      el.search.value = "";
      el.fType.value = "all";
      el.fStatus.value = "all";
      el.fOwner.value = "all";
      render();
    });
    el.search.addEventListener("input", ()=>{
      clearTimeout(el.search._t);
      el.search._t = setTimeout(render, 120);
    });

    // adicionar
    el.addMilestone.addEventListener("click", (e)=>{ e.preventDefault(); openModal("MILESTONE"); });
    el.addActivity.addEventListener("click", (e)=>{ e.preventDefault(); openModal("ACTIVITY"); });

    // salvar modal
    el.formSave.addEventListener("click", saveModal);

    // ações
    el.replan.addEventListener("click", (e)=>{ e.preventDefault(); alert("Replanejar (protótipo UI)."); });
    el.exportBtn.addEventListener("click", (e)=>{ e.preventDefault(); alert("Exportar cronograma (protótipo UI)."); });
    el.reset.addEventListener("click", (e)=>{
      e.preventDefault();
      const ok = confirm("Resetar cronograma (protótipo). Isso limpa o localStorage e repopula dados iniciais.");
      if (!ok) return;
      write([]);
      items = seedIfEmpty();
      render();
    });

    // edit/delete delegação
    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action][data-id]");
      if (!btn) return;
      const act = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      ev.preventDefault();
      if (act === "edit"){
        const it = items.find(x=>x.id===id);
        if (!it) return;
        openModal(it.type, it.id);
      }
      if (act === "delete"){
        deleteItem(id);
      }
    });
  }

  function init(){
    setView("timeline");
    wire();
    render();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>


                    <!-- TAB MONITORAMENTO -->
<div class="tab-pane" id="tab-monitoring" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <!-- Header -->
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Monitoramento</h5>
          <div class="text-muted fs-12">Acompanhamento da execução física (marcos e atividades) e status atual do projeto.</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="btn-group">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="ti ti-plus me-1"></i>Adicionar
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="monAddMilestone"><i class="ti ti-flag me-2"></i>Marco</a></li>
              <li><a class="dropdown-item" href="#" id="monAddActivity"><i class="ti ti-checklist me-2"></i>Atividade</a></li>
            </ul>
          </div>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" id="monExport"><i class="ti ti-download me-2"></i>Exportar</a></li>
              <li><a class="dropdown-item" href="#" id="monReplan"><i class="ti ti-calendar-time me-2"></i>Replanejar</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="monReset"><i class="ti ti-refresh me-2"></i>Resetar monitoramento (protótipo)</a></li>
            </ul>
          </div>
        </div>
      </div>

      <!-- KPIs (minimal) -->
      <div class="row g-2 mb-3">
        <div class="col-12 col-md-4">
          <div class="p-3 rounded border border-dashed">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted fs-12 mb-1">Progresso físico</div>
                <div class="fw-semibold fs-4" id="monKpiProgress">0%</div>
              </div>
              <div class="avatar-sm">
                <span class="avatar-title rounded-circle bg-primary bg-opacity-10 text-primary">
                  <i class="ti ti-progress fs-5"></i>
                </span>
              </div>
            </div>
            <div class="progress bg-primary bg-opacity-25 progress-sm mt-2 mb-0">
              <div class="progress-bar bg-primary" role="progressbar" style="width:0%" id="monKpiProgressBar"></div>
            </div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="p-3 rounded border border-dashed">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted fs-12 mb-1">Atividades em andamento</div>
                <div class="fw-semibold fs-4" id="monKpiOngoing">0</div>
              </div>
              <div class="avatar-sm">
                <span class="avatar-title rounded-circle bg-warning bg-opacity-10 text-warning">
                  <i class="ti ti-loader fs-5"></i>
                </span>
              </div>
            </div>
            <div class="text-muted fs-12 mt-2">Foco em execução e entregas parciais.</div>
          </div>
        </div>

        <div class="col-12 col-md-4">
          <div class="p-3 rounded border border-dashed">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div class="text-muted fs-12 mb-1">Riscos abertos</div>
                <div class="fw-semibold fs-4" id="monKpiRisks">—</div>
              </div>
              <div class="avatar-sm">
                <span class="avatar-title rounded-circle bg-danger bg-opacity-10 text-danger">
                  <i class="ti ti-shield-x fs-5"></i>
                </span>
              </div>
            </div>
            <div class="text-muted fs-12 mt-2">Leitura do módulo de riscos (quando disponível).</div>
          </div>
        </div>
      </div>

      <!-- Filtros (mesma linha) -->
      <div class="card mb-3 border">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-end gap-2">

            <div style="min-width: 280px; flex: 1 1 360px;">
              <label class="form-label">Buscar</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ti ti-search"></i></span>
                <input type="text" class="form-control" id="monSearch" placeholder="Buscar por nome, marco, responsável..." />
              </div>
            </div>

            <div style="min-width: 180px; flex: 0 0 180px;">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="monFilterType">
                <option value="all" selected>Todos</option>
                <option value="MILESTONE">Marcos</option>
                <option value="ACTIVITY">Atividades</option>
              </select>
            </div>

            <div style="min-width: 190px; flex: 0 0 190px;">
              <label class="form-label">Status</label>
              <select class="form-select" id="monFilterStatus">
                <option value="all" selected>Todos</option>
                <option value="PLANNED">Planejado</option>
                <option value="ONGOING">Em andamento</option>
                <option value="DONE">Concluído</option>
                <option value="DELAYED">Atrasado</option>
              </select>
            </div>

            <div style="min-width: 220px; flex: 0 0 220px;">
              <label class="form-label">Responsável</label>
              <select class="form-select" id="monFilterOwner">
                <option value="all" selected>Todos</option>
                <option value="luciene">Luciene Martins</option>
                <option value="joao">João Santos</option>
                <option value="maria">Maria Silva</option>
                <option value="leonardo">Leonardo Queiroz</option>
                <option value="sistema">Sistema GoMAP</option>
              </select>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="monApply">
                <i class="ti ti-filter me-1"></i>Filtrar
              </button>
              <button type="button" class="btn btn-light" id="monClear">
                <i class="ti ti-rotate-2 me-1"></i>Limpar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Tabela -->
      <div id="monEmpty" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-activity-heartbeat fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhum registro encontrado</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todo o monitoramento.</div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
          <thead class="bg-light align-middle bg-opacity-25 thead-sm">
            <tr class="text-uppercase fs-xxs">
              <th style="width:1%;">Tipo</th>
              <th>Nome</th>
              <th style="width:1%;">Marco</th>
              <th style="width:1%;">Responsável</th>
              <th style="width:1%;">Status</th>
              <th style="width:1%;">Progresso</th>
              <th style="width:1%;">Atualização</th>
              <th class="text-center" style="width:1%;">Ações</th>
            </tr>
          </thead>
          <tbody id="monTbody"></tbody>
        </table>
      </div>

      <div class="text-muted fs-12 mt-3">
        Regra (protótipo): atividades dependem de um marco. Alterações aqui disparam atualização do cronograma/linha do tempo via evento.
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Adicionar/Editar -->
<div class="modal fade" id="monModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="monModalTitle">Adicionar</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="monFormId" value="" />
        <input type="hidden" id="monFormType" value="MILESTONE" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Nome</label>
            <input type="text" class="form-control" id="monFormName" placeholder="Ex.: Estabilização de webhooks" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="monFormStatus">
              <option value="PLANNED" selected>Planejado</option>
              <option value="ONGOING">Em andamento</option>
              <option value="DONE">Concluído</option>
              <option value="DELAYED">Atrasado</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Progresso (%)</label>
            <input type="number" class="form-control" id="monFormProgress" min="0" max="100" value="0" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Responsável</label>
            <select class="form-select" id="monFormOwner">
              <option value="luciene" selected>Luciene Martins</option>
              <option value="joao">João Santos</option>
              <option value="maria">Maria Silva</option>
              <option value="leonardo">Leonardo Queiroz</option>
              <option value="sistema">Sistema GoMAP</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Início</label>
            <input type="date" class="form-control" id="monFormStart" />
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Fim</label>
            <input type="date" class="form-control" id="monFormEnd" />
          </div>

          <div class="col-12 d-none" id="monFormMilestoneWrap">
            <label class="form-label">Marco</label>
            <select class="form-select" id="monFormMilestone"></select>
            <div class="text-muted fs-12 mt-1">Atividades precisam estar vinculadas a um marco.</div>
          </div>

          <div class="col-12">
            <label class="form-label">Descrição (opcional)</label>
            <textarea class="form-control" id="monFormDesc" rows="3" placeholder="Observações do item..."></textarea>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="monFormSave">
          <i class="ti ti-device-floppy me-1"></i>Salvar
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  // OBS: para refletir no cronograma/linha do tempo, usamos o MESMO storage do cronograma.
  // Assim, o que você altera em Monitoramento reflete diretamente no Cronograma.
  const KEY = "gomap_schedule_0006"; // reuso proposital
  const RISKS_KEY = "gomap_risks_0006"; // só para KPI (se existir)

  const actors = {
    luciene: { key:"luciene", name:"Luciene Martins" },
    joao: { key:"joao", name:"João Santos" },
    maria: { key:"maria", name:"Maria Silva" },
    leonardo: { key:"leonardo", name:"Leonardo Queiroz" },
    sistema: { key:"sistema", name:"Sistema GoMAP" }
  };

  const statusMeta = {
    PLANNED: { label:"Planejado", badge:"badge-soft-secondary" },
    ONGOING: { label:"Em andamento", badge:"badge-soft-primary" },
    DONE: { label:"Concluído", badge:"badge-soft-success" },
    DELAYED: { label:"Atrasado", badge:"badge-soft-danger" }
  };

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#39;");
  }

  function nowIso(){ return new Date().toISOString(); }

  function read(){
    try {
      const raw = localStorage.getItem(KEY);
      const data = raw ? JSON.parse(raw) : [];
      return Array.isArray(data) ? data : [];
    } catch(e){ return []; }
  }

  function write(list){
    localStorage.setItem(KEY, JSON.stringify(list || []));
  }

  function readRisksCountOpen(){
    try{
      const raw = localStorage.getItem(RISKS_KEY);
      const data = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(data)) return "—";
      const open = data.filter(r => r && r.status === "OPEN").length;
      return String(open);
    }catch(e){
      return "—";
    }
  }

  function fmt(d){
    if (!d) return "—";
    const [y,m,dd] = String(d).split("-");
    if (!y||!m||!dd) return d;
    return `${dd}/${m}/${y}`;
  }

  function badgeStatus(st){
    const m = statusMeta[st] || { label: st, badge:"badge-soft-secondary" };
    return `<span class="badge ${esc(m.badge)} fs-xxs">${esc(m.label)}</span>`;
  }

  function logbookSafe(entry){
    try{
      if (typeof window.addLogbookEntry === "function") window.addLogbookEntry(entry);
    }catch(e){}
  }

  function addLogMonitoring(action, item){
    const title =
      action === "CREATE" ? "Monitoramento: item criado" :
      action === "UPDATE" ? "Monitoramento: item atualizado" :
      "Monitoramento: item removido";

    const desc =
      action === "CREATE" ? `Criado: ${item.type} — ${item.name}` :
      action === "UPDATE" ? `Atualizado: ${item.type} — ${item.name}` :
      `Removido: ${item.type} — ${item.name}`;

    logbookSafe({
      id: `LG-${String(Math.floor(Math.random()*900)+100)}`,
      createdAt: nowIso(),
      type: "MONITORING",
      title,
      description: desc,
      actorKey: item.owner || "luciene",
      source: "manual",
      tags: ["Monitoramento", item.type],
      attachments: []
    });
  }

  const el = {
    // KPIs
    kpiProgress: document.getElementById("monKpiProgress"),
    kpiProgressBar: document.getElementById("monKpiProgressBar"),
    kpiOngoing: document.getElementById("monKpiOngoing"),
    kpiRisks: document.getElementById("monKpiRisks"),

    // filters
    search: document.getElementById("monSearch"),
    fType: document.getElementById("monFilterType"),
    fStatus: document.getElementById("monFilterStatus"),
    fOwner: document.getElementById("monFilterOwner"),
    apply: document.getElementById("monApply"),
    clear: document.getElementById("monClear"),

    // table
    empty: document.getElementById("monEmpty"),
    tbody: document.getElementById("monTbody"),

    // actions
    addMilestone: document.getElementById("monAddMilestone"),
    addActivity: document.getElementById("monAddActivity"),
    exportBtn: document.getElementById("monExport"),
    replan: document.getElementById("monReplan"),
    reset: document.getElementById("monReset"),

    // modal
    modal: document.getElementById("monModal"),
    modalTitle: document.getElementById("monModalTitle"),
    formId: document.getElementById("monFormId"),
    formType: document.getElementById("monFormType"),
    formName: document.getElementById("monFormName"),
    formStatus: document.getElementById("monFormStatus"),
    formProgress: document.getElementById("monFormProgress"),
    formOwner: document.getElementById("monFormOwner"),
    formStart: document.getElementById("monFormStart"),
    formEnd: document.getElementById("monFormEnd"),
    formDesc: document.getElementById("monFormDesc"),
    formMilestoneWrap: document.getElementById("monFormMilestoneWrap"),
    formMilestone: document.getElementById("monFormMilestone"),
    formSave: document.getElementById("monFormSave"),
  };

  let items = read();

  function getMilestones(){
    return items.filter(x => x.type === "MILESTONE").sort((a,b)=> (a.start||"").localeCompare(b.start||""));
  }

  function fillMilestoneSelect(selectedId){
    const ms = getMilestones();
    el.formMilestone.innerHTML = "";
    ms.forEach(m=>{
      const opt = document.createElement("option");
      opt.value = m.id;
      opt.textContent = m.name;
      el.formMilestone.appendChild(opt);
    });
    if (selectedId) el.formMilestone.value = selectedId;
    if (!selectedId && ms[0]) el.formMilestone.value = ms[0].id;
  }

  function calcKpis(){
    const allActs = items.filter(x => x.type === "ACTIVITY");
    const ongoing = allActs.filter(a => a.status === "ONGOING").length;
    el.kpiOngoing.textContent = String(ongoing);

    // progresso: média ponderada (atividade = 1, marco = 1) para manter simples
    const relevant = items.filter(x => x.type === "ACTIVITY" || x.type === "MILESTONE");
    const avg = relevant.length
      ? Math.round(relevant.reduce((acc,x)=> acc + (Number(x.progress||0)), 0) / relevant.length)
      : 0;

    el.kpiProgress.textContent = `${avg}%`;
    el.kpiProgressBar.style.width = `${Math.max(0, Math.min(100, avg))}%`;

    el.kpiRisks.textContent = readRisksCountOpen();
  }

  function getFiltered(){
    const q = (el.search.value||"").trim().toLowerCase();
    const type = el.fType.value || "all";
    const status = el.fStatus.value || "all";
    const owner = el.fOwner.value || "all";

    return items
      .slice()
      .sort((a,b)=> String(b.updatedAt||"").localeCompare(String(a.updatedAt||"")))
      .filter(x=>{
        const msName = x.milestoneId ? (items.find(m=>m.id===x.milestoneId)?.name || "") : "";
        const blob = [
          x.id, x.type, x.name, x.desc,
          x.status, x.progress,
          x.start, x.end,
          msName,
          (actors[x.owner]?.name || "")
        ].join(" ").toLowerCase();

        const okQ = !q || blob.includes(q);
        const okT = type === "all" || x.type === type;
        const okS = status === "all" || x.status === status;
        const okO = owner === "all" || x.owner === owner;
        return okQ && okT && okS && okO;
      });
  }

  function render(){
    items = read();
    calcKpis();

    const list = getFiltered();
    el.empty.classList.toggle("d-none", list.length > 0);
    el.tbody.innerHTML = "";

    list.forEach(x=>{
      const isMilestone = x.type === "MILESTONE";
      const typeLabel = isMilestone
        ? `<span class="badge badge-soft-success fs-xxs">Marco</span>`
        : `<span class="badge badge-soft-primary fs-xxs">Atividade</span>`;

      const milestoneName = !isMilestone
        ? (items.find(m=>m.id===x.milestoneId)?.name || "—")
        : "—";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${typeLabel}</td>

        <td>
          <div class="fw-medium text-truncate" style="max-width: 560px;" title="${esc(x.name)}">${esc(x.name)}</div>
          ${x.desc ? `<div class="text-muted fs-12 text-truncate" style="max-width: 560px;" title="${esc(x.desc)}">${esc(x.desc)}</div>` : ``}
        </td>

        <td class="text-muted text-truncate" style="max-width: 260px;" title="${esc(milestoneName)}">${esc(milestoneName)}</td>
        <td class="text-muted">${esc(actors[x.owner]?.name || "—")}</td>
        <td>${badgeStatus(x.status)}</td>

        <td>
          <div class="d-flex align-items-center gap-2">
            <div class="text-muted fs-12">${esc(Number(x.progress||0))}%</div>
            <div class="progress bg-primary bg-opacity-25 progress-sm flex-grow-1 mb-0" style="min-width:120px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width:${Math.max(0, Math.min(100, Number(x.progress||0)))}%"></div>
            </div>
          </div>
        </td>

        <td class="text-muted">${x.updatedAt ? esc(new Date(x.updatedAt).toLocaleString("pt-BR")) : "—"}</td>

        <td class="text-center">
          <div class="d-flex justify-content-center gap-1">
            <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(x.id)}" title="Editar">
              <i class="ti ti-edit"></i>
            </button>
            <button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(x.id)}" title="Excluir">
              <i class="ti ti-trash"></i>
            </button>
          </div>
        </td>
      `;
      el.tbody.appendChild(tr);
    });
  }

  function setModalMode(type, id){
    el.formType.value = type;
    el.formId.value = id || "";

    const isActivity = type === "ACTIVITY";
    el.formMilestoneWrap.classList.toggle("d-none", !isActivity);

    fillMilestoneSelect();

    if (!id){
      el.modalTitle.textContent = (type === "MILESTONE") ? "Adicionar marco" : "Adicionar atividade";
      el.formName.value = "";
      el.formStatus.value = "ONGOING";
      el.formProgress.value = 0;
      el.formOwner.value = "luciene";
      el.formDesc.value = "";

      const d = new Date();
      const plus = (n)=> { const x = new Date(d); x.setDate(x.getDate()+n); return x.toISOString().slice(0,10); };
      el.formStart.value = plus(0);
      el.formEnd.value = plus(14);

      if (isActivity){
        const firstMs = getMilestones()[0];
        fillMilestoneSelect(firstMs?.id);
      }
    } else {
      const it = items.find(x=>x.id===id);
      if (!it) return;

      el.modalTitle.textContent = (it.type === "MILESTONE")
        ? `Editar marco — ${it.id}`
        : `Editar atividade — ${it.id}`;

      el.formName.value = it.name || "";
      el.formStatus.value = it.status || "ONGOING";
      el.formProgress.value = Number(it.progress||0);
      el.formOwner.value = it.owner || "luciene";
      el.formStart.value = it.start || "";
      el.formEnd.value = it.end || "";
      el.formDesc.value = it.desc || "";

      if (it.type === "ACTIVITY") fillMilestoneSelect(it.milestoneId);
    }

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.show();
    }catch(e){}
  }

  function nextId(prefix){
    return `${prefix}-${String(Math.floor(Math.random()*900)+100)}`;
  }

  function saveModal(){
    const id = (el.formId.value||"").trim();
    const type = el.formType.value;
    const name = (el.formName.value||"").trim();
    const status = el.formStatus.value;
    const progress = Math.max(0, Math.min(100, Number(el.formProgress.value||0)));
    const owner = el.formOwner.value;
    const start = el.formStart.value;
    const end = el.formEnd.value;
    const desc = (el.formDesc.value||"").trim();
    const updatedAt = nowIso();

    if (!name){
      alert("Preencha o nome.");
      return;
    }

    items = read();

    if (type === "ACTIVITY"){
      const milestoneId = el.formMilestone.value;
      if (!milestoneId){
        alert("Selecione um marco para a atividade.");
        return;
      }

      if (!id){
        const newItem = {
          id: nextId("AC"),
          type,
          milestoneId,
          name,
          owner,
          status,
          progress,
          start,
          end,
          desc,
          createdAt: updatedAt,
          updatedAt: updatedAt
        };
        items.unshift(newItem);
        write(items);
        addLogMonitoring("CREATE", newItem);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        const next = { ...items[idx], milestoneId, name, owner, status, progress, start, end, desc, updatedAt };
        items[idx] = next;
        write(items);
        addLogMonitoring("UPDATE", next);
      }
    } else {
      if (!id){
        const newItem = {
          id: nextId("MS"),
          type,
          name,
          owner,
          status,
          progress,
          start,
          end,
          desc,
          createdAt: updatedAt,
          updatedAt: updatedAt
        };
        items.unshift(newItem);
        write(items);
        addLogMonitoring("CREATE", newItem);
      } else {
        const idx = items.findIndex(x=>x.id===id);
        if (idx<0) return;
        const next = { ...items[idx], name, owner, status, progress, start, end, desc, updatedAt };
        items[idx] = next;
        write(items);
        addLogMonitoring("UPDATE", next);
      }
    }

    // dispara evento global para cronograma/linha do tempo reagirem
    window.dispatchEvent(new CustomEvent("gomap:schedule-updated", { detail: { projectId: "0006" } }));

    try{
      const m = window.bootstrap?.Modal?.getInstance(el.modal) || new window.bootstrap.Modal(el.modal);
      m.hide();
    }catch(e){}

    render();
  }

  function deleteItem(id){
    items = read();
    const it = items.find(x=>x.id===id);
    if (!it) return;

    const ok = confirm("Excluir este registro do monitoramento? (Protótipo UI)");
    if (!ok) return;

    if (it.type === "MILESTONE"){
      items = items.filter(x => x.id !== id && x.milestoneId !== id);
    } else {
      items = items.filter(x => x.id !== id);
    }

    write(items);
    addLogMonitoring("DELETE", it);

    window.dispatchEvent(new CustomEvent("gomap:schedule-updated", { detail: { projectId: "0006" } }));

    render();
  }

  function wire(){
    // filtros
    el.apply.addEventListener("click", render);
    el.clear.addEventListener("click", ()=>{
      el.search.value = "";
      el.fType.value = "all";
      el.fStatus.value = "all";
      el.fOwner.value = "all";
      render();
    });
    el.search.addEventListener("input", ()=>{
      clearTimeout(el.search._t);
      el.search._t = setTimeout(render, 120);
    });

    // adicionar
    el.addMilestone.addEventListener("click", (e)=>{ e.preventDefault(); setModalMode("MILESTONE"); });
    el.addActivity.addEventListener("click", (e)=>{ e.preventDefault(); setModalMode("ACTIVITY"); });

    // modal save
    el.formSave.addEventListener("click", saveModal);

    // ações
    el.exportBtn.addEventListener("click", (e)=>{ e.preventDefault(); alert("Exportar monitoramento (protótipo UI)."); });
    el.replan.addEventListener("click", (e)=>{ e.preventDefault(); alert("Replanejar (protótipo UI)."); });

    el.reset.addEventListener("click", (e)=>{
      e.preventDefault();
      const ok = confirm("Resetar monitoramento (protótipo). Isso limpa o storage do cronograma/monitoramento deste projeto.");
      if (!ok) return;
      write([]);
      alert("Reset concluído. Recarregue o cronograma para repopular, se você estiver usando seed lá.");
      window.dispatchEvent(new CustomEvent("gomap:schedule-updated", { detail: { projectId: "0006" } }));
      render();
    });

    // delegação tabela
    document.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action][data-id]");
      if (!btn) return;

      const act = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!act || !id) return;

      ev.preventDefault();

      if (act === "edit"){
        const it = read().find(x=>x.id===id);
        if (!it) return;
        setModalMode(it.type, it.id);
      }
      if (act === "delete"){
        deleteItem(id);
      }
    });

    // re-render se outro módulo alterar o storage
    window.addEventListener("gomap:schedule-updated", () => {
      render();
    });
  }

  function init(){
    // KPI riscos
    el.kpiRisks.textContent = readRisksCountOpen();
    wire();
    render();
  }

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
</script>


                    <div class="tab-pane" id="tab-governance" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body text-center text-muted py-5">
                          <h5 class="mb-1">Governança</h5>
                          <p class="mb-0">Esta funcionalidade será criada posteriormente.</p>
                        </div>
                      </div>
                    </div>

                    <div class="tab-pane" id="tab-funding" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Captação de recursos</h5>
          <div class="text-muted fs-12">Histórico de propostas de captação vinculadas a este projeto.</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="d-flex align-items-center gap-2 me-1">
            <span class="badge badge-soft-secondary fs-xxs" data-funding-count>Total: 0</span>
            <span class="badge badge-soft-info fs-xxs" id="fundingCountPlanning">Planejamento: 0</span>
            <span class="badge badge-soft-warning fs-xxs" id="fundingCountArticulation">Articulação: 0</span>
            <span class="badge badge-soft-primary fs-xxs" id="fundingCountFormalization">Formalização: 0</span>
            <span class="badge badge-soft-success fs-xxs" id="fundingCountExecution">Execução: 0</span>
            <span class="badge badge-soft-dark fs-xxs" id="fundingCountArchived">Arquivadas: 0</span>
          </div>

          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#funding-proposal-modal" data-funding-new>
            <i class="ti ti-plus me-1"></i>Nova proposta
          </button>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="#" id="fundingExport">
                  <i class="ti ti-download me-2"></i>Exportar
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="fundingClearAll">
                  <i class="ti ti-broom me-2"></i>Limpar propostas salvas (protótipo)
                </a>
              </li>
            </ul>
          </div>

        </div>
      </div>

      <!-- Filtros (espelho do padrão de Riscos) -->
      <div class="card mb-3 border">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-end gap-2">

            <div style="min-width: 280px; flex: 1 1 320px;">
              <label class="form-label">Buscar</label>
              <div class="input-group">
                <span class="input-group-text"><i class="ti ti-search"></i></span>
                <input type="text" class="form-control" id="fundingSearch"
                  placeholder="Buscar por título ou ID da proposta..." data-funding-search />
              </div>
            </div>

            <div style="min-width: 220px; flex: 0 0 220px;">
              <label class="form-label">Fase</label>
              <select class="form-select" id="fundingFilterPhase" data-funding-status-filter>
                <option value="all" selected>Todas</option>
                <option value="planning">Em Planejamento</option>
                <option value="articulation">Em Articulação</option>
                <option value="formalization">Em Formalização</option>
                <option value="execution">Em Execução</option>
                <option value="archived">Arquivadas</option>
              </select>
            </div>

            <div class="ms-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="fundingApplyFilter" data-funding-apply>
                <i class="ti ti-filter me-1"></i>Filtrar
              </button>
              <button type="button" class="btn btn-light" id="fundingClearFilter" data-funding-clear>
                <i class="ti ti-rotate-2 me-1"></i>Limpar
              </button>
            </div>

          </div>
        </div>
      </div>

      <!-- Empty -->
      <div id="fundingEmptyState" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-coins fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhuma proposta encontrada</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todas as propostas.</div>
        </div>
      </div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
          <thead class="bg-light align-middle bg-opacity-25 thead-sm">
            <tr class="text-uppercase fs-xxs">
              <th>Proposta</th>
              <th>Fase</th>
              <th>Atualização</th>
              <th>Status</th>
              <th class="text-center" style="width: 1%;">Ações</th>
            </tr>
          </thead>
          <tbody data-funding-list>
            <!-- preenchido via JS -->
          </tbody>
        </table>
      </div>

      <div class="text-muted fs-12 mt-3">
        Regra (protótipo): o conteúdo exibido aqui é mock e serve para validar o fluxo de cadastro/edição em modal.
      </div>

    </div>
  </div>
</div>

<div class="tab-pane" id="tab-risks" role="tabpanel">
  <div class="card mb-0">
    <div class="card-body">

      <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
        <div>
          <h5 class="mb-1">Riscos</h5>
          <div class="text-muted fs-12">Registro e acompanhamento de riscos do projeto (severidade, mitigação e prazos).</div>
        </div>

        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="d-flex align-items-center gap-2 me-1">
            <span class="badge badge-soft-danger fs-xxs" id="riskCountOpen">Abertos: 0</span>
            <span class="badge badge-soft-warning fs-xxs" id="riskCountMitigating">Mitigando: 0</span>
            <span class="badge badge-soft-success fs-xxs" id="riskCountClosed">Encerrados: 0</span>
          </div>

          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#risksModal">
            <i class="ti ti-plus me-1"></i>Novo risco
          </button>

          <div class="dropdown">
            <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Ações
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
              <li>
                <a class="dropdown-item" href="#" id="risksExport">
                  <i class="ti ti-download me-2"></i>Exportar
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" id="risksClearAll">
                  <i class="ti ti-broom me-2"></i>Limpar riscos salvos (protótipo)
                </a>
              </li>
            </ul>
          </div>

        </div>
      </div>

      <!-- Filtros (flex toolbar: botões SEMPRE na mesma linha dos campos, com wrap controlado) -->
<div class="card mb-3 border">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-end gap-2">

      <div style="min-width: 280px; flex: 1 1 320px;">
        <label class="form-label">Buscar</label>
        <div class="input-group">
          <span class="input-group-text"><i class="ti ti-search"></i></span>
          <input type="text" class="form-control" id="risksSearch"
            placeholder="Buscar por ID, título, descrição..." />
        </div>
      </div>

      <div style="min-width: 170px; flex: 0 0 170px;">
        <label class="form-label">Status</label>
        <select class="form-select" id="risksFilterStatus">
          <option value="all" selected>Todos</option>
          <option value="OPEN">Aberto</option>
          <option value="MITIGATING">Mitigando</option>
          <option value="CLOSED">Encerrado</option>
        </select>
      </div>

      <div style="min-width: 170px; flex: 0 0 170px;">
        <label class="form-label">Severidade</label>
        <select class="form-select" id="risksFilterSeverity">
          <option value="all" selected>Todas</option>
          <option value="LOW">Baixa</option>
          <option value="MEDIUM">Média</option>
          <option value="HIGH">Alta</option>
          <option value="CRITICAL">Crítica</option>
        </select>
      </div>

      <div style="min-width: 200px; flex: 0 0 200px;">
        <label class="form-label">Categoria</label>
        <select class="form-select" id="risksFilterCategory">
          <option value="all" selected>Todas</option>
          <option value="TECH">Técnico</option>
          <option value="SECURITY">Segurança</option>
          <option value="OPS">Operacional</option>
          <option value="COMPLIANCE">Legal/Compliance</option>
          <option value="VENDOR">Fornecedor</option>
        </select>
      </div>

      <div style="min-width: 220px; flex: 0 0 220px;">
        <label class="form-label">Responsável</label>
        <select class="form-select" id="risksFilterOwner">
          <option value="all" selected>Todos</option>
          <option value="luciene">Luciene Martins</option>
          <option value="joao">João Santos</option>
          <option value="maria">Maria Silva</option>
          <option value="leonardo">Leonardo Queiroz</option>
          <option value="sistema">Sistema GoMAP</option>
        </select>
      </div>

      <!-- Botões: ficam na MESMA linha; vão para a direita com ms-auto -->
      <div class="ms-auto d-flex gap-2">
        <button type="button" class="btn btn-outline-primary" id="risksApply">
          <i class="ti ti-filter me-1"></i>Filtrar
        </button>
        <button type="button" class="btn btn-light" id="risksClear">
          <i class="ti ti-rotate-2 me-1"></i>Limpar
        </button>
      </div>

    </div>
  </div>
</div>


      <!-- Empty -->
      <div id="risksEmptyState" class="d-none">
        <div class="text-center py-5 text-muted">
          <div class="avatar-xl mx-auto mb-2">
            <span class="avatar-title rounded-circle bg-light text-muted">
              <i class="ti ti-shield-x fs-2"></i>
            </span>
          </div>
          <h5 class="mb-1">Nenhum risco encontrado</h5>
          <div class="text-muted">Ajuste os filtros ou limpe para ver todos os riscos.</div>
        </div>
      </div>

      <!-- Tabela -->
      <div class="table-responsive">
        <table class="table table-custom table-centered table-hover w-100 mb-0 text-nowrap">
          <thead class="bg-light align-middle bg-opacity-25 thead-sm">
            <tr class="text-uppercase fs-xxs">
              <th style="width:1%;">ID</th>
              <th>Risco</th>
              <th style="width:1%;">Severidade</th>
              <th style="width:1%;">Status</th>
              <th style="width:1%;">Responsável</th>
              <th style="width:1%;">Prazo</th>
              <th style="width:1%;">Atualização</th>
              <th class="text-center" style="width:1%;">Ações</th>
            </tr>
          </thead>
          <tbody id="risksTableBody"></tbody>
        </table>
      </div>

      <div class="text-muted fs-12 mt-3">
        Regra (protótipo): é possível excluir apenas riscos <span class="fw-semibold">Abertos</span> criados manualmente. Riscos <span class="fw-semibold">Encerrados</span> não podem ser excluídos.
      </div>

    </div>
  </div>
</div>

<!-- MODAL: Criar/Editar Risco -->
<div class="modal fade" id="risksModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="risksModalTitle">Novo risco</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="riskFormId" value="" />

        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label">Título</label>
            <input type="text" class="form-control" id="riskFormTitle" placeholder="Ex.: Duplicidade de eventos no webhook" />
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="riskFormCategory">
              <option value="TECH" selected>Técnico</option>
              <option value="SECURITY">Segurança</option>
              <option value="OPS">Operacional</option>
              <option value="COMPLIANCE">Legal/Compliance</option>
              <option value="VENDOR">Fornecedor</option>
            </select>
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label">Severidade</label>
            <select class="form-select" id="riskFormSeverity">
              <option value="LOW">Baixa</option>
              <option value="MEDIUM" selected>Média</option>
              <option value="HIGH">Alta</option>
              <option value="CRITICAL">Crítica</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Status</label>
            <select class="form-select" id="riskFormStatus">
              <option value="OPEN" selected>Aberto</option>
              <option value="MITIGATING">Mitigando</option>
              <option value="CLOSED">Encerrado</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Responsável</label>
            <select class="form-select" id="riskFormOwner">
              <option value="luciene" selected>Luciene Martins</option>
              <option value="joao">João Santos</option>
              <option value="maria">Maria Silva</option>
              <option value="leonardo">Leonardo Queiroz</option>
              <option value="sistema">Sistema GoMAP</option>
            </select>
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Prazo</label>
            <input type="date" class="form-control" id="riskFormDue" />
          </div>

          <div class="col-12">
            <label class="form-label">Descrição</label>
            <textarea class="form-control" id="riskFormDesc" rows="3" placeholder="Contexto e impacto do risco..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Plano de mitigação</label>
            <textarea class="form-control" id="riskFormMitigation" rows="3" placeholder="O que será feito para reduzir a probabilidade/impacto..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Plano de contingência (opcional)</label>
            <textarea class="form-control" id="riskFormContingency" rows="2" placeholder="O que fazer se o risco ocorrer..."></textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Evidência (opcional)</label>
            <div class="input-group">
              <input type="text" class="form-control" id="riskFormEvidence" placeholder="Ex.: evidencias-homologacao.pdf (mock)" />
              <button type="button" class="btn btn-light" id="riskFormEvidenceBtn">
                <i class="ti ti-paperclip me-1"></i>Anexar (mock)
              </button>
            </div>
            <div class="text-muted fs-12 mt-1">Protótipo UI: o anexo é simulado pelo nome; download mostra um alerta.</div>
          </div>
        </div>
      </div>

      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>

        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-success d-none" id="riskFormCloseBtn">
            <i class="ti ti-check me-1"></i>Encerrar
          </button>
          <button type="button" class="btn btn-primary" id="riskFormSaveBtn">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  const RISKS_STORAGE_KEY = "gomap_risks_0006";

  const actors = {
    luciene: { key: "luciene", name: "Luciene Martins", avatar: "assets/images/users/user-3.jpg" },
    joao: { key: "joao", name: "João Santos", avatar: "assets/images/users/user-5.jpg" },
    maria: { key: "maria", name: "Maria Silva", avatar: "assets/images/users/user-2.jpg" },
    leonardo: { key: "leonardo", name: "Leonardo Queiroz", avatar: "assets/images/users/user-7.jpg" },
    sistema: { key: "sistema", name: "Sistema GoMAP", avatar: null }
  };

  const categoryMeta = {
    TECH: "Técnico",
    SECURITY: "Segurança",
    OPS: "Operacional",
    COMPLIANCE: "Legal/Compliance",
    VENDOR: "Fornecedor"
  };

  const statusMeta = {
    OPEN: { label: "Aberto", badge: "badge-soft-danger" },
    MITIGATING: { label: "Mitigando", badge: "badge-soft-warning" },
    CLOSED: { label: "Encerrado", badge: "badge-soft-success" }
  };

  const severityMeta = {
    LOW: { label: "Baixa", badge: "badge-soft-secondary" },
    MEDIUM: { label: "Média", badge: "badge-soft-primary" },
    HIGH: { label: "Alta", badge: "badge-soft-warning" },
    CRITICAL: { label: "Crítica", badge: "badge-soft-danger" }
  };

  function esc(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#39;");
  }

  function nowIso() { return new Date().toISOString(); }

  function fmtDateBR(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    return `${dd}/${mm}/${yy}`;
  }

  function fmtDateTimeBR(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yy = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,"0");
    const mi = String(d.getMinutes()).padStart(2,"0");
    return `${dd}/${mm}/${yy} ${hh}:${mi}`;
  }

  function readRisks() {
    try {
      const raw = localStorage.getItem(RISKS_STORAGE_KEY);
      const data = raw ? JSON.parse(raw) : null;
      return Array.isArray(data) ? data : [];
    } catch (e) {
      return [];
    }
  }

  function writeRisks(list) {
    localStorage.setItem(RISKS_STORAGE_KEY, JSON.stringify(list || []));
  }

  function seedIfEmpty() {
    const current = readRisks();
    if (current.length) return current;

    const seeded = [
      {
        id: "R-001",
        title: "Duplicidade de eventos no webhook (idempotência)",
        category: "TECH",
        severity: "HIGH",
        status: "MITIGATING",
        ownerKey: "joao",
        dueDate: "2026-02-05",
        description: "Eventos duplicados podem gerar cobranças/reconciliação inconsistente.",
        mitigation: "Aplicar idempotência por chave de transação e retentativas com backoff.",
        contingency: "Fila de compensação e validação por conciliação diária.",
        evidence: "matriz-eventos-webhook.xlsx",
        createdAt: "2025-12-20T10:05:00-03:00",
        updatedAt: "2026-01-10T16:40:00-03:00",
        source: "manual"
      },
      {
        id: "R-002",
        title: "Divergência na conciliação PIX vs Cartão",
        category: "OPS",
        severity: "MEDIUM",
        status: "OPEN",
        ownerKey: "maria",
        dueDate: "2026-02-10",
        description: "Possível divergência por atrasos de compensação e janelas de processamento distintas.",
        mitigation: "Ajustar janelas de conciliação e validar regras de corte.",
        contingency: "Processo manual de ajuste com trilha de auditoria.",
        evidence: "relatorio-conciliacao-jan-2026.csv",
        createdAt: "2026-01-18T10:20:00-03:00",
        updatedAt: "2026-01-18T10:20:00-03:00",
        source: "manual"
      },
      {
        id: "R-003",
        title: "Indisponibilidade do provedor em horário de pico",
        category: "VENDOR",
        severity: "CRITICAL",
        status: "MITIGATING",
        ownerKey: "luciene",
        dueDate: "2026-01-30",
        description: "Indisponibilidade impacta autorização e confirmação de pagamento.",
        mitigation: "Circuit breaker + retry controlado; monitoramento de SLA do provedor.",
        contingency: "Fila de pendências e reprocessamento; fallback para canal alternativo (se disponível).",
        evidence: "",
        createdAt: "2025-11-15T11:00:00-03:00",
        updatedAt: "2026-01-05T09:10:00-03:00",
        source: "manual"
      },
      {
        id: "R-004",
        title: "Requisitos LGPD/segurança (tokens e logs)",
        category: "SECURITY",
        severity: "HIGH",
        status: "OPEN",
        ownerKey: "leonardo",
        dueDate: "2026-02-01",
        description: "Logs podem conter dados sensíveis se não houver mascaramento/criptografia adequada.",
        mitigation: "Mascarar payloads, rotacionar segredos e reforçar trilha de auditoria.",
        contingency: "Revisão emergencial de logging e revogação/rotação de credenciais.",
        evidence: "",
        createdAt: "2025-12-01T14:30:00-03:00",
        updatedAt: "2025-12-01T14:30:00-03:00",
        source: "manual"
      }
    ];

    writeRisks(seeded);
    return seeded;
  }

  function logbookSafe(entry) {
    try {
      if (window && typeof window.addLogbookEntry === "function") {
        window.addLogbookEntry(entry);
      } else if (window && typeof window.addLogbookEntryFromFile === "function") {
        // fallback: registra como NOTE genérica
        window.addLogbookEntryFromFile("NOTE", { name: entry.title || "Atualização de risco" }, entry.actorKey || "sistema");
      }
    } catch (e) {}
  }

  function addLogRisk(action, risk) {
    const actorKey = risk.ownerKey || "sistema";
    const actorName = (actors[actorKey] || actors.sistema).name;

    const title =
      action === "CREATE" ? "Risco criado" :
      action === "UPDATE" ? "Risco atualizado" :
      action === "CLOSE"  ? "Risco encerrado" :
      "Risco removido";

    const desc =
      action === "CREATE" ? `Criado: ${risk.id} — ${risk.title}` :
      action === "UPDATE" ? `Atualizado: ${risk.id} — ${risk.title}` :
      action === "CLOSE"  ? `Encerrado: ${risk.id} — ${risk.title}` :
      `Removido: ${risk.id} — ${risk.title}`;

    logbookSafe({
      id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
      createdAt: nowIso(),
      type: "RISK",
      title: title,
      description: desc,
      actorKey: actorKey,
      source: "manual",
      tags: ["Riscos", risk.id, categoryMeta[risk.category] || "Risco"],
      attachments: risk.evidence ? [{ name: risk.evidence, href: "#" }] : []
    });

    // melhora a timeline no visual: mostra autor como texto no evento
    // (seu renderer já puxa nome pelo actorKey)
  }

  const el = {
    body: document.getElementById("risksTableBody"),
    empty: document.getElementById("risksEmptyState"),

    countOpen: document.getElementById("riskCountOpen"),
    countMitigating: document.getElementById("riskCountMitigating"),
    countClosed: document.getElementById("riskCountClosed"),

    search: document.getElementById("risksSearch"),
    fStatus: document.getElementById("risksFilterStatus"),
    fSeverity: document.getElementById("risksFilterSeverity"),
    fCategory: document.getElementById("risksFilterCategory"),
    fOwner: document.getElementById("risksFilterOwner"),
    apply: document.getElementById("risksApply"),
    clear: document.getElementById("risksClear"),

    exportBtn: document.getElementById("risksExport"),
    clearAllBtn: document.getElementById("risksClearAll"),

    // modal form
    modalTitle: document.getElementById("risksModalTitle"),
    formId: document.getElementById("riskFormId"),
    formTitle: document.getElementById("riskFormTitle"),
    formCategory: document.getElementById("riskFormCategory"),
    formSeverity: document.getElementById("riskFormSeverity"),
    formStatus: document.getElementById("riskFormStatus"),
    formOwner: document.getElementById("riskFormOwner"),
    formDue: document.getElementById("riskFormDue"),
    formDesc: document.getElementById("riskFormDesc"),
    formMitigation: document.getElementById("riskFormMitigation"),
    formContingency: document.getElementById("riskFormContingency"),
    formEvidence: document.getElementById("riskFormEvidence"),
    formEvidenceBtn: document.getElementById("riskFormEvidenceBtn"),
    formSave: document.getElementById("riskFormSaveBtn"),
    formClose: document.getElementById("riskFormCloseBtn"),
  };

  let risks = seedIfEmpty();

  function computeCounts(list) {
    const open = list.filter(r => r.status === "OPEN").length;
    const mit = list.filter(r => r.status === "MITIGATING").length;
    const clo = list.filter(r => r.status === "CLOSED").length;
    el.countOpen.textContent = `Abertos: ${open}`;
    el.countMitigating.textContent = `Mitigando: ${mit}`;
    el.countClosed.textContent = `Encerrados: ${clo}`;
  }

  function getFiltered() {
    const q = (el.search.value || "").trim().toLowerCase();
    const st = el.fStatus.value || "all";
    const sv = el.fSeverity.value || "all";
    const cat = el.fCategory.value || "all";
    const own = el.fOwner.value || "all";

    return risks
      .slice()
      .sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .filter((r) => {
        const owner = actors[r.ownerKey] || actors.sistema;
        const blob = [
          r.id, r.title, r.description, r.mitigation, r.contingency,
          r.category, categoryMeta[r.category] || "",
          r.severity, severityMeta[r.severity]?.label || "",
          r.status, statusMeta[r.status]?.label || "",
          owner.name, r.dueDate || "", r.evidence || ""
        ].join(" ").toLowerCase();

        const matchQ = !q || blob.includes(q);
        const matchSt = st === "all" || r.status === st;
        const matchSv = sv === "all" || r.severity === sv;
        const matchCat = cat === "all" || r.category === cat;
        const matchOwn = own === "all" || r.ownerKey === own;

        return matchQ && matchSt && matchSv && matchCat && matchOwn;
      });
  }

  function canDelete(risk) {
    // protótipo: só manual + aberto
    return risk.source === "manual" && risk.status === "OPEN";
  }

  function render(list) {
    el.body.innerHTML = "";
    el.empty.classList.toggle("d-none", list.length > 0);

    list.forEach((r) => {
      const st = statusMeta[r.status] || { label: r.status, badge: "badge-soft-secondary" };
      const sv = severityMeta[r.severity] || { label: r.severity, badge: "badge-soft-secondary" };
      const owner = actors[r.ownerKey] || actors.sistema;

      const ownerHtml = owner.avatar
        ? `<div class="d-flex align-items-center gap-2">
             <img src="${esc(owner.avatar)}" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" alt="${esc(owner.name)}">
             <span class="fw-medium">${esc(owner.name)}</span>
           </div>`
        : `<div class="d-flex align-items-center gap-2">
             <span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;">
               <i class="ti ti-cpu fs-6"></i>
             </span>
             <span class="fw-medium">${esc(owner.name)}</span>
           </div>`;

      const delBtn = canDelete(r)
        ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(r.id)}" title="Excluir"><i class="ti ti-trash"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Exclusão indisponível neste status/regra."><i class="ti ti-lock"></i></button>`;

      const closeBtn = (r.status !== "CLOSED")
        ? `<button class="btn btn-light btn-sm" type="button" data-action="close" data-id="${esc(r.id)}" title="Encerrar"><i class="ti ti-check"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Já encerrado."><i class="ti ti-check"></i></button>`;

      const evidenceBtn = r.evidence
        ? `<button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(r.id)}" title="Download evidência"><i class="ti ti-download"></i></button>`
        : `<button class="btn btn-light btn-sm" type="button" disabled title="Sem evidência."><i class="ti ti-download"></i></button>`;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-muted fw-medium">${esc(r.id)}</td>
        <td>
          <div class="fw-medium">${esc(r.title)}</div>
          <div class="text-muted fs-12">${esc(categoryMeta[r.category] || r.category)}</div>
        </td>
        <td><span class="badge ${esc(sv.badge)} fs-xxs">${esc(sv.label)}</span></td>
        <td><span class="badge ${esc(st.badge)} fs-xxs">${esc(st.label)}</span></td>
        <td>${ownerHtml}</td>
        <td class="text-muted">${r.dueDate ? esc(fmtDateBR(r.dueDate)) : "—"}</td>
        <td class="text-muted">${esc(fmtDateTimeBR(r.updatedAt))}</td>
        <td class="text-center">
          <div class="d-flex justify-content-center gap-1">
            <button class="btn btn-light btn-sm" type="button" data-action="edit" data-id="${esc(r.id)}" title="Ver/Editar">
              <i class="ti ti-edit"></i>
            </button>
            ${closeBtn}
            ${evidenceBtn}
            ${delBtn}
          </div>
        </td>
      `;
      el.body.appendChild(tr);
    });

    computeCounts(risks);
  }

  function refresh() {
    render(getFiltered());
  }

  function resetForm() {
    el.formId.value = "";
    el.formTitle.value = "";
    el.formCategory.value = "TECH";
    el.formSeverity.value = "MEDIUM";
    el.formStatus.value = "OPEN";
    el.formOwner.value = "luciene";

    // prazo default +15 dias
    const d = new Date();
    d.setDate(d.getDate() + 15);
    el.formDue.value = d.toISOString().slice(0,10);

    el.formDesc.value = "";
    el.formMitigation.value = "";
    el.formContingency.value = "";
    el.formEvidence.value = "";
  }

  function openCreate() {
    el.modalTitle.textContent = "Novo risco";
    resetForm();
    el.formClose.classList.add("d-none");
  }

  function openEdit(id) {
    const r = risks.find(x => x.id === id);
    if (!r) return;

    el.modalTitle.textContent = `Editar risco — ${r.id}`;
    el.formId.value = r.id;
    el.formTitle.value = r.title || "";
    el.formCategory.value = r.category || "TECH";
    el.formSeverity.value = r.severity || "MEDIUM";
    el.formStatus.value = r.status || "OPEN";
    el.formOwner.value = r.ownerKey || "luciene";
    el.formDue.value = r.dueDate || "";
    el.formDesc.value = r.description || "";
    el.formMitigation.value = r.mitigation || "";
    el.formContingency.value = r.contingency || "";
    el.formEvidence.value = r.evidence || "";

    // botão encerrar aparece apenas se não estiver encerrado
    if (r.status !== "CLOSED") el.formClose.classList.remove("d-none");
    else el.formClose.classList.add("d-none");

    const modalEl = document.getElementById("risksModal");
    try {
      const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
      modal.show();
    } catch (e) {}
  }

  function nextId() {
    // gera sequência simples R-00X
    const nums = risks
      .map(r => String(r.id || "").replace("R-",""))
      .map(n => parseInt(n,10))
      .filter(n => !isNaN(n));
    const max = nums.length ? Math.max(...nums) : 0;
    return `R-${String(max + 1).padStart(3, "0")}`;
  }

  function saveForm() {
    const id = (el.formId.value || "").trim();
    const title = (el.formTitle.value || "").trim();
    const category = el.formCategory.value;
    const severity = el.formSeverity.value;
    const status = el.formStatus.value;
    const ownerKey = el.formOwner.value;
    const dueDate = el.formDue.value;
    const description = (el.formDesc.value || "").trim();
    const mitigation = (el.formMitigation.value || "").trim();
    const contingency = (el.formContingency.value || "").trim();
    const evidence = (el.formEvidence.value || "").trim();

    if (!title || !description) {
      alert("Preencha o título e a descrição.");
      return;
    }

    if (!mitigation && status !== "CLOSED") {
      // regra minimalista para forçar mitigação em andamento
      const ok = confirm("Plano de mitigação está vazio. Deseja salvar mesmo assim?");
      if (!ok) return;
    }

    const isEdit = !!id;
    const updatedAt = nowIso();

    if (isEdit) {
      const idx = risks.findIndex(r => r.id === id);
      if (idx < 0) return;

      const prev = risks[idx];

      const next = {
        ...prev,
        title, category, severity, status, ownerKey,
        dueDate, description, mitigation, contingency, evidence,
        updatedAt
      };

      risks[idx] = next;
      writeRisks(risks);

      addLogRisk("UPDATE", next);
    } else {
      const newRisk = {
        id: nextId(),
        title, category, severity, status, ownerKey,
        dueDate, description, mitigation, contingency, evidence,
        createdAt: updatedAt,
        updatedAt: updatedAt,
        source: "manual"
      };

      risks.unshift(newRisk);
      writeRisks(risks);

      addLogRisk("CREATE", newRisk);
    }

    const modalEl = document.getElementById("risksModal");
    try {
      const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
      modal.hide();
    } catch (e) {}

    refresh();
  }

  function closeRisk(id) {
    const idx = risks.findIndex(r => r.id === id);
    if (idx < 0) return;
    const r = risks[idx];

    if (r.status === "CLOSED") return;

    const ok = confirm(`Encerrar o risco ${r.id}?`);
    if (!ok) return;

    const next = { ...r, status: "CLOSED", updatedAt: nowIso() };
    risks[idx] = next;
    writeRisks(risks);

    addLogRisk("CLOSE", next);
    refresh();
  }

  function deleteRisk(id) {
    const r = risks.find(x => x.id === id);
    if (!r) return;

    if (!canDelete(r)) {
      alert("Exclusão indisponível. Regra (protótipo): apenas riscos abertos criados manualmente podem ser excluídos.");
      return;
    }

    const ok = confirm(`Excluir o risco ${r.id}? Esta ação é apenas um protótipo UI.`);
    if (!ok) return;

    risks = risks.filter(x => x.id !== id);
    writeRisks(risks);

    addLogRisk("DELETE", r);
    refresh();
  }

  function downloadEvidence(id) {
    const r = risks.find(x => x.id === id);
    if (!r || !r.evidence) return;
    alert(`Download do Arquivo: ${r.evidence}`);
  }

  function wire() {
    // filtros
    el.apply.addEventListener("click", refresh);

    el.clear.addEventListener("click", () => {
      el.search.value = "";
      el.fStatus.value = "all";
      el.fSeverity.value = "all";
      el.fCategory.value = "all";
      el.fOwner.value = "all";
      refresh();
    });

    el.search.addEventListener("input", () => {
      clearTimeout(el.search._t);
      el.search._t = setTimeout(refresh, 150);
    });

    // ações dropdown
    el.exportBtn.addEventListener("click", (e) => {
      e.preventDefault();
      alert("Exportar (protótipo UI).");
    });

    el.clearAllBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const ok = confirm("Limpar riscos salvos deste projeto? (Protótipo) Isso remove apenas o que está no localStorage.");
      if (!ok) return;
      writeRisks([]);
      risks = seedIfEmpty(); // repopula
      alert("Riscos resetados (protótipo UI).");
      refresh();
    });

    // modal: abrir novo
    const modalEl = document.getElementById("risksModal");
    modalEl.addEventListener("show.bs.modal", () => {
      // se não está editando, abre em create
      if (!el.formId.value) openCreate();
    });

    // modal: anexar mock
    el.formEvidenceBtn.addEventListener("click", () => {
      const cur = (el.formEvidence.value || "").trim();
      el.formEvidence.value = cur ? "" : "evidencias-homologacao.pdf";
    });

    // salvar
    el.formSave.addEventListener("click", saveForm);

    // encerrar via modal
    el.formClose.addEventListener("click", () => {
      const id = (el.formId.value || "").trim();
      if (!id) return;
      closeRisk(id);
      // fecha modal depois
      try {
        const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
        modal.hide();
      } catch (e) {}
    });

    // ações na tabela
    document.addEventListener("click", (ev) => {
      const btn = ev.target.closest("[data-action][data-id]");
      if (!btn) return;

      const action = btn.getAttribute("data-action");
      const id = btn.getAttribute("data-id");
      if (!action || !id) return;

      ev.preventDefault();

      if (action === "edit") return openEdit(id);
      if (action === "close") return closeRisk(id);
      if (action === "delete") return deleteRisk(id);
      if (action === "download") return downloadEvidence(id);
    });
  }

  function init() {
    wire();
    refresh();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>


                    <!-- TAB FILES -->
                    <div class="tab-pane" id="tab-files" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body">

                          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                            <div>
                              <h5 class="mb-1">Arquivos</h5>
                              <div class="text-muted fs-12">Biblioteca de evidências e documentos do projeto (uploads e arquivos gerados pelo sistema).</div>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-2">
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filesUploadModal">
                                <i class="ti ti-upload me-1"></i>Enviar arquivo
                              </button>

                              <div class="dropdown">
                                <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                  Ações
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                  <li><a class="dropdown-item" href="#" id="filesExportList"><i class="ti ti-download me-2"></i>Exportar lista</a></li>
                                  <li><a class="dropdown-item" href="#" id="filesGenerateDoc"><i class="ti ti-file-text me-2"></i>Gerar relatório (sistema)</a></li>
                                </ul>
                              </div>
                            </div>
                          </div>

                          <div class="card mb-3 border">
                            <div class="card-body">
                              <div class="row g-2 align-items-end">
                                <div class="col-12 col-lg-4">
                                  <label class="form-label">Buscar</label>
                                  <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-search"></i></span>
                                    <input type="text" class="form-control" id="filesSearch" placeholder="Buscar por nome do arquivo..." />
                                  </div>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Tipo</label>
                                  <select class="form-select" id="filesFilterType">
                                    <option value="all" selected>Todos</option>
                                    <option value="pdf">PDF</option>
                                    <option value="xlsx">XLSX</option>
                                    <option value="csv">CSV</option>
                                    <option value="docx">DOCX</option>
                                    <option value="img">Imagem</option>
                                    <option value="other">Outros</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Origem</label>
                                  <select class="form-select" id="filesFilterSource">
                                    <option value="all" selected>Todas</option>
                                    <option value="upload">Upload</option>
                                    <option value="generated">Sistema</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Autor</label>
                                  <select class="form-select" id="filesFilterAuthor">
                                    <option value="all" selected>Todos</option>
                                    <option value="Luciene Martins">Luciene Martins</option>
                                    <option value="João Santos">João Santos</option>
                                    <option value="Maria Silva">Maria Silva</option>
                                    <option value="Leonardo Queiroz">Leonardo Queiroz</option>
                                    <option value="Sistema GoMAP">Sistema GoMAP</option>
                                  </select>
                                </div>

                                <div class="col-12 col-lg-2 d-flex gap-2 justify-content-end">
                                  <button type="button" class="btn btn-outline-primary w-100" id="filesApplyFilters">
                                    <i class="ti ti-filter me-1"></i>Filtrar
                                  </button>
                                  <button type="button" class="btn btn-light w-100" id="filesClearFilters">
                                    <i class="ti ti-rotate-2 me-1"></i>Limpar
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div id="filesEmptyState" class="d-none">
                            <div class="text-center py-5 text-muted">
                              <div class="avatar-xl mx-auto mb-2">
                                <span class="avatar-title rounded-circle bg-light text-muted">
                                  <i class="ti ti-folder fs-2"></i>
                                </span>
                              </div>
                              <h5 class="mb-1">Nenhum arquivo encontrado</h5>
                              <div class="text-muted">Ajuste os filtros ou limpe para ver todos os arquivos.</div>
                            </div>
                          </div>

                          <div class="table-responsive">
                            <table class="table table-custom table-centered table-hover w-100 mb-0">
                              <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                                <tr class="text-uppercase fs-xxs">
                                  <th>Arquivo</th>
                                  <th style="width: 1%;">Tipo</th>
                                  <th style="width: 1%;">Tamanho</th>
                                  <th style="width: 1%;">Origem</th>
                                  <th style="width: 1%;">Autor</th>
                                  <th style="width: 1%;">Data</th>
                                  <th class="text-center" style="width: 1%;">Ações</th>
                                </tr>
                              </thead>
                              <tbody id="filesTableBody"></tbody>
                            </table>
                          </div>

                          <div class="text-muted fs-12 mt-3">
                            Regra: apenas arquivos de <span class="fw-semibold">Upload</span> podem ser excluídos. Arquivos do <span class="fw-semibold">Sistema</span> são somente leitura.
                          </div>

                        </div>
                      </div>
                    </div>

                    <!-- TAB LOGBOOK -->
                    <div class="tab-pane" id="tab-logbook" role="tabpanel">
                      <div class="card mb-0">
                        <div class="card-body">

                          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                            <div>
                              <h5 class="mb-1">Diário de bordo</h5>
                              <div class="text-muted fs-12">Log de eventos do projeto (manual e sistema), com rastreabilidade e anexos.</div>
                            </div>

                            <div class="d-flex flex-wrap align-items-center gap-2">
                              <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#logbookAddModal">
                                <i class="ti ti-plus me-1"></i>Adicionar
                              </button>
                            </div>
                          </div>

                          <div class="card mb-3 border">
                            <div class="card-body">
                              <div class="row g-2 align-items-end">
                                <div class="col-12 col-lg-4">
                                  <label class="form-label">Buscar</label>
                                  <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-search"></i></span>
                                    <input type="text" class="form-control" id="logbookSearch" placeholder="Buscar por título, descrição, tags..." />
                                  </div>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Autor</label>
                                  <select class="form-select" id="logbookFilterActor">
                                    <option value="all" selected>Todos</option>
                                    <option value="luciene">Luciene Martins</option>
                                    <option value="joao">João Santos</option>
                                    <option value="maria">Maria Silva</option>
                                    <option value="leonardo">Leonardo Queiroz</option>
                                    <option value="sistema">Sistema GoMAP</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Tipo</label>
                                  <select class="form-select" id="logbookFilterType">
                                    <option value="all" selected>Todos</option>
                                    <option value="COMMENT">Comentário</option>
                                    <option value="NOTE">Nota</option>
                                    <option value="DECISION">Decisão</option>
                                    <option value="APPROVAL">Aprovação</option>
                                    <option value="RISK">Risco</option>
                                    <option value="MILESTONE">Marco</option>
                                    <option value="UPLOAD">Upload</option>
                                    <option value="SYSTEM_GENERATED">Gerado pelo sistema</option>
                                  </select>
                                </div>

                                <div class="col-12 col-md-4 col-lg-2">
                                  <label class="form-label">Origem</label>
                                  <select class="form-select" id="logbookFilterSource">
                                    <option value="all" selected>Todas</option>
                                    <option value="manual">Manual</option>
                                    <option value="system">Sistema</option>
                                    <option value="upload">Upload</option>
                                  </select>
                                </div>

                                <div class="col-12 col-lg-2 d-flex gap-2 justify-content-end">
                                  <button type="button" class="btn btn-outline-primary w-100" id="logbookApplyFilters">
                                    <i class="ti ti-filter me-1"></i>Filtrar
                                  </button>
                                  <button type="button" class="btn btn-light w-100" id="logbookClearFilters">
                                    <i class="ti ti-rotate-2 me-1"></i>Limpar
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div id="logbookEmptyState" class="d-none">
                            <div class="text-center py-5 text-muted">
                              <div class="avatar-xl mx-auto mb-2">
                                <span class="avatar-title rounded-circle bg-light text-muted">
                                  <i class="ti ti-notes fs-2"></i>
                                </span>
                              </div>
                              <h5 class="mb-1">Nenhum registro encontrado</h5>
                              <div class="text-muted">Ajuste os filtros ou limpe para ver todos os registros.</div>
                            </div>
                          </div>

                          <div id="logbookTimeline" class="d-flex flex-column gap-2"></div>

                        </div>
                      </div>
                    </div>

                  </div><!-- /tab-content -->

                </div><!-- /card-body -->

              </div><!-- /card -->

            </div>
          </div>

        </div>
      </div>

      @@include('./partials/footer.html')
    </div>

  </div><!-- /wrapper -->

  <!-- MODAL: Upload Arquivo -->
  <div class="modal fade" id="filesUploadModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Enviar arquivo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Nome do arquivo</label>
              <input type="text" class="form-control" id="filesUploadName" placeholder="Ex.: Checklist Go-live.pdf" />
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="filesUploadType">
                <option value="pdf" selected>PDF</option>
                <option value="xlsx">XLSX</option>
                <option value="csv">CSV</option>
                <option value="docx">DOCX</option>
                <option value="img">Imagem</option>
                <option value="other">Outros</option>
              </select>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label">Autor</label>
              <select class="form-select" id="filesUploadAuthor">
                <option value="" selected>Selecione</option>
                <option value="Luciene Martins">Luciene Martins</option>
                <option value="João Santos">João Santos</option>
                <option value="Maria Silva">Maria Silva</option>
                <option value="Leonardo Queiroz">Leonardo Queiroz</option>
              </select>
            </div>

            <div class="col-12">
              <label class="form-label">Descrição (opcional)</label>
              <textarea class="form-control" rows="3" id="filesUploadDesc" placeholder="Observações sobre o arquivo..."></textarea>
            </div>

            <div class="col-12">
              <div class="text-muted fs-12">Protótipo UI: o upload é simulado e o download exibe uma mensagem.</div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="filesUploadSave">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- MODAL: Adicionar Diário -->
  <div class="modal fade" id="logbookAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">Adicionar entrada</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-4">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="logbookAddType">
                <option value="" selected>Selecione</option>
                <option value="COMMENT">Comentário</option>
                <option value="NOTE">Nota</option>
                <option value="UPLOAD">Upload</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Autor</label>
              <select class="form-select" id="logbookAddActor">
                <option value="" selected>Selecione</option>
                <option value="luciene">Luciene Martins</option>
                <option value="joao">João Santos</option>
                <option value="maria">Maria Silva</option>
                <option value="leonardo">Leonardo Queiroz</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Data</label>
              <input type="datetime-local" class="form-control" id="logbookAddDate" />
            </div>

            <div class="col-12">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" id="logbookAddTitle" placeholder="Ex.: Ajuste de escopo, Upload de documento..." />
            </div>

            <div class="col-12">
              <label class="form-label">Descrição</label>
              <textarea class="form-control" id="logbookAddDesc" rows="4" placeholder="Descreva o ocorrido com objetividade."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Anexo (opcional)</label>
              <div class="input-group">
                <input type="text" class="form-control" id="logbookAddFileName" placeholder="Ex.: documento.pdf (mock)" />
                <button class="btn btn-light" type="button" id="logbookAddAttachToggle">
                  <i class="ti ti-paperclip me-1"></i>Anexar (mock)
                </button>
              </div>
              <div class="text-muted fs-12 mt-1">Protótipo UI: o anexo é simulado pelo nome.</div>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="logbookAddSave">
            <i class="ti ti-device-floppy me-1"></i>Salvar
          </button>
        </div>

      </div>
    </div>
  </div>

  

<!-- Modal Nova/Editar Proposta - Captação de Recursos -->
<div class="modal fade" id="funding-proposal-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <div class="d-flex flex-column">
          <h5 class="modal-title mb-0" data-funding-modal-title>Nova proposta de captação</h5>
          <small class="text-muted">Salve como rascunho a qualquer momento. Para avançar de fase, complete os campos obrigatórios da fase.</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-success d-none" role="alert" data-funding-alert-success></div>
        <div class="alert alert-danger d-none" role="alert" data-funding-alert-danger></div>

        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary" data-funding-phase-badge>Em Planejamento</span>
            <span class="text-muted small">Campos são liberados/bloqueados conforme a fase.</span>
          </div>

          <div class="d-flex align-items-center gap-2">
            <label class="text-muted small mb-0">Fase:</label>
            <select class="form-select form-select-sm" style="width: 220px;" data-funding-phase-select>
              <option value="planning">Em Planejamento</option>
              <option value="articulation">Em Articulação</option>
              <option value="formalization">Em Formalização</option>
              <option value="execution">Em Execução</option>
              <option value="archived">Arquivada</option>
            </select>
          </div>
        </div>

        <form data-funding-form class="row g-3"></form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>

        <button type="button" class="btn btn-primary" data-funding-save>
          <i class="ti ti-device-floppy me-1"></i>Salvar rascunho
        </button>

        <button type="button" class="btn btn-success" data-funding-advance>
          <i class="ti ti-arrow-right me-1"></i>Avançar fase
        </button>
      </div>
    </div>
  </div>
</div>

@@include('./partials/footer-scripts.html')

  <script>
    // STORAGE + EVENT BUS (shared)
    (function () {
      window.LOGBOOK_STORAGE_KEY = "gomap_logbook_0006";

      window.readLogbookStorage = function () {
        try {
          const raw = localStorage.getItem(window.LOGBOOK_STORAGE_KEY);
          const data = raw ? JSON.parse(raw) : [];
          return Array.isArray(data) ? data : [];
        } catch (e) {
          return [];
        }
      };

      window.writeLogbookStorage = function (list) {
        localStorage.setItem(window.LOGBOOK_STORAGE_KEY, JSON.stringify(list || []));
      };

      window.addLogbookEntry = function (entry) {
        const list = window.readLogbookStorage();
        list.unshift(entry);
        window.writeLogbookStorage(list);
        window.dispatchEvent(new CustomEvent("gomap:logbook-updated", { detail: { entry } }));
      };

      window.addLogbookEntryFromFile = function (actionType, file, actorKeyOverride) {
        const nowIso = new Date().toISOString();

        const entry = {
          id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
          createdAt: nowIso,
          type: actionType, // "UPLOAD" | "SYSTEM_GENERATED" | "NOTE"
          title:
            actionType === "UPLOAD"
              ? "Upload de arquivo"
              : actionType === "SYSTEM_GENERATED"
              ? "Arquivo gerado pelo sistema"
              : "Arquivo removido",
          description:
            actionType === "UPLOAD"
              ? `Arquivo enviado: ${file.name}`
              : actionType === "SYSTEM_GENERATED"
              ? `Arquivo gerado: ${file.name}`
              : `Arquivo removido: ${file.name}`,
          actorKey: actionType === "SYSTEM_GENERATED" ? "sistema" : (actorKeyOverride || "joao"),
          source: actionType === "UPLOAD" ? "upload" : "system",
          tags: ["Arquivos"],
          attachments: [{ name: file.name, href: "#" }]
        };

        window.addLogbookEntry(entry);
      };
    })();
  </script>

  <script>
    // TAB FILES
    (function () {
      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function toDateLabel(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }

      function iconByType(type) {
        if (type === "pdf") return "ti ti-file-type-pdf";
        if (type === "xlsx") return "ti ti-file-spreadsheet";
        if (type === "csv") return "ti ti-file-text";
        if (type === "docx") return "ti ti-file-text";
        if (type === "img") return "ti ti-photo";
        return "ti ti-file";
      }

      function badgeBySource(source) {
        return source === "generated" ? "badge-soft-dark" : "badge-soft-primary";
      }

      function labelBySource(source) {
        return source === "generated" ? "Sistema" : "Upload";
      }

      function normalizeTypeFromName(name, fallbackType) {
        const n = (name || "").toLowerCase();
        if (n.endsWith(".pdf")) return "pdf";
        if (n.endsWith(".xlsx") || n.endsWith(".xls")) return "xlsx";
        if (n.endsWith(".csv")) return "csv";
        if (n.endsWith(".docx") || n.endsWith(".doc")) return "docx";
        if (n.endsWith(".png") || n.endsWith(".jpg") || n.endsWith(".jpeg") || n.endsWith(".webp")) return "img";
        return fallbackType || "other";
      }

      let files = [
        { id: "F-003", name: "Relatório de conciliação - Janeiro 2026.csv", type: "csv", size: "310 KB", source: "generated", author: "Sistema GoMAP", createdAt: "2026-01-18T07:10:00-03:00" },
        { id: "F-002", name: "Matriz de eventos de webhook.xlsx", type: "xlsx", size: "420 KB", source: "generated", author: "Sistema GoMAP", createdAt: "2025-12-20T10:05:00-03:00" },
        { id: "F-001", name: "Especificação de Integração - Pagamentos v1.3.pdf", type: "pdf", size: "1.8 MB", source: "upload", author: "João Santos", createdAt: "2025-10-12T15:22:00-03:00" }
      ];

      const el = {
        body: document.getElementById("filesTableBody"),
        empty: document.getElementById("filesEmptyState"),

        search: document.getElementById("filesSearch"),
        fType: document.getElementById("filesFilterType"),
        fSource: document.getElementById("filesFilterSource"),
        fAuthor: document.getElementById("filesFilterAuthor"),
        apply: document.getElementById("filesApplyFilters"),
        clear: document.getElementById("filesClearFilters"),

        exportList: document.getElementById("filesExportList"),
        generateDoc: document.getElementById("filesGenerateDoc"),

        uploadName: document.getElementById("filesUploadName"),
        uploadType: document.getElementById("filesUploadType"),
        uploadAuthor: document.getElementById("filesUploadAuthor"),
        uploadDesc: document.getElementById("filesUploadDesc"),
        uploadSave: document.getElementById("filesUploadSave")
      };

      function getFiltered() {
        const q = (el.search.value || "").trim().toLowerCase();
        const type = el.fType.value || "all";
        const source = el.fSource.value || "all";
        const author = el.fAuthor.value || "all";

        return files
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .filter((f) => {
            const blob = [f.id, f.name, f.type, f.size, f.source, f.author].join(" ").toLowerCase();
            const matchQ = !q || blob.includes(q);
            const matchType = type === "all" || f.type === type;
            const matchSource = source === "all" || f.source === source;
            const matchAuthor = author === "all" || f.author === author;
            return matchQ && matchType && matchSource && matchAuthor;
          });
      }

      function render(list) {
        el.body.innerHTML = "";
        el.empty.classList.toggle("d-none", list.length > 0);

        list.forEach((f) => {
          const canDelete = f.source === "upload";

          const tr = document.createElement("tr");
          tr.setAttribute("data-id", f.id);
          tr.innerHTML = `
            <td>
              <div class="d-flex align-items-center gap-2">
                <span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:28px;height:28px;">
                  <i class="${esc(iconByType(f.type))}"></i>
                </span>
                <div class="fw-medium">${esc(f.name)}</div>
              </div>
            </td>
            <td class="text-muted">${esc(f.type.toUpperCase())}</td>
            <td class="text-muted">${esc(f.size)}</td>
            <td><span class="badge ${esc(badgeBySource(f.source))} fs-xxs">${esc(labelBySource(f.source))}</span></td>
            <td class="text-muted">${esc(f.author)}</td>
            <td class="text-muted">${esc(toDateLabel(f.createdAt))}</td>
            <td class="text-center">
              <div class="d-flex justify-content-center gap-1">
                <button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(f.id)}" title="Download">
                  <i class="ti ti-download"></i>
                </button>
                <button class="btn btn-light btn-sm" type="button" data-action="view" data-id="${esc(f.id)}" title="Visualizar">
                  <i class="ti ti-eye"></i>
                </button>
                ${
                  canDelete
                    ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(f.id)}" title="Excluir"><i class="ti ti-trash"></i></button>`
                    : `<button class="btn btn-light btn-sm" type="button" disabled title="Arquivo do sistema não pode ser excluído."><i class="ti ti-lock"></i></button>`
                }
              </div>
            </td>
          `;
          el.body.appendChild(tr);
        });
      }

      function refresh() {
        render(getFiltered());
      }

      function downloadFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;
        alert(`Download do Arquivo: ${f.name}`);
      }

      function viewFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;
        alert(`Visualizar Arquivo: ${f.name}`);
      }

      function deleteFile(id) {
        const f = files.find(x => x.id === id);
        if (!f) return;

        if (f.source !== "upload") {
          alert("Arquivo do sistema não pode ser excluído.");
          return;
        }

        const ok = confirm("Excluir este arquivo? Esta ação é apenas um protótipo UI.");
        if (!ok) return;

        files = files.filter(x => x.id !== id);

        // registra no diário
        window.addLogbookEntryFromFile("NOTE", { name: f.name }, "joao");

        refresh();
      }

      function wireHandlers() {
        document.addEventListener("click", (ev) => {
          const btn = ev.target.closest("[data-action]");
          if (!btn) return;

          const action = btn.getAttribute("data-action");
          const id = btn.getAttribute("data-id");
          if (!action || !id) return;

          ev.preventDefault();

          if (action === "download") return downloadFile(id);
          if (action === "view") return viewFile(id);
          if (action === "delete") return deleteFile(id);
        });

        el.apply.addEventListener("click", refresh);

        el.clear.addEventListener("click", () => {
          el.search.value = "";
          el.fType.value = "all";
          el.fSource.value = "all";
          el.fAuthor.value = "all";
          refresh();
        });

        el.search.addEventListener("input", () => {
          clearTimeout(el.search._t);
          el.search._t = setTimeout(refresh, 150);
        });

        el.exportList.addEventListener("click", (e) => {
          e.preventDefault();
          alert("Exportar lista (protótipo UI).");
        });

        el.generateDoc.addEventListener("click", (e) => {
          e.preventDefault();

          const now = new Date();
          const dd = String(now.getDate()).padStart(2, "0");
          const mm = String(now.getMonth() + 1).padStart(2, "0");
          const yy = now.getFullYear();

          const newFile = {
            id: `F-${String(Math.floor(Math.random() * 900) + 100)}`,
            name: `Relatório de conciliação - ${dd}-${mm}-${yy}.csv`,
            type: "csv",
            size: "280 KB",
            source: "generated",
            author: "Sistema GoMAP",
            createdAt: now.toISOString()
          };

          files.unshift(newFile);

          // registra no diário
          window.addLogbookEntryFromFile("SYSTEM_GENERATED", { name: newFile.name }, "sistema");

          alert("Arquivo gerado pelo sistema (protótipo UI).");
          refresh();
        });

        el.uploadSave.addEventListener("click", () => {
          const nameRaw = (el.uploadName.value || "").trim();
          const author = (el.uploadAuthor.value || "").trim();
          const typeRaw = (el.uploadType.value || "other").trim();

          if (!nameRaw || !author) {
            alert("Preencha o nome do arquivo e o autor.");
            return;
          }

          const type = normalizeTypeFromName(nameRaw, typeRaw);

          const newFile = {
            id: `F-${String(Math.floor(Math.random() * 900) + 100)}`,
            name: nameRaw,
            type: type,
            size: "—",
            source: "upload",
            author: author,
            createdAt: new Date().toISOString()
          };

          files.unshift(newFile);

          // registra no diário
          window.addLogbookEntryFromFile("UPLOAD", { name: newFile.name }, author === "Luciene Martins" ? "luciene" : "joao");

          const modalEl = document.getElementById("filesUploadModal");
          try {
            const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
            modal.hide();
          } catch (e) {}

          el.uploadName.value = "";
          el.uploadAuthor.value = "";
          el.uploadDesc.value = "";
          el.uploadType.value = "pdf";

          alert("Arquivo enviado (protótipo UI).");
          refresh();
        });
      }

      function init() {
        wireHandlers();
        refresh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>

  <script>
    // TAB LOGBOOK
    (function () {
      const actors = {
        luciene: { key: "luciene", name: "Luciene Martins", role: "Responsável", avatar: "assets/images/users/user-3.jpg", type: "user" },
        joao: { key: "joao", name: "João Santos", role: "Integração", avatar: "assets/images/users/user-5.jpg", type: "user" },
        maria: { key: "maria", name: "Maria Silva", role: "Negócio", avatar: "assets/images/users/user-2.jpg", type: "user" },
        leonardo: { key: "leonardo", name: "Leonardo Queiroz", role: "Arquitetura", avatar: "assets/images/users/user-7.jpg", type: "user" },
        sistema: { key: "sistema", name: "Sistema GoMAP", role: "Sistema", avatar: null, type: "system" }
      };

      const typeMeta = {
        COMMENT: { label: "Comentário", badge: "badge-soft-secondary" },
        NOTE: { label: "Nota", badge: "badge-soft-primary" },
        DECISION: { label: "Decisão", badge: "badge-soft-warning" },
        APPROVAL: { label: "Aprovação", badge: "badge-soft-info" },
        RISK: { label: "Risco", badge: "badge-soft-danger" },
        MILESTONE: { label: "Marco", badge: "badge-soft-success" },
        UPLOAD: { label: "Upload", badge: "badge-soft-primary" },
        SYSTEM_GENERATED: { label: "Sistema", badge: "badge-soft-dark" }
      };

      const deletableTypes = new Set(["COMMENT", "NOTE", "UPLOAD"]);

      const el = {
        timelineWrap: document.getElementById("logbookTimeline"),
        empty: document.getElementById("logbookEmptyState"),

        search: document.getElementById("logbookSearch"),
        fActor: document.getElementById("logbookFilterActor"),
        fType: document.getElementById("logbookFilterType"),
        fSource: document.getElementById("logbookFilterSource"),
        apply: document.getElementById("logbookApplyFilters"),
        clear: document.getElementById("logbookClearFilters"),

        addType: document.getElementById("logbookAddType"),
        addActor: document.getElementById("logbookAddActor"),
        addDate: document.getElementById("logbookAddDate"),
        addTitle: document.getElementById("logbookAddTitle"),
        addDesc: document.getElementById("logbookAddDesc"),
        addFileName: document.getElementById("logbookAddFileName"),
        addAttachToggle: document.getElementById("logbookAddAttachToggle"),
        addSave: document.getElementById("logbookAddSave")
      };

      function esc(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#39;");
      }

      function toDateLabel(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return iso;
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        const hh = String(d.getHours()).padStart(2, "0");
        const mi = String(d.getMinutes()).padStart(2, "0");
        return `${dd}/${mm}/${yy} ${hh}:${mi}`;
      }

      function isDeletable(entry) {
        return deletableTypes.has(entry.type);
      }

      function iconByType(type) {
        if (type === "UPLOAD") return "ti ti-upload";
        if (type === "SYSTEM_GENERATED") return "ti ti-cpu";
        if (type === "APPROVAL") return "ti ti-check";
        if (type === "DECISION") return "ti ti-gavel";
        if (type === "RISK") return "ti ti-alert-triangle";
        if (type === "MILESTONE") return "ti ti-flag";
        if (type === "NOTE") return "ti ti-note";
        return "ti ti-message-circle";
      }

      // base (mock)
      let entries = [
        {
          id: "LG-021",
          createdAt: "2026-01-18T10:20:00-03:00",
          type: "SYSTEM_GENERATED",
          title: "Rotina de conciliação diária executada",
          description: "Conciliação concluída (PIX e cartão). Divergências: 2 registros em análise (pendente de confirmação do provedor).",
          actorKey: "sistema",
          source: "system",
          tags: ["Conciliação", "Rotina"],
          attachments: [{ name: "Relatório de conciliação - Janeiro 2026.csv", href: "#" }]
        },
        {
          id: "LG-020",
          createdAt: "2026-01-10T16:40:00-03:00",
          type: "MILESTONE",
          title: "Webhooks estabilizados com idempotência",
          description: "Eventos padronizados e idempotência por chave de transação aplicada. Retentativas com backoff configuradas.",
          actorKey: "joao",
          source: "manual",
          tags: ["Webhooks", "Idempotência"],
          attachments: []
        },
        {
          id: "LG-018",
          createdAt: "2025-12-18T14:10:00-03:00",
          type: "APPROVAL",
          title: "Homologação concluída (PIX + Cartão)",
          description: "Casos aprovados: aprovado/recusado, cancelamento, estorno, chargeback simulado e conciliação por arquivo.",
          actorKey: "maria",
          source: "manual",
          tags: ["Homologação"],
          attachments: []
        },
        {
          id: "LG-016",
          createdAt: "2025-11-15T11:00:00-03:00",
          type: "DECISION",
          title: "Definição do provedor e modelo de integração",
          description: "Escolha orientada por suporte a PIX, cartão, webhooks e conciliação. Início do sandbox e credenciais.",
          actorKey: "luciene",
          source: "manual",
          tags: ["Decisão"],
          attachments: []
        }
      ];

      function getFiltered() {
        const q = (el.search.value || "").trim().toLowerCase();
        const actor = el.fActor.value || "all";
        const type = el.fType.value || "all";
        const source = el.fSource.value || "all";

        return entries
          .slice()
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .filter((e) => {
            const a = actors[e.actorKey] || actors.sistema;
            const blob = [
              e.id, e.type, e.title, e.description, e.source, a.name, a.role,
              ...(e.tags || []),
              ...((e.attachments || []).map(x => x.name))
            ].join(" ").toLowerCase();

            const matchQ = !q || blob.includes(q);
            const matchActor = actor === "all" || e.actorKey === actor;
            const matchType = type === "all" || e.type === type;
            const matchSource = source === "all" || (e.source === source);

            return matchQ && matchActor && matchType && matchSource;
          });
      }

      function renderTimeline(list) {
        el.timelineWrap.innerHTML = "";

        list.forEach((e) => {
          const a = actors[e.actorKey] || actors.sistema;
          const t = typeMeta[e.type] || { label: e.type, badge: "badge-soft-secondary" };
          const canDelete = isDeletable(e);

          const hasAttach = (e.attachments || []).length > 0;
          const attach = hasAttach ? e.attachments[0] : null;

          const avatarHtml = a.avatar
            ? `<img src="${esc(a.avatar)}" class="rounded-circle" style="width:24px;height:24px;object-fit:cover;" alt="${esc(a.name)}">`
            : `<span class="avatar-xs rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:24px;height:24px;"><i class="ti ti-cpu fs-6"></i></span>`;

          const downloadBtn = attach
            ? `<button class="btn btn-light btn-sm" type="button" data-action="download" data-id="${esc(e.id)}"><i class="ti ti-download me-1"></i>Download</button>`
            : "";

          const deleteBtn = canDelete
            ? `<button class="btn btn-light btn-sm" type="button" data-action="delete" data-id="${esc(e.id)}"><i class="ti ti-trash"></i></button>`
            : `<button class="btn btn-light btn-sm" type="button" disabled title="Não é possível excluir este tipo de registro."><i class="ti ti-lock"></i></button>`;

          const tagsHtml = (e.tags || []).slice(0, 3).map(tag => `<span class="badge badge-soft-primary fs-xxs">#${esc(tag)}</span>`).join(" ");

          const row = document.createElement("div");
          row.className = "border rounded p-3";
          row.setAttribute("data-id", e.id);

          row.innerHTML = `
            <div class="d-flex align-items-start gap-3">
              <div class="flex-shrink-0">
                <span class="avatar-sm rounded-circle bg-light text-muted d-inline-flex align-items-center justify-content-center" style="width:36px;height:36px;">
                  <i class="${esc(iconByType(e.type))}"></i>
                </span>
              </div>

              <div class="flex-grow-1">
                <div class="d-flex flex-wrap align-items-center gap-2">
                  <span class="badge ${esc(t.badge)} fs-xxs">${esc(t.label)}</span>
                  <div class="fw-semibold">${esc(e.title)}</div>
                  <div class="text-muted ms-auto fs-12">${esc(toDateLabel(e.createdAt))}</div>
                </div>

                <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
                  ${avatarHtml}
                  <span class="fw-medium">${esc(a.name)}</span>
                  <span class="text-muted">•</span>
                  <span class="text-muted fs-12">${esc(a.type === "system" ? "Sistema" : a.role)}</span>
                  ${hasAttach ? `<span class="text-muted">•</span><span class="badge badge-soft-primary fs-xxs">#Anexo</span>` : ``}
                  <span class="ms-auto d-flex align-items-center gap-2">
                    ${downloadBtn}
                    ${deleteBtn}
                  </span>
                </div>

                <div class="text-muted mt-2">${esc(e.description)}</div>

                ${tagsHtml ? `<div class="mt-2 d-flex flex-wrap gap-1">${tagsHtml}</div>` : ``}
              </div>
            </div>
          `;

          el.timelineWrap.appendChild(row);
        });
      }

      function updateEmptyState(list) {
        el.empty.classList.toggle("d-none", list.length > 0);
      }

      function refresh() {
        const list = getFiltered();
        updateEmptyState(list);
        renderTimeline(list);
      }

      function deleteEntry(id) {
        const entry = entries.find(x => x.id === id);
        if (!entry) return;

        if (!isDeletable(entry)) {
          alert("Este tipo de registro não pode ser excluído.");
          return;
        }

        const ok = confirm("Excluir esta entrada do diário de bordo? Esta ação removerá da timeline.");
        if (!ok) return;

        entries = entries.filter(x => x.id !== id);

        // se essa entry veio do storage, remove do storage também
        const st = window.readLogbookStorage();
        const next = st.filter(x => x && x.id !== id);
        window.writeLogbookStorage(next);

        refresh();
      }

      function downloadEntry(id) {
        const entry = entries.find(x => x.id === id);
        if (!entry) return;

        const att = (entry.attachments || [])[0];
        if (!att) return;

        alert(`Download do Arquivo: ${att.name}`);
      }

      function wireHandlers() {
        document.addEventListener("click", (ev) => {
          const del = ev.target.closest('[data-action="delete"]');
          if (del) {
            ev.preventDefault();
            const id = del.getAttribute("data-id");
            if (id) deleteEntry(id);
            return;
          }

          const dl = ev.target.closest('[data-action="download"]');
          if (dl) {
            ev.preventDefault();
            const id = dl.getAttribute("data-id");
            if (id) downloadEntry(id);
            return;
          }
        });
      }

      function nowLocalForInput() {
        const d = new Date();
        const pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }

      function addEntryFromModal() {
        const type = el.addType.value;
        const actorKey = el.addActor.value;
        const date = el.addDate.value;
        const title = (el.addTitle.value || "").trim();
        const desc = (el.addDesc.value || "").trim();
        const fileName = (el.addFileName.value || "").trim();

        if (!type || !actorKey || !date || !title || !desc) {
          alert("Preencha tipo, autor, data, título e descrição.");
          return;
        }

        const entry = {
          id: `LG-${String(Math.floor(Math.random() * 900) + 100)}`,
          createdAt: new Date(date).toISOString(),
          type: type,
          title: title,
          description: desc,
          actorKey: actorKey,
          source: type === "UPLOAD" ? "upload" : "manual",
          tags: [],
          attachments: fileName ? [{ name: fileName, href: "#" }] : []
        };

        // grava no storage (assim aparece sempre)
        window.addLogbookEntry(entry);

        const modalEl = document.getElementById("logbookAddModal");
        try {
          const modal = window.bootstrap?.Modal?.getInstance(modalEl) || new window.bootstrap.Modal(modalEl);
          modal.hide();
        } catch (e) {}

        el.addType.value = "";
        el.addActor.value = "";
        el.addDate.value = nowLocalForInput();
        el.addTitle.value = "";
        el.addDesc.value = "";
        el.addFileName.value = "";

        // o listener abaixo vai recarregar; mas fazemos refresh por segurança visual
        refresh();
      }

      function init() {
        if (el.addDate) el.addDate.value = nowLocalForInput();

        // 1) carrega o que já existe no storage e coloca no topo
        const st = window.readLogbookStorage();
        entries = [...st, ...entries];

        // 2) quando arquivos (ou qualquer coisa) atualizar o log, re-carrega do storage
        window.addEventListener("gomap:logbook-updated", () => {
          const latest = window.readLogbookStorage();
          entries = [...latest, ...entries.filter(e => !String(e.id || "").startsWith("LG-"))];
          refresh();
        });

        el.apply.addEventListener("click", refresh);

        el.clear.addEventListener("click", () => {
          el.search.value = "";
          el.fActor.value = "all";
          el.fType.value = "all";
          el.fSource.value = "all";
          refresh();
        });

        el.search.addEventListener("input", () => {
          clearTimeout(el.search._t);
          el.search._t = setTimeout(refresh, 150);
        });

        el.addAttachToggle.addEventListener("click", () => {
          const cur = (el.addFileName.value || "").trim();
          el.addFileName.value = cur ? "" : "evidencia-integracao.pdf";
        });

        el.addSave.addEventListener("click", addEntryFromModal);

        wireHandlers();
        refresh();
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
      } else {
        init();
      }
    })();
  </script>



<script>
/* ============================
   Captação de Recursos (mock)
   Regras baseadas na planilha "CAPTAÇÃO DE RECURSOS"
   - Campos em amarelo foram excluídos
   ============================ */

window.__FUNDING_FIELDS__ = [{"kind": "field", "label": "Depende de Captação de Recurso Externo?", "component": "Checkbox", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": ""}, {"kind": "field", "label": "Incluir no caderno de emendas", "component": "Checkbox", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": ""}, {"kind": "field", "label": "Área temática", "component": "Lista (multi select)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Agricultura, Tecnologia, Infraestrutura... (mesma atual do GOMAP)"}, {"kind": "field", "label": "Tipo de despesa", "component": "Lista (multi select)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Obra, Equipamento, Serviço, Custeio,"}, {"kind": "field", "label": "Objetivo", "component": "Texto", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Descrição do objeto/ Nao pode ser alterado após formalização"}, {"kind": "field", "label": "Problema a resolver", "component": "Texto", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Descrição do problema a ser resolvido"}, {"kind": "field", "label": "Público Alvo", "component": "Texto", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Descrição do público-alvo"}, {"kind": "field", "label": "Resultado esperado", "component": "Texto", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Descrição do resultado esperado em curto prazo"}, {"kind": "field", "label": "Data início/previsão", "component": "Data (DD/MM/AAAA)", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Data"}, {"kind": "field", "label": "Tempo estimado execução", "component": "Número", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Em meses"}, {"kind": "field", "label": "Municípios Beneficiados", "component": "Número", "planning": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "articulation": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "formalization": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Seleção de lista"}, {"kind": "field", "label": "Valor repasse estimado", "component": "Número (Decimal)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "R$"}, {"kind": "field", "label": "Valor contrapartida estimado", "component": "Número (Decimal)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "R$"}, {"kind": "field", "label": "Valor total estimado", "component": "Número (Decimal)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Soma do valor estimado de custeio e de despesa"}, {"kind": "field", "label": "Valor custeio/despesas (GND3) estimado", "component": "Número (Decimal)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Valor"}, {"kind": "field", "label": "Valor de investimento (GND4) estimado", "component": "Número (Decimal)", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Valor"}, {"kind": "field", "label": "Permite atendimento parcial do objeto", "component": "Checkbox", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Sim / Não"}, {"kind": "field", "label": "Contrapartida prevista no orçamento?", "component": "Checkbox", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Sim / Não"}, {"kind": "field", "label": "Aplicável à captação via emenda parlamentar", "component": "Lista", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": ""}, {"kind": "field", "label": "Proposta detalhada/Plano de trabalho elaborado", "component": "Lista", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": ""}, {"kind": "field", "label": "Proposta já está em negociação/articulação", "component": "Checkbox", "planning": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Sim / Não"}, {"kind": "field", "label": "Nome do parceiro (da negociação)", "component": "Texto", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Campo é exibido se pergunta anterior: Proposta já está em Articulação? = SIM"}, {"kind": "field", "label": "Tipo de Concedente", "component": "Lista", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Governo federal; Outras parcerias; adicionar a possibilidade de mais de um concedente"}, {"kind": "field", "label": "Nome do Concedente/Parceiro", "component": "Lista (multi select)", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "adicionar a possibilidade de mais de um concedente"}, {"kind": "field", "label": "Órgão Concedente Vinculado", "component": "Lista", "planning": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "articulation": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Nome do Ministério a qual a possivel Adm Indireta está jurisdicionada"}, {"kind": "field", "label": "Ano da Proposta", "component": "Número", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Data do cadastramento da proposta no sistema. Limitar ao tamanho de 4 caracteres."}, {"kind": "field", "label": "Nº da Proposta", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Número que o sistema federal gera para identificar o cadastro"}, {"kind": "field", "label": "Número do Programa", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Número que o sistema federal gera para identificar a oportunidade"}, {"kind": "field", "label": "Nome do programa/Ação", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OPCIONAL", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "nome que o sistema federal gera para identificar a oportunidade"}, {"kind": "field", "label": "Processo SEI Formalização", "component": "Número", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Limitar tamanho a 15 caracteres."}, {"kind": "field", "label": "Data da Formalização / Início de vigência", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Inicio de vigência ou de assinatura do termo ou do pagamento (caso das transferências especiais)"}, {"kind": "field", "label": "Tipo de Instrumento", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Manter lista GOMAP e acrescentar Novo PAC , Operação de Crédito"}, {"kind": "field", "label": "Nº da Emenda", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "20 caracteres"}, {"kind": "field", "label": "Autor da Emenda", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "listar parlamentares ativos"}, {"kind": "field", "label": "RP / Tipo de Emenda", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Individual RP6 (finalidade definida), Individual RP6 (transferência especial), Bancada RP7, Relator RP9, Comissão RP8 e Bancada RP2"}, {"kind": "field", "label": "Ofício do Parlamentar", "component": "Upload arquivo", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Campo para anexar o arquivo do ofício do parlamentar. Aceitar extensão PDF ou DOC"}, {"kind": "field", "label": "Sistema", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Transferegov, investsus..."}, {"kind": "field", "label": "Valor Global", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Todos os campos referente a valores que estão na aba 3 podem permanecer"}, {"kind": "field", "label": "Valor de Repasse Formalizado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Possível de ser extraído do Transferegov"}, {"kind": "field", "label": "Valor da Contrapartida Formalizado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Possível de ser extraído do Transferegov"}, {"kind": "field", "label": "Valor custeio/despesas (GND3) Formalizado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Soma do gnd 3 + 4 devem bater com o total do global"}, {"kind": "field", "label": "Valor de investimento (GND4) Formalizado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Seguir regra que já está no gomap"}, {"kind": "field", "label": "Empenho pelo Concedente (Sim/Não)", "component": "SIM/NÃO", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Possível de ser extraído do Transferegov"}, {"kind": "field", "label": "Termo assinado (Sim/Não/Não se Aplica)", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "execution": {"req": "BLOQUEADO", "edit": "BLOQUEADO"}, "notes": "Possível de ser extraído do Transferegov"}, {"kind": "field", "label": "Banco", "component": "Número inteiro", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Número do banco"}, {"kind": "field", "label": "Agência", "component": "Número", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Numero da agência"}, {"kind": "field", "label": "Conta", "component": "Número", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Numero da conta do instrumento"}, {"kind": "field", "label": "Status do Instrumento", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Cancelado\nCláusula suspensiva\nEm estruturação (Não iniciado)\nParalisado\nEm execução\nEm prestação de contas\nPrestação de contas aprovada (concluído)\nPrestação de contas enviada\nPrestação de contas rejeitada\nTomada de contas especial\nPrestação de contas em complementação\nDistrato - Em prestação de contas\nDistrato - Prestação de contas concluída\nDistrato - Prestação de contas aprovada com ressalvas"}, {"kind": "field", "label": "Data de retirada Cláusula Suspensiva", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Data que a mandatária deu o parecer positivo e autorizou a execução, quando o status = clausula suspensiva"}, {"kind": "field", "label": "Final da vigência", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Colocar notificação com o prazo de 75 antes do final da vigência e 20 dias antes do final"}, {"kind": "field", "label": "Termos aditivos", "component": "Botão Adicionar", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "quando for o caso ter a opção de incluir os termos aditivos (data de inicio e fim)"}, {"kind": "field", "label": "Prazo Final Prestação de Contas", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "colocar notificação com o prazo 60 e 10 dias antes do final (data de inicio e fim)"}, {"kind": "field", "label": "Unidade Orçamentária", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Código orçamentário do órgão previsto na LOA"}, {"kind": "field", "label": "Valor total do Projeto", "component": "Decimal", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Repasse total + contrapartida total + aporte complementar + rendimento aprovado (sistema calcula sozinho)"}, {"kind": "field", "label": "Fonte do Repasse", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "código da fonte de despesa que será gasto o valor do repasse federal"}, {"kind": "field", "label": "Valor de Custeio Repasse", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor repassado pelo ente federal que será gasto com despesa de custeio"}, {"kind": "field", "label": "Valor de Investimento Repasse", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor repassado pelo ente federal que será gasto com despesa de investimento"}, {"kind": "field", "label": "Repasse total", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "repasse de repasse formalizado + aditivo de repasse (sistema calcula automático)"}, {"kind": "field", "label": "Repasse desembolsado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Guia de Receita (puxa do Siofi)"}, {"kind": "field", "label": "Data do repasse desembolsado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Guia de Receita (puxa do Siofi)"}, {"kind": "field", "label": "Repasse pendente", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "repasse  - repasse desembolsado (sistema calcula)"}, {"kind": "field", "label": "Fonte da Contrapartida", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "código da fonte de despesa que será gasto o valor da contrapartida - recursos do tesouro estadual"}, {"kind": "field", "label": "Valor de Custeio de Contrapartida", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor da contrapartida que será gasto com despesa de custeio"}, {"kind": "field", "label": "Valor de Investimento de Contrapartida", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor da contrapartida que será gasto com despesa de investimento"}, {"kind": "field", "label": "Contrapartida total", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "valor da contrapartida formalizado + aditivo de contrapartida (sistema calcula automático)"}, {"kind": "field", "label": "Contrapartida desembolsada", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Op extra (puxa do siofi)"}, {"kind": "field", "label": "Data da contrapartida desembolsada", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Op extra (puxa do siofi)"}, {"kind": "field", "label": "Contrapartida pendente", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "contrapartida - contrapartida desembolsada (sistema calcula)"}, {"kind": "field", "label": "Rendimento disponível", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor dorendimento dísponivel na conta ( sem autorização de gasto do ministério)"}, {"kind": "field", "label": "Rendimento aprovado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor do rendimento a ser usado, autorizado pelo Ministério."}, {"kind": "field", "label": "Finalidade do Aditivo", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Supressão/ Acréscimo de contrapartida/ Aporte..."}, {"kind": "field", "label": "Aditivo de Repasse", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Aumento ou supressão sobre o valor que foi pactuado inicialmente."}, {"kind": "field", "label": "Aditivo de Contrapartida", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Aumento ou supressão sobre o valor que foi pactuado inicialmente."}, {"kind": "field", "label": "Aporte Complementar", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Recurso do tesouro que não esta previsto no instrumento e que não demanda termo aditivo."}, {"kind": "field", "label": "Nº Processo SEI da Execução do Instrumento", "component": "Número inteiro (15 caracteres)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Número do processo no sistema SEI que será ultilizado para procedimentos licitatórios."}, {"kind": "field", "label": "Metas", "component": "quantidade", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "número (ex: primeira linha meta 1, segunda linha meta 2 ....) para cada meta vai ter um status de estruturação"}, {"kind": "field", "label": "Status da estruturação", "component": "Lista", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "(Não iniciado, Requisição de despesa, TR, Orçamento, minuta de edital, parecer jurídico, publicação do edital, adjudicação, homologação )"}, {"kind": "field", "label": "Valor Empenhado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Calculado pelo sistema automático"}, {"kind": "field", "label": "Valor liquidado", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Calculado pelo sistema automático"}, {"kind": "field", "label": "Valor Pago", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Calculado pelo sistema automático"}, {"kind": "section", "label": "Dados do PDF"}, {"kind": "field", "label": "Número do PDF", "component": "Grid", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "número do PDF, Data do empenho, número do empenho, valor do empenho, data da liquidação, valor da liquidação, data do pagamento, valor da parcela paga, fonte) puxa do AFT e Siofi"}, {"kind": "field", "label": "Tipo de PDF", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Data do empenho", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Número do empenho", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Valor do empenho", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Data da liquidação", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Valor da liquidação", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Data do pagamento", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Valor da parcela paga", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Fonte", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": ""}, {"kind": "field", "label": "Percentual Financeiro Executado (%)", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "(sistema calcula automático)"}, {"kind": "field", "label": "Percentual de Execução Física", "component": "Número (%)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Percentual da execução do objeto (total) usuário vai digitar"}, {"kind": "field", "label": "Data do último pagamento", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Data do último OBTV"}, {"kind": "field", "label": "Ano Prestação de Contas", "component": "Número inteiro (4 caracteres)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Ano que foi enviado a prestação de contas pelo órgão."}, {"kind": "field", "label": "Dias sem execução financeira", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "sistema calcula automático - =hoje - data do ultimo pagamento"}, {"kind": "field", "label": "Saldo a devolver UNIÃO", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor residual do Repasse e rendimento, que não foi ultilizado para execução do projeto"}, {"kind": "field", "label": "Saldo a devolver ESTADO", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Valor residual da contrapartida e rendimento que não foi ultilizado na execução do instrumento."}, {"kind": "field", "label": "Saldo a devolver TOTAL", "component": "Número (Decimal)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Soma do saldo a devolver da União e Estado ( sistema calcula automaticamente)"}, {"kind": "field", "label": "Ano da devolução", "component": "Número inteiro (4 caracteres)", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Ano que foi devolvido o saldo. (OBTV)"}, {"kind": "field", "label": "Data do inicio da obra", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Inicio das ações da empresa no canteiro de obras. Obrigatório se for projeto = OBRA"}, {"kind": "field", "label": "Tempo de obra", "component": "Número", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "sistema calcula automático - =hoje - data do inicio da obra. Obrigatório projeto = OBRA"}, {"kind": "field", "label": "Data de Paralisação da Obra", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "considerar paralisada quando a obra estiver sem movimentação a partir de 90 dias. Obrigatório projeto = Obra e situação = Paralisado"}, {"kind": "field", "label": "Data de Retomada da Obra", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Data em que a obra retomou as ações"}, {"kind": "field", "label": "Data da conclusão da obra", "component": "Data", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "Data da entrega ( 100 % finalizada)"}, {"kind": "field", "label": "Observação / Acompanhamento", "component": "Texto", "planning": {"req": "N/A", "edit": "N/A"}, "articulation": {"req": "N/A", "edit": "N/A"}, "formalization": {"req": "N/A", "edit": "N/A"}, "execution": {"req": "OBRIGATÓRIO", "edit": "EDITÁVEL"}, "notes": "observação"}];

document.addEventListener('DOMContentLoaded', () => {
  const tab = document.getElementById('tab-funding');
  if (!tab) return;

  const listEl = tab.querySelector('[data-funding-list]');
  const countEl = tab.querySelector('[data-funding-count]');

  

  const searchEl = tab.querySelector('[data-funding-search]');
  const statusFilterEl = tab.querySelector('[data-funding-status-filter]');
  const emptyStateEl = tab.querySelector('#fundingEmptyState');
  const tableWrapEl = tab.querySelector('.table-responsive');
  const applyBtn = tab.querySelector('#fundingApplyFilter') || tab.querySelector('[data-funding-apply]');
  const clearBtn = tab.querySelector('#fundingClearFilter') || tab.querySelector('[data-funding-clear]');

  // badges (espelho do Riscos)
  const badgePlanning = tab.querySelector('#fundingCountPlanning');
  const badgeArticulation = tab.querySelector('#fundingCountArticulation');
  const badgeFormalization = tab.querySelector('#fundingCountFormalization');
  const badgeExecution = tab.querySelector('#fundingCountExecution');
  const badgeArchived = tab.querySelector('#fundingCountArchived');

  const phaseCards = {
    planning: tab.querySelector('[data-funding-card-count="planning"]'),
    articulation: tab.querySelector('[data-funding-card-count="articulation"]'),
    formalization: tab.querySelector('[data-funding-card-count="formalization"]'),
    execution: tab.querySelector('[data-funding-card-count="execution"]'),
  };

const modalEl = document.getElementById('funding-proposal-modal');
  const modalTitle = modalEl?.querySelector('[data-funding-modal-title]');
  const formEl = modalEl?.querySelector('[data-funding-form]');
  const phaseSelect = modalEl?.querySelector('[data-funding-phase-select]');
  const phaseBadge = modalEl?.querySelector('[data-funding-phase-badge]');
  const alertOk = modalEl?.querySelector('[data-funding-alert-success]');
  const alertErr = modalEl?.querySelector('[data-funding-alert-danger]');
  const btnSave = modalEl?.querySelector('[data-funding-save]');
  const btnAdvance = modalEl?.querySelector('[data-funding-advance]');
  const btnNew = tab.querySelector('[data-funding-new]');

  // Modal PDF (Dados do PDF)
  const pdfModalEl = document.getElementById('funding-pdf-modal');
  const pdfModalTitle = pdfModalEl?.querySelector('[data-funding-pdf-modal-title]');
  const pdfSaveBtn = pdfModalEl?.querySelector('[data-funding-pdf-save]');
  const pdfCancelBtns = pdfModalEl?.querySelectorAll('[data-funding-pdf-cancel]');
  const pdfAlertErr = pdfModalEl?.querySelector('[data-funding-pdf-alert-danger]');

  let pdfEditingIndex = null;

  const PHASE_LABEL = {
    planning: 'Em Planejamento',
    articulation: 'Em Articulação',
    formalization: 'Em Formalização',
    execution: 'Em Execução',
    archived: 'Arquivada'
  };

  const PHASE_ORDER = ['planning','articulation','formalization','execution'];

  // ---------- state (mock em memória) ----------
  let proposals = [
    {
      id: 1,
      title: 'Proposta 01',
      phase: 'planning',
      status: 'Rascunho',
      updatedAt: new Date().toISOString(),
      data: {
        // exemplo mínimo de preenchimento (pode ficar vazio)
        objetivo: 'Captação para apoiar entrega do projeto.'
      }
    }
  ];

  let editingId = null;
  let currentPhase = 'planning';
  let draftData = {};

  // ---------- helpers ----------
  function showAlert(type, msg) {
    if (!alertOk || !alertErr) return;
    alertOk.classList.add('d-none');
    alertErr.classList.add('d-none');
    const target = type === 'success' ? alertOk : alertErr;
    target.textContent = msg;
    target.classList.remove('d-none');
    window.setTimeout(() => target.classList.add('d-none'), 2500);
  }

  function fmtDate(iso) {
    try {
      const d = new Date(iso);
      return d.toLocaleString('pt-BR');
    } catch (e) {
      return iso || '-';
    }
  }

  function normalizeKey(label) {
    return String(label || '')
      .trim()
      .toLowerCase()
      .replace(/\s+/g, '_')
      .replace(/[^\w_]+/g, '');
  }

  function getFieldRules(field, phaseKey) {
    if (!field || field.kind !== 'field') return { req:'OPCIONAL', edit:'EDITÁVEL' };
    const rules = field[phaseKey] || { req:'OPCIONAL', edit:'EDITÁVEL' };
    return {
      req: String(rules.req || 'OPCIONAL').toUpperCase(),
      edit: String(rules.edit || 'EDITÁVEL').toUpperCase()
    };
  }

  function parseOptions(field) {
    const comp = String(field.component || '').toLowerCase();
    if (!comp.includes('lista')) return [];
    const txt = String(field.notes || '').trim();

    // heurística: se tiver uma lista curta separada por vírgula no começo, usa como opções
    const possible = txt
      .split(/\n|\.|\(|\)|\:/)[0]
      .split(/[,;|]/)
      .map(s => s.trim())
      .filter(Boolean);

    if (possible.length >= 2 && possible.length <= 20) {
      return possible;
    }

    // fallback mock
    return ['Opção 1','Opção 2','Opção 3'];
  }

  function getAnyActivePhaseProposal() {
    return proposals.find(p => p.phase !== 'planning' && p.phase !== 'archived');
  }

  function canAdvanceThisProposal(proposal) {
    // regra: quando uma entra em Articulação/Formalização/Execução, só pode existir 1 ativa
    const active = getAnyActivePhaseProposal();
    if (!active) return true;
    return active.id === proposal.id;
  }

  function archiveOtherPlanningProposals(keepId) {
    proposals = proposals.map(p => {
      if (p.id !== keepId && p.phase === 'planning') {
        return { ...p, phase: 'archived', status: 'Arquivada', updatedAt: new Date().toISOString() };
      }
      return p;
    });
  }

  function nextPhase(phase) {
    const idx = PHASE_ORDER.indexOf(phase);
    if (idx === -1) return phase;
    return PHASE_ORDER[Math.min(idx + 1, PHASE_ORDER.length - 1)];
  }

  function badgeClass(phase) {
    if (phase === 'planning') return 'badge-soft-secondary';
    if (phase === 'articulation') return 'badge-soft-primary';
    if (phase === 'formalization') return 'badge-soft-warning';
    if (phase === 'execution') return 'badge-soft-success';
    return 'badge-soft-dark';
  }

  function renderList() {
    if (!listEl) return;

    // ---- resumo (cards) ----
    const counts = { planning: 0, articulation: 0, formalization: 0, execution: 0, archived: 0 };
    proposals.forEach(p => {
      if (counts[p.phase] !== undefined) counts[p.phase] += 1;
    });
    Object.keys(counts).forEach(k => {
      if (phaseCards[k]) phaseCards[k].textContent = String(counts[k]);
    });

    // badges no header (espelho do layout de Riscos)
    if (badgePlanning) badgePlanning.textContent = `Planejamento: ${counts.planning}`;
    if (badgeArticulation) badgeArticulation.textContent = `Articulação: ${counts.articulation}`;
    if (badgeFormalization) badgeFormalization.textContent = `Formalização: ${counts.formalization}`;
    if (badgeExecution) badgeExecution.textContent = `Execução: ${counts.execution}`;
    if (badgeArchived) badgeArchived.textContent = `Arquivadas: ${counts.archived}`;

    // ---- filtros ----
    const q = (searchEl?.value || '').trim().toLowerCase();
    const status = (statusFilterEl?.value || 'all');

    const filtered = proposals.filter(p => {
      if (status !== 'all' && p.phase !== status) return false;
      if (!q) return true;
      return String(p.title || '').toLowerCase().includes(q) || String(p.id || '').includes(q);
    });

    const rows = filtered
      .slice()
      .sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt))
      .map(p => {
        return `
          <tr>
            <td>
              <div class="fw-semibold">${p.title}</div>
              <div class="text-muted small">ID: ${p.id}</div>
            </td>
            <td><span class="badge ${badgeClass(p.phase)} fs-xxs">${PHASE_LABEL[p.phase] || p.phase}</span></td>
            <td class="text-muted">${fmtDate(p.updatedAt)}</td>
            <td>${p.status || '-'}</td>
            <td>
              <div class="d-flex justify-content-center gap-1">
                <button type="button" class="btn btn-light btn-icon btn-sm rounded-circle" data-funding-edit="${p.id}" aria-label="Editar">
                  <i class="ti ti-edit fs-lg"></i>
                </button>
                <button type="button" class="btn btn-light btn-icon btn-sm rounded-circle" data-funding-archive="${p.id}" aria-label="Arquivar">
                  <i class="ti ti-archive fs-lg"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

    // render
    const hasResults = filtered.length > 0;

    if (listEl) listEl.innerHTML = hasResults ? rows : '';

    // empty state (espelho do layout de Riscos)
    if (emptyStateEl) emptyStateEl.classList.toggle('d-none', hasResults);
    if (tableWrapEl) tableWrapEl.classList.toggle('d-none', !hasResults);

    if (countEl) countEl.textContent = `Total: ${proposals.length}`;

    // bind actions
    listEl.querySelectorAll('[data-funding-edit]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.getAttribute('data-funding-edit'));
        openEdit(id);
      });
    });

    listEl.querySelectorAll('[data-funding-archive]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = Number(btn.getAttribute('data-funding-archive'));
        const p = proposals.find(x => x.id === id);
        if (!p) return;
        proposals = proposals.map(x => x.id === id ? { ...x, phase: 'archived', status: 'Arquivada', updatedAt: new Date().toISOString() } : x);
        renderList();
      });
    });
  }

  
  function ensurePdfState() {
    if (!draftData) draftData = {};
    if (!Array.isArray(draftData.__pdfs)) draftData.__pdfs = [];
  }

  function fillPdfModal(row) {
    if (!pdfModalEl) return;
    pdfModalEl.querySelector('[data-pdf-input="numero_pdf"]').value = row?.numero_pdf || '';
    pdfModalEl.querySelector('[data-pdf-input="data_empenho"]').value = row?.data_empenho || '';
    pdfModalEl.querySelector('[data-pdf-input="numero_empenho"]').value = row?.numero_empenho || '';
    pdfModalEl.querySelector('[data-pdf-input="valor_empenho"]').value = row?.valor_empenho || '';
    pdfModalEl.querySelector('[data-pdf-input="data_liquidacao"]').value = row?.data_liquidacao || '';
    pdfModalEl.querySelector('[data-pdf-input="valor_liquidacao"]').value = row?.valor_liquidacao || '';
    pdfModalEl.querySelector('[data-pdf-input="data_pagamento"]').value = row?.data_pagamento || '';
    pdfModalEl.querySelector('[data-pdf-input="valor_parcela_paga"]').value = row?.valor_parcela_paga || '';
    pdfModalEl.querySelector('[data-pdf-input="fonte"]').value = row?.fonte || '';
    // arquivo: apenas exibe nome salvo (por segurança o browser não preenche file input)
    const fileNameEl = pdfModalEl.querySelector('[data-pdf-file-name]');
    if (fileNameEl) fileNameEl.textContent = row?.arquivo_nome ? `Arquivo: ${row.arquivo_nome}` : '';
  }

  function readPdfModal() {
    if (!pdfModalEl) return null;
    const get = (k) => pdfModalEl.querySelector(`[data-pdf-input="${k}"]`)?.value?.trim?.() || '';
    const fileEl = pdfModalEl.querySelector('[data-pdf-file]');

    return {
      numero_pdf: get('numero_pdf'),
      data_empenho: get('data_empenho'),
      numero_empenho: get('numero_empenho'),
      valor_empenho: get('valor_empenho'),
      data_liquidacao: get('data_liquidacao'),
      valor_liquidacao: get('valor_liquidacao'),
      data_pagamento: get('data_pagamento'),
      valor_parcela_paga: get('valor_parcela_paga'),
      fonte: get('fonte'),
      arquivo_nome: fileEl?.files?.[0]?.name || ''
    };
  }

  function openPdfModal(editIndex = null) {
    if (!pdfModalEl) return;

    ensurePdfState();
    pdfEditingIndex = (typeof editIndex === 'number') ? editIndex : null;

    // title
    if (pdfModalTitle) {
      pdfModalTitle.textContent = pdfEditingIndex === null ? 'Adicionar PDF' : 'Editar PDF';
    }

    // reset alerts
    if (pdfAlertErr) pdfAlertErr.classList.add('d-none');

    const row = (pdfEditingIndex !== null) ? draftData.__pdfs[pdfEditingIndex] : null;
    fillPdfModal(row);

    const bs = bootstrap.Modal.getOrCreateInstance(pdfModalEl);
    bs.show();
  }

  function closePdfModal() {
    if (!pdfModalEl) return;
    const bs = bootstrap.Modal.getOrCreateInstance(pdfModalEl);
    bs.hide();
  }

  function showPdfError(msg) {
    if (!pdfAlertErr) return;
    pdfAlertErr.textContent = msg;
    pdfAlertErr.classList.remove('d-none');
  }

  // PDF modal events
  if (pdfSaveBtn) {
    pdfSaveBtn.addEventListener('click', () => {
      ensurePdfState();
      const row = readPdfModal();
      if (!row) return;

      // validação mínima
      if (!row.numero_pdf) return showPdfError('Informe o Número do PDF.');
      // se for novo, exige arquivo; se edição, pode manter sem re-upload
      const isNew = pdfEditingIndex === null;
      if (isNew && !row.arquivo_nome) return showPdfError('Selecione um arquivo PDF para anexar.');

      // se edição e não escolheu novo arquivo, preserva o nome anterior
      if (!isNew && !row.arquivo_nome) {
        row.arquivo_nome = draftData.__pdfs[pdfEditingIndex]?.arquivo_nome || '';
      }

      if (pdfEditingIndex === null) {
        draftData.__pdfs.push(row);
      } else {
        draftData.__pdfs[pdfEditingIndex] = row;
      }

      closePdfModal();
      renderForm();
    });
  }

  pdfCancelBtns?.forEach(btn => btn.addEventListener('click', closePdfModal));

  function renderForm() {
    if (!formEl || !modalEl) return;

    phaseBadge.textContent = PHASE_LABEL[currentPhase] || currentPhase;

    const html = window.__FUNDING_FIELDS__
      .map(f => {
        if (f.kind === 'section') {
          return `<div class="col-12"><h6 class="mt-2 mb-0">${f.label}</h6><hr class="mt-2"></div>`;
        }

        const rules = getFieldRules(f, currentPhase);

        // fase Arquivada: mostra tudo desabilitado (exceto BLOQUEADO na matriz)
        const isArchived = currentPhase === 'archived';

        if (rules.req === 'BLOQUEADO' && !isArchived) {
          return '';
        }

        const key = normalizeKey(f.label);
        const isRequired = rules.req === 'OBRIGATÓRIO' && !isArchived;
        const isEditable = (rules.edit !== 'BLOQUEADO') && !isArchived;

        const comp = String(f.component || 'Texto').toLowerCase();
        const notes = String(f.notes || '').trim();
        const value = (draftData[key] ?? '');

        const label = `
          <label class="form-label">
            ${f.label} ${isRequired ? '<span class="text-danger">*</span>' : ''}
          </label>
          ${notes ? `<div class="text-muted small mb-1">${notes}</div>` : ''}
        `;

        // checkbox
        if (comp.includes('checkbox')) {
          const checked = (value === true || value === 'true' || value === 'S');
          return `
            <div class="col-12 col-md-6">
              ${label}
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="${key}" data-funding-input="${key}" ${checked ? 'checked' : ''} ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
                <label class="form-check-label" for="${key}">Sim</label>
              </div>
            </div>
          `;
        }

        // textarea (casos "Texto" longos - usa regra simples pelas observações)
        const shouldBeTextarea = comp.includes('texto') && (notes.toLowerCase().includes('descrição') || notes.length > 60);

        // lista multi
        if (comp.includes('multi')) {
          const opts = parseOptions(f);
          const selected = Array.isArray(value) ? value : [];
          return `
            <div class="col-12 col-md-6">
              ${label}
              <select class="form-select" multiple data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
                ${opts.map(o => `<option value="${o}" ${selected.includes(o) ? 'selected' : ''}>${o}</option>`).join('')}
              </select>
            </div>
          `;
        }

        // lista simples
        if (comp.includes('lista')) {
          const opts = parseOptions(f);
          return `
            <div class="col-12 col-md-6">
              ${label}
              <select class="form-select" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
                <option value="">Selecione...</option>
                ${opts.map(o => `<option value="${o}" ${String(value) === o ? 'selected' : ''}>${o}</option>`).join('')}
              </select>
            </div>
          `;
        }

        // upload
        if (comp.includes('upload')) {
          return `
            <div class="col-12 col-md-6">
              ${label}
              <input class="form-control" type="file" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
              ${value ? `<div class="text-muted small mt-1">Arquivo selecionado: ${value}</div>` : ''}
            </div>
          `;
        }

        // data
        if (comp.includes('data')) {
          return `
            <div class="col-12 col-md-4">
              ${label}
              <input class="form-control" type="date" value="${value}" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
            </div>
          `;
        }

        // número/valor
        if (comp.includes('número') || comp.includes('valor') || comp.includes('decimal') || comp.includes('%')) {
          return `
            <div class="col-12 col-md-4">
              ${label}
              <input class="form-control" type="number" step="any" value="${value}" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>
            </div>
          `;
        }

        // grid (tabela) - usado em "Dados do PDF"
        if (comp.includes('grid')) {
          // regra específica: quando o label tem "PDF", renderiza como tabela + modal de anexos
          if (String(f.label || '').toUpperCase().includes('PDF')) {
            const pdfs = Array.isArray(draftData.__pdfs) ? draftData.__pdfs : [];
            return `
              <div class="col-12">
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div>
                    <div class="fw-semibold">${f.label}</div>
                    ${notes ? `<div class="text-muted small">${notes}</div>` : ''}
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" data-funding-add-pdf ${!isEditable ? 'disabled' : ''}>
                    <i class="ti ti-plus me-1"></i>Adicionar PDF
                  </button>
                </div>

                <div class="table-responsive border rounded">
                  <table class="table table-sm table-hover align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th style="width: 120px;">Nº PDF</th>
                        <th style="width: 130px;">Data empenho</th>
                        <th style="width: 130px;">Nº empenho</th>
                        <th style="width: 140px;">Valor empenho</th>
                        <th style="width: 140px;">Data liquidação</th>
                        <th style="width: 140px;">Valor liquidação</th>
                        <th style="width: 140px;">Data pagamento</th>
                        <th style="width: 160px;">Valor parcela paga</th>
                        <th style="width: 140px;">Fonte</th>
                        <th style="width: 120px;" class="text-end">Ações</th>
                      </tr>
                    </thead>
                    <tbody data-funding-pdf-rows>
                      ${pdfs.length ? pdfs.map((row, idx) => `
                        <tr>
                          <td>${row.numero_pdf || '-'}</td>
                          <td>${row.data_empenho || '-'}</td>
                          <td>${row.numero_empenho || '-'}</td>
                          <td>${row.valor_empenho || '-'}</td>
                          <td>${row.data_liquidacao || '-'}</td>
                          <td>${row.valor_liquidacao || '-'}</td>
                          <td>${row.data_pagamento || '-'}</td>
                          <td>${row.valor_parcela_paga || '-'}</td>
                          <td>${row.fonte || '-'}</td>
                          <td class="text-end">
                            <button type="button" class="btn btn-light btn-sm" data-funding-pdf-edit="${idx}" ${!isEditable ? 'disabled' : ''}>
                              <i class="ti ti-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-light btn-sm" data-funding-pdf-del="${idx}" ${!isEditable ? 'disabled' : ''}>
                              <i class="ti ti-trash"></i>
                            </button>
                          </td>
                        </tr>
                      `).join('') : `
                        <tr>
                          <td colspan="10" class="text-center text-muted py-4">
                            Nenhum PDF adicionado.
                          </td>
                        </tr>
                      `}
                    </tbody>
                  </table>
                </div>
              </div>
            `;
          }

          // fallback para outros grids: card simples
          return `
            <div class="col-12">
              <div class="border rounded p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="fw-semibold">${f.label}</div>
                    ${notes ? `<div class="text-muted small">${notes}</div>` : ''}
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" ${!isEditable ? 'disabled' : ''}>
                    <i class="ti ti-plus me-1"></i>Adicionar
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        // botão (card simples)
        if (comp.includes('botão')) {
          return `
            <div class="col-12">
              <div class="border rounded p-3">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="fw-semibold">${f.label}</div>
                    ${notes ? `<div class="text-muted small">${notes}</div>` : ''}
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" ${!isEditable ? 'disabled' : ''}>
                    <i class="ti ti-plus me-1"></i>Adicionar
                  </button>
                </div>
              </div>
            </div>
          `;
        }

        // texto padrão
        return `
          <div class="col-12 col-md-6">
            ${label}
            ${shouldBeTextarea
              ? `<textarea class="form-control" rows="3" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>${value}</textarea>`
              : `<input class="form-control" type="text" value="${value}" data-funding-input="${key}" ${!isEditable ? 'disabled' : ''} ${isRequired ? 'data-required="1"' : ''}>`
            }
          </div>
        `;
      })
      .filter(Boolean)
      .join('');

    formEl.innerHTML = html;

    // bind changes
    formEl.querySelectorAll('[data-funding-input]').forEach(el => {
      const key = el.getAttribute('data-funding-input');
      el.addEventListener('change', () => {
        if (el.tagName === 'SELECT' && el.multiple) {
          draftData[key] = Array.from(el.selectedOptions).map(o => o.value);
        } else if (el.type === 'checkbox') {
          draftData[key] = el.checked ? 'S' : 'N';
        } else if (el.type === 'file') {
          draftData[key] = el.files?.[0]?.name || '';
        } else {
          draftData[key] = el.value;
        }
      });
    });

    // bind PDF grid actions (Dados do PDF)
    const btnAddPdf = formEl.querySelector('[data-funding-add-pdf]');
    btnAddPdf?.addEventListener('click', () => openPdfModal());

    formEl.querySelectorAll('[data-funding-pdf-del]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-funding-pdf-del'));
        if (!Array.isArray(draftData.__pdfs)) draftData.__pdfs = [];
        draftData.__pdfs.splice(idx, 1);
        renderForm();
      });
    });

    formEl.querySelectorAll('[data-funding-pdf-edit]').forEach(btn => {
      btn.addEventListener('click', () => {
        const idx = Number(btn.getAttribute('data-funding-pdf-edit'));
        openPdfModal(idx);
      });
    });

  }

  function validateRequiredForPhase() {
    const requiredEls = formEl.querySelectorAll('[data-required="1"]');
    let ok = true;

    requiredEls.forEach(el => {
      const key = el.getAttribute('data-funding-input');

      if (el.tagName === 'SELECT' && el.multiple) {
        const val = draftData[key];
        const empty = !Array.isArray(val) || val.length === 0;
        el.classList.toggle('is-invalid', empty);
        if (empty) ok = false;
        return;
      }

      if (el.type === 'checkbox') {
        const val = draftData[key];
        const empty = !(val === 'S' || val === true || val === 'true');
        el.classList.toggle('is-invalid', empty);
        if (empty) ok = false;
        return;
      }

      const val = String(draftData[key] ?? '').trim();
      const empty = !val;
      el.classList.toggle('is-invalid', empty);
      if (empty) ok = false;
    });

    return ok;
  }

  function openNew() {
    editingId = null;
    currentPhase = 'planning';
    draftData = {};

    if (modalTitle) modalTitle.textContent = 'Nova proposta de captação';
    if (phaseSelect) phaseSelect.value = currentPhase;

    renderForm();
  }

  function openEdit(id) {
    const p = proposals.find(x => x.id === id);
    if (!p) return;

    editingId = id;
    currentPhase = p.phase;
    draftData = { ...(p.data || {}) };

    if (modalTitle) modalTitle.textContent = `Editar ${p.title}`;
    if (phaseSelect) phaseSelect.value = currentPhase;

    // impede edição/avanço quando arquivada
    renderForm();

    // abre modal via Bootstrap
    const instance = bootstrap.Modal.getOrCreateInstance(modalEl);
    instance.show();
  }

  function saveDraft() {
    // regra: só entra na lista quando salvar
    const now = new Date().toISOString();

    if (!editingId) {
      const nextId = proposals.reduce((acc,p) => Math.max(acc, p.id), 0) + 1;
      proposals.push({
        id: nextId,
        title: `Proposta ${String(nextId).padStart(2,'0')}`,
        phase: currentPhase,
        status: 'Rascunho',
        updatedAt: now,
        data: { ...draftData }
      });
      editingId = nextId;
      showAlert('success', 'Proposta salva com sucesso.');
    } else {
      proposals = proposals.map(p => p.id === editingId ? { ...p, phase: currentPhase, updatedAt: now, data: { ...draftData } } : p);
      showAlert('success', 'Proposta atualizada com sucesso.');
    }

    renderList();
  }

  function advancePhase() {
    if (!editingId) {
      showAlert('danger', 'Para avançar de fase, primeiro salve a proposta.');
      return;
    }

    const proposal = proposals.find(p => p.id === editingId);
    if (!proposal) return;

    if (proposal.phase === 'archived') {
      showAlert('danger', 'Propostas arquivadas não podem avançar de fase.');
      return;
    }

    if (!canAdvanceThisProposal(proposal)) {
      showAlert('danger', 'Já existe uma proposta ativa em Articulação/Formalização/Execução. Apenas uma pode seguir adiante.');
      return;
    }

    const ok = validateRequiredForPhase();
    if (!ok) {
      showAlert('danger', 'Preencha os campos obrigatórios da fase para avançar.');
      return;
    }

    const newPhase = nextPhase(currentPhase);
    if (newPhase === currentPhase) {
      showAlert('success', 'Proposta já está na última fase.');
      return;
    }

    currentPhase = newPhase;
    if (phaseSelect) phaseSelect.value = currentPhase;

    // quando entra em Articulação, arquiva as outras de Planejamento
    if (currentPhase === 'articulation') {
      archiveOtherPlanningProposals(proposal.id);
    }

    // atualiza estado da proposta
    proposals = proposals.map(p => p.id === proposal.id ? {
      ...p,
      phase: currentPhase,
      status: 'Em andamento',
      updatedAt: new Date().toISOString(),
      data: { ...draftData }
    } : p);

    renderList();
    renderForm();
    showAlert('success', `Proposta avançou para "${PHASE_LABEL[currentPhase]}".`);
  }

  // ---------- events ----------
  btnNew?.addEventListener('click', () => {
    openNew();
  });

  phaseSelect?.addEventListener('change', () => {
    // fase no select serve para visualizar o que libera/bloqueia na UI
    // porém, regra: se existe proposta ativa além do planejamento, não deixa outro item "forçar" Articulação via select.
    currentPhase = phaseSelect.value;
    renderForm();
  });

  btnSave?.addEventListener('click', () => {
    saveDraft();
  });

  btnAdvance?.addEventListener('click', () => {
    advancePhase();
  });

  modalEl?.addEventListener('hidden.bs.modal', () => {
    // limpa alerts visuais
    alertOk?.classList.add('d-none');
    alertErr?.classList.add('d-none');
  });


  // filtros (espelho do padrão de Riscos)
  applyBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    renderList();
  });

  clearBtn?.addEventListener('click', (e) => {
    e.preventDefault();
    if (searchEl) searchEl.value = '';
    if (statusFilterEl) statusFilterEl.value = 'all';
    renderList();
  });

  // busca com debounce leve
  searchEl?.addEventListener('input', () => {
    clearTimeout(searchEl._t);
    searchEl._t = setTimeout(renderList, 150);
  });

  statusFilterEl?.addEventListener('change', () => {
    renderList();
  });

  renderList();
});
</script>


<!-- Modal PDF - Captação de Recursos -->
<div class="modal fade" id="funding-pdf-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title mb-0" data-funding-pdf-modal-title>Adicionar PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <div class="alert alert-danger d-none" role="alert" data-funding-pdf-alert-danger></div>

        <div class="row g-3">
          <div class="col-12 col-md-4">
            <label class="form-label">Número do PDF <span class="text-danger">*</span></label>
            <input type="text" class="form-control" data-pdf-input="numero_pdf" placeholder="Ex: 12345">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Data do empenho</label>
            <input type="date" class="form-control" data-pdf-input="data_empenho">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Número do empenho</label>
            <input type="text" class="form-control" data-pdf-input="numero_empenho">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Valor do empenho</label>
            <input type="number" step="any" class="form-control" data-pdf-input="valor_empenho">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Data da liquidação</label>
            <input type="date" class="form-control" data-pdf-input="data_liquidacao">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Valor da liquidação</label>
            <input type="number" step="any" class="form-control" data-pdf-input="valor_liquidacao">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Data do pagamento</label>
            <input type="date" class="form-control" data-pdf-input="data_pagamento">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Valor da parcela paga</label>
            <input type="number" step="any" class="form-control" data-pdf-input="valor_parcela_paga">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label">Fonte</label>
            <input type="text" class="form-control" data-pdf-input="fonte" placeholder="Ex: AFT / Siofi">
          </div>

          <div class="col-12">
            <label class="form-label">Arquivo PDF</label>
            <input type="file" class="form-control" accept="application/pdf" data-pdf-file>
            <div class="text-muted small mt-1" data-pdf-file-name></div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-light" data-funding-pdf-cancel>Cancelar</button>
        <button type="button" class="btn btn-primary" data-funding-pdf-save>
          <i class="ti ti-device-floppy me-1"></i>Salvar PDF
        </button>
      </div>
    </div>
  </div>
</div>


</body>
</html>
